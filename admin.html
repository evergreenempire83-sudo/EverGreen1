<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EverGreen Empire — Admin Control Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #7c3aed;
            --secondary: #6d28d9;
            --background: #faf5ff;
            --surface: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }

        .theme-dark {
            --primary: #8b5cf6;
            --secondary: #7c3aed;
            --background: #1e1b2e;
            --surface: #2d2a42;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #374151;
        }

        body {
            background-color: var(--background);
            color: var(--text);
            transition: all 0.3s ease;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse-glow {
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(124, 58, 237, 0.5); }
            50% { box-shadow: 0 0 20px rgba(124, 58, 237, 0.8); }
        }

        .online-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .message-ceo {
            background: linear-gradient(135deg, #1e40af, #3730a3);
            color: white;
            border-radius: 12px;
            padding: 12px;
            margin: 8px 0;
        }

        .message-cfo {
            background: linear-gradient(135deg, #059669, #047857);
            color: white;
            border-radius: 12px;
            padding: 12px;
            margin: 8px 0;
        }

        .message-admin {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
            color: white;
            border-radius: 12px;
            padding: 12px;
            margin: 8px 0;
        }

        .message-system {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            border-radius: 12px;
            padding: 12px;
            margin: 8px 0;
        }

        .greeting-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .drag-over {
            border: 2px dashed #7c3aed !important;
            background: linear-gradient(135deg, #faf5ff, #f3e8ff) !important;
        }

        .celebration {
            animation: celebration 2s ease-out;
        }

        @keyframes celebration {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #ff0000;
            opacity: 0;
            z-index: 1000;
        }

        .achievement-badge {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 12px;
            font-weight: bold;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-purple-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <div class="text-xl font-semibold text-gray-800">Admin Control Center</div>
            <div class="text-sm text-gray-600 mt-2" id="loadingStatus">Initializing advanced admin tools...</div>
        </div>
    </div>

    <!-- Security Check Modal -->
    <div id="securityModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 m-3 max-w-md w-full">
            <div class="text-center">
                <i class="fas fa-shield-alt text-4xl text-red-500 mb-4"></i>
                <h3 class="text-lg font-bold mb-2">Authentication Required</h3>
                <p class="text-gray-600 mb-4">Please log in to access the Admin Control Center</p>
                <button onclick="redirectToLogin()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                    Go to Login
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
        <!-- Header -->
        <header class="bg-purple-800 text-white p-4 sticky top-0 z-40 shadow-lg">
            <div class="max-w-7xl mx-auto flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-lg bg-white/20 flex items-center justify-center">
                        <i class="fas fa-cogs"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">EverGreen Empire</h1>
                        <p class="text-sm opacity-90">Admin Control Center <span id="connectionStatus" class="online-dot"></span> <span id="syncStatus" class="text-xs">System Admin</span></p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="achievement-badge hidden" id="achievementBadge">
                        <i class="fas fa-trophy mr-1"></i>Super Admin
                    </div>
                    <button onclick="toggleTheme()" class="p-2 rounded-lg bg-white/10 hover:bg-white/20">
                        <i class="fas fa-palette"></i>
                    </button>
                    <button onclick="signOut()" class="bg-red-600 px-4 py-2 rounded-lg hover:bg-red-700 flex items-center">
                        <i class="fas fa-sign-out-alt mr-2"></i>Sign Out
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto p-4">
            <!-- Greeting Banner -->
            <div class="greeting-banner rounded-lg p-6 mb-6 text-white shadow-lg celebration" id="greetingBanner">
                <div class="flex flex-col md:flex-row md:items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold mb-2" id="greetingMessage">Good morning, Admin!</h2>
                        <p class="text-purple-100" id="greetingSubtext">Ready to manage today's brand performance?</p>
                        <div class="flex items-center mt-2 space-x-2" id="greetingStats">
                            <span class="text-xs bg-white/20 px-2 py-1 rounded-full">🎯 5 Brands Active</span>
                            <span class="text-xs bg-white/20 px-2 py-1 rounded-full">💰 $84.60 Revenue</span>
                            <span class="text-xs bg-white/20 px-2 py-1 rounded-full">🚀 All Systems Go</span>
                        </div>
                    </div>
                    <div class="mt-4 md:mt-0 flex items-center space-x-3">
                        <div class="text-right">
                            <div class="text-xs text-purple-200">System Status</div>
                            <div class="text-sm font-bold" id="portalStatus">All Systems Operational</div>
                        </div>
                        <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center pulse-glow">
                            <i class="fas fa-shield-alt text-white text-lg"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Executive Network Status -->
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
                <div class="card rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="online-dot"></span>
                            <span class="font-semibold">CEO</span>
                        </div>
                        <span class="text-green-600 text-xs font-semibold">Online</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">Active in Portal</div>
                </div>
                <div class="card rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="online-dot"></span>
                            <span class="font-semibold">CFO</span>
                        </div>
                        <span class="text-green-600 text-xs font-semibold">Online</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">Viewing Reports</div>
                </div>
                <div class="card rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="w-2 h-2 bg-gray-400 rounded-full mr-2"></span>
                            <span class="font-semibold">COO</span>
                        </div>
                        <span class="text-red-600 text-xs font-semibold">Offline</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">Last seen 2h ago</div>
                </div>
                <div class="card rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="w-2 h-2 bg-yellow-400 rounded-full mr-2"></span>
                            <span class="font-semibold">CTO</span>
                        </div>
                        <span class="text-yellow-600 text-xs font-semibold">Away</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">In meeting</div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="card rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <h3 class="text-base font-bold">Total Brands</h3>
                        <i class="fas fa-tags text-purple-500"></i>
                    </div>
                    <div class="text-2xl font-bold mt-2" id="totalBrands">0</div>
                    <div class="text-xs text-gray-500">Active in system</div>
                </div>
                <div class="card rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <h3 class="text-base font-bold">Total Revenue</h3>
                        <i class="fas fa-dollar-sign text-green-500"></i>
                    </div>
                    <div class="text-2xl font-bold mt-2" id="totalRevenue">$0</div>
                    <div class="text-xs text-gray-500">28-day estimate</div>
                </div>
                <div class="card rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <h3 class="text-base font-bold">Messages</h3>
                        <i class="fas fa-comments text-blue-500"></i>
                    </div>
                    <div class="text-2xl font-bold mt-2" id="totalMessages">0</div>
                    <div class="text-xs text-gray-500">Executive comms</div>
                </div>
                <div class="card rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <h3 class="text-base font-bold">Sync Status</h3>
                        <i class="fas fa-sync text-orange-500"></i>
                    </div>
                    <div class="text-2xl font-bold mt-2" id="syncCount">0</div>
                    <div class="text-xs text-gray-500">Real-time updates</div>
                </div>
            </div>

            <!-- Brand Management & Communications -->
            <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-6">
                <!-- Brand Management -->
                <div class="card rounded-lg p-4 xl:col-span-2">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold">Brand Performance Management</h3>
                        <div class="flex space-x-2">
                            <button onclick="showBulkUpload()" class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 text-sm">
                                <i class="fas fa-upload mr-1"></i>Bulk Upload
                            </button>
                            <button onclick="showAddBrandForm()" class="bg-purple-600 text-white px-3 py-2 rounded-lg hover:bg-purple-700 text-sm">
                                <i class="fas fa-plus mr-1"></i>Add Brand
                            </button>
                        </div>
                    </div>

                    <!-- Add Brand Form -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-4 border">
                        <h4 class="font-semibold mb-3">Add New Brand</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <input type="text" id="brandName" placeholder="Brand Name" class="p-2 border rounded text-sm">
                            <input type="number" id="views28d" placeholder="28D Views" class="p-2 border rounded text-sm" value="0">
                            <button onclick="addBrand()" class="bg-purple-600 text-white p-2 rounded hover:bg-purple-700 text-sm">
                                <i class="fas fa-plus mr-1"></i>Add Brand
                            </button>
                        </div>
                        <div class="text-xs text-gray-500 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>Revenue calculated at $0.12 RPM
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b">
                                    <th class="text-left py-3 px-2 font-semibold">Brand</th>
                                    <th class="text-right py-3 px-2 font-semibold">28D Views</th>
                                    <th class="text-right py-3 px-2 font-semibold">Est. Revenue</th>
                                    <th class="text-center py-3 px-2 font-semibold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="brandsTableBody">
                                <!-- Brands will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Executive Communications -->
                <div class="space-y-6">
                    <!-- Real-time Communications -->
                    <div class="card rounded-lg p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold">Executive Communications</h3>
                            <span class="text-xs text-green-600 bg-green-100 px-2 py-1 rounded-full">Live</span>
                        </div>
                        <div class="space-y-4">
                            <div class="flex flex-col space-y-2">
                                <input type="text" id="messageInput" placeholder="Type your message to executives..." class="w-full p-3 border rounded-lg">
                                <select id="recipientSelect" class="w-full p-3 border rounded-lg">
                                    <option value="all">All Executives</option>
                                    <option value="ceo">CEO Only</option>
                                    <option value="cfo">CFO Only</option>
                                </select>
                                <button onclick="sendMessage()" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700">
                                    <i class="fas fa-paper-plane mr-2"></i>Send Message
                                </button>
                            </div>
                            <div id="messagesContainer" class="max-h-64 overflow-y-auto space-y-2 border rounded-lg p-3">
                                <!-- Messages will appear here -->
                            </div>
                        </div>
                    </div>

                    <!-- Performance Chart -->
                    <div class="card rounded-lg p-4">
                        <h3 class="text-lg font-bold mb-4">Brand Performance</h3>
                        <canvas id="performanceChart" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- Analytics Dashboard -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Revenue Analytics -->
                <div class="card rounded-lg p-4">
                    <h3 class="text-lg font-bold mb-4">Revenue Analytics</h3>
                    <canvas id="revenueChart" height="250"></canvas>
                </div>

                <!-- System Activity -->
                <div class="card rounded-lg p-4">
                    <h3 class="text-lg font-bold mb-4">System Activity</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-3"></i>
                                <span class="font-semibold">CFO Portal</span>
                            </div>
                            <span class="text-green-600 text-sm">Synced</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-sync-alt text-blue-500 mr-3"></i>
                                <span class="font-semibold">Real-time Updates</span>
                            </div>
                            <span class="text-blue-600 text-sm">Active</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-robot text-purple-500 mr-3"></i>
                                <span class="font-semibold">AI Analytics</span>
                            </div>
                            <span class="text-purple-600 text-sm">Ready</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Bulk Upload Modal -->
    <div id="bulkUploadModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 m-3 max-w-md w-full">
            <h3 class="text-lg font-bold mb-4">Bulk Upload CSV</h3>
            <div class="space-y-4">
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center" 
                     id="dropZone" 
                     ondrop="handleDrop(event)" 
                     ondragover="handleDragOver(event)">
                    <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                    <div class="text-sm text-gray-600">Drop CSV file here or click to browse</div>
                    <input type="file" id="csvFile" accept=".csv" class="hidden" onchange="handleFileSelect(event)">
                    <button onclick="document.getElementById('csvFile').click()" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm">
                        Browse Files
                    </button>
                </div>
                <div class="text-xs text-gray-500">
                    Expected columns: name, views_28d
                </div>
                <div class="flex space-x-2">
                    <button onclick="processCSVUpload()" class="flex-1 bg-green-600 text-white py-2 rounded hover:bg-green-700">Upload</button>
                    <button onclick="closeModal('bulkUploadModal')" class="flex-1 bg-gray-600 text-white py-2 rounded hover:bg-gray-700">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://clhaquwjevqdzjobthdz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsaGFxdXdqZXZxZHpqb2J0aGR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwNjYxODMsImV4cCI6MjA3NjY0MjE4M30.Ns2raXXMNPAveuogHrcRsTgazQrpTTnzr6ZeURc3pv0';
        
        // Initialize Supabase
        let supabase;
        let realtimeChannels = [];
        let performanceChart, revenueChart;

        // Global State
        let state = {
            brands: [],
            messages: [],
            statistics: {
                syncCount: 0,
                totalRevenue: 0
            },
            user: null
        };

        // 🎊 AUTO GREETINGS SYSTEM
        const greetings = {
            morning: [
                "Rise and shine, {name}! 🌅 Ready to conquer the day?",
                "Good morning, {name}! The brands are waiting for your magic touch! ✨",
                "Morning, {name}! Let's make today legendary! 🚀",
                "Hello {name}! The empire awaits your command! 👑"
            ],
            afternoon: [
                "Good afternoon, {name}! How are our brands performing? 📊",
                "Afternoon, {name}! Time to check those revenue numbers! 💰",
                "Hello {name}! Hope you're having a productive day! 🎯",
                "{name}! Perfect time for a brand performance review! 📈"
            ],
            evening: [
                "Good evening, {name}! Wrapping up a great day? 🌇",
                "Evening, {name}! The brands never sleep, and neither do legends! 🌙",
                "Hello {name}! Making moves while others rest? 💪",
                "{name}! Evening is when empires are built! 🏗️"
            ],
            night: [
                "Working late, {name}? That's why you're the best! 🌃",
                "Good night shift, {name}! The empire appreciates your dedication! 🌌",
                "{name}! Burning the midnight oil for greatness? 🔥",
                "Late night session, {name}! This is where legends are made! ⭐"
            ],
            achievements: [
                "Wow {name}! You've managed {brands} brands generating ${revenue}! 🎉",
                "Incredible work {name}! ${revenue} revenue from {brands} brands! 💎",
                "{name}, you're crushing it! {brands} brands under your command! 👑",
                "Amazing {name}! The empire is thriving with your leadership! 🚀"
            ]
        };

        // 🚀 Initialize Application
        async function init() {
            console.log('🚀 Initializing Admin Control Center...');
            updateLoadingStatus('Checking authentication...');

            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // Check authentication first
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error || !session) {
                    showSecurityModal();
                    return;
                }

                state.user = {
                    email: session.user.email,
                    role: detectRole(session.user.email),
                    name: session.user.email.split('@')[0]
                };

                console.log('✅ User authenticated:', state.user);
                updateLoadingStatus('Connecting to executive network...');

                await setupRealtimeConnections();
                await loadInitialData();
                
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                
                setupAutoGreeting();
                initializeCharts();
                checkAchievements();
                
                showNotification(`Welcome back, ${state.user.name}! Admin Control Center activated! 🎯`, 'success');
                
            } catch (error) {
                console.error('❌ Initialization failed:', error);
                showSecurityModal();
            }
        }

        // 🎯 Enhanced Auto Greeting System
        function setupAutoGreeting() {
            const now = new Date();
            const hour = now.getHours();
            let timeOfDay = 'morning';
            
            if (hour >= 12 && hour < 17) timeOfDay = 'afternoon';
            else if (hour >= 17 && hour < 21) timeOfDay = 'evening';
            else if (hour >= 21 || hour < 5) timeOfDay = 'night';

            const greetingPool = greetings[timeOfDay];
            const randomGreeting = greetingPool[Math.floor(Math.random() * greetingPool.length)];
            
            const brandCount = state.brands.length;
            const totalRevenue = state.statistics.totalRevenue;
            
            // Use achievement greeting if we have good numbers
            let finalGreeting = randomGreeting;
            if (brandCount >= 3 && totalRevenue >= 50) {
                const achievementGreeting = greetings.achievements[Math.floor(Math.random() * greetings.achievements.length)];
                finalGreeting = achievementGreeting
                    .replace('{brands}', brandCount)
                    .replace('{revenue}', totalRevenue.toFixed(2));
            }
            
            const greetingMessage = finalGreeting
                .replace('{name}', state.user.name)
                .replace('{brands}', brandCount)
                .replace('{revenue}', totalRevenue.toFixed(2));

            document.getElementById('greetingMessage').textContent = greetingMessage;
            
            // Update greeting stats
            const statsHTML = `
                <span class="text-xs bg-white/20 px-2 py-1 rounded-full">🎯 ${brandCount} Brands Active</span>
                <span class="text-xs bg-white/20 px-2 py-1 rounded-full">💰 $${totalRevenue.toFixed(2)} Revenue</span>
                <span class="text-xs bg-white/20 px-2 py-1 rounded-full">🚀 ${getPerformanceStatus()}</span>
            `;
            document.getElementById('greetingStats').innerHTML = statsHTML;

            // Add celebration effect for great performance
            if (totalRevenue > 100) {
                createConfetti();
                document.getElementById('greetingBanner').classList.add('celebration');
            }
        }

        function getPerformanceStatus() {
            const revenue = state.statistics.totalRevenue;
            if (revenue > 100) return 'Elite Performance';
            if (revenue > 50) return 'Strong Results';
            if (revenue > 20) return 'Growing Steady';
            return 'Building Momentum';
        }

        function createConfetti() {
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.background = `hsl(${Math.random() * 360}, 100%, 50%)`;
                confetti.style.animation = `confettiFall ${Math.random() * 3 + 2}s linear forwards`;
                document.body.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 5000);
            }
        }

        function checkAchievements() {
            const brandCount = state.brands.length;
            const revenue = state.statistics.totalRevenue;
            
            if (brandCount >= 5 || revenue >= 100) {
                document.getElementById('achievementBadge').classList.remove('hidden');
                showNotification('🏆 Achievement Unlocked: Super Admin!', 'success');
            }
        }

        // 🔐 SECURITY FUNCTIONS
        function showSecurityModal() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('securityModal').classList.remove('hidden');
        }

        function redirectToLogin() {
            window.location.href = 'index.html';
        }

        function detectRole(email) {
            if (email.includes('ceo@')) return 'ceo';
            if (email.includes('cfo@')) return 'cfo';
            if (email.includes('admin@')) return 'admin';
            return 'user';
        }

        // 🔄 Real-time Connections
        async function setupRealtimeConnections() {
            if (!supabase) return;

            try {
                // Real-time messages
                const messagesChannel = supabase
                    .channel('admin-messages')
                    .on('postgres_changes', 
                        { event: 'INSERT', schema: 'public', table: 'messages' }, 
                        (payload) => {
                            console.log('💬 New message:', payload.new);
                            if (payload.new.sender !== 'Admin') {
                                state.messages.unshift(payload.new);
                                updateMessages();
                                playNotificationSound();
                                
                                if (payload.new.sender === 'CEO' || payload.new.sender === 'CFO') {
                                    showNotification(`New message from ${payload.new.sender}`, 'info');
                                }
                            }
                        }
                    )
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            document.getElementById('connectionStatus').style.background = '#10b981';
                            document.getElementById('syncStatus').textContent = 'Live Sync Active';
                        }
                    });

                realtimeChannels.push(messagesChannel);

                // Real-time brands data
                const brandsChannel = supabase
                    .channel('admin-brands')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'brands' }, 
                        async (payload) => {
                            console.log('🔄 Brands data updated:', payload);
                            await loadBrandsData();
                            state.statistics.syncCount++;
                            updateStatistics();
                            
                            if (payload.eventType === 'INSERT') {
                                await notifyExecutives('new_brand', payload.new);
                            } else if (payload.eventType === 'UPDATE') {
                                await notifyExecutives('update_brand', payload.new);
                            }
                        }
                    )
                    .subscribe();

                realtimeChannels.push(brandsChannel);

            } catch (error) {
                console.error('❌ Real-time setup failed:', error);
            }
        }

        // 📊 Data Management
        async function loadInitialData() {
            await loadBrandsData();
            await loadMessages();
            updateStatistics();
        }

        async function loadBrandsData() {
            try {
                const { data: brands, error } = await supabase
                    .from('brands')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                
                state.brands = brands || [];
                updateBrandsTable();
                updateCharts();
                
                console.log(`✅ Loaded ${state.brands.length} brands`);

            } catch (error) {
                console.error('❌ Error loading brands:', error);
                if (state.brands.length === 0) {
                    loadDemoBrands();
                }
            }
        }

        async function loadMessages() {
            try {
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) throw error;
                state.messages = messages || [];
                updateMessages();
                
            } catch (error) {
                console.error('❌ Error loading messages:', error);
                loadDemoMessages();
            }
        }

        // ➕ Add Brand Function
        async function addBrand() {
            const name = document.getElementById('brandName').value.trim();
            const views28d = parseInt(document.getElementById('views28d').value) || 0;

            if (!name) {
                showNotification('Please enter a brand name', 'error');
                return;
            }

            try {
                const revenue = (views28d / 1000) * 0.12;
                
                const brandData = {
                    name: name,
                    views_28d: views28d,
                    revenue: revenue,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };

                console.log('📦 Adding brand:', brandData);
                
                const { data, error } = await supabase
                    .from('brands')
                    .insert([brandData])
                    .select();

                if (error) {
                    console.error('❌ Supabase error:', error);
                    throw new Error(`Failed to add brand: ${error.message}`);
                }

                document.getElementById('brandName').value = '';
                document.getElementById('views28d').value = '0';
                
                console.log('✅ Brand added successfully:', data);
                showNotification(`Brand "${name}" added successfully! 🎉`, 'success');
                
                await notifyExecutives('new_brand', data[0]);

            } catch (error) {
                console.error('❌ Failed to add brand:', error);
                showNotification(error.message, 'error');
            }
        }

        // ✏️ Update Brand
        async function updateBrand(brandId, updates) {
            try {
                if (updates.views_28d !== undefined) {
                    updates.revenue = (updates.views_28d / 1000) * 0.12;
                }
                updates.updated_at = new Date().toISOString();

                const { data, error } = await supabase
                    .from('brands')
                    .update(updates)
                    .eq('id', brandId)
                    .select();

                if (error) throw error;

                showNotification('Brand updated successfully! ✨', 'success');
                await notifyExecutives('update_brand', data[0]);

            } catch (error) {
                console.error('❌ Error updating brand:', error);
                showNotification('Failed to update brand', 'error');
            }
        }

        // 🗑️ Delete Brand
        async function deleteBrand(brandId, brandName) {
            if (!confirm(`Are you sure you want to delete "${brandName}"?`)) return;

            try {
                const { error } = await supabase
                    .from('brands')
                    .delete()
                    .eq('id', brandId);

                if (error) throw error;
                
                showNotification(`Brand "${brandName}" deleted successfully! 🗑️`, 'success');
                await notifyExecutives('delete_brand', { name: brandName });

            } catch (error) {
                console.error('❌ Error deleting brand:', error);
                showNotification('Failed to delete brand', 'error');
            }
        }

        // 💬 Notify Executives
        async function notifyExecutives(action, brandData) {
            let message = '';
            
            switch (action) {
                case 'new_brand':
                    message = `📊 New brand "${brandData.name}" added with ${brandData.views_28d.toLocaleString()} views (Est. revenue: ${formatCurrency((brandData.views_28d / 1000) * 0.12)})`;
                    break;
                case 'update_brand':
                    message = `🔄 Brand "${brandData.name}" updated - ${brandData.views_28d.toLocaleString()} views (Est. revenue: ${formatCurrency((brandData.views_28d / 1000) * 0.12)})`;
                    break;
                case 'delete_brand':
                    message = `🗑️ Brand "${brandData.name}" removed from system`;
                    break;
            }

            const messageData = {
                sender: 'System',
                receiver: 'all',
                message: message,
                created_at: new Date().toISOString()
            };

            try {
                await supabase.from('messages').insert([messageData]);
                console.log('✅ Executive notification sent:', message);
            } catch (error) {
                console.error('❌ Failed to send notification:', error);
            }
        }

        // 📊 Update Brands Table
        function updateBrandsTable() {
            const tbody = document.getElementById('brandsTableBody');
            const totalBrands = document.getElementById('totalBrands');
            const totalRevenue = document.getElementById('totalRevenue');
            
            if (!state.brands.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-3xl mb-2"></i>
                            <div>No brands added yet</div>
                            <div class="text-sm mt-1">Add your first brand above</div>
                        </td>
                    </tr>
                `;
                totalBrands.textContent = '0';
                totalRevenue.textContent = '$0';
                return;
            }

            const totalBrandsCount = state.brands.length;
            const totalRevenueValue = state.brands.reduce((sum, brand) => sum + ((brand.views_28d || 0) / 1000) * 0.12, 0);
            
            totalBrands.textContent = totalBrandsCount;
            totalRevenue.textContent = formatCurrency(totalRevenueValue);
            state.statistics.totalRevenue = totalRevenueValue;

            tbody.innerHTML = state.brands.map(brand => {
                const revenue = (brand.views_28d / 1000) * 0.12;
                
                return `
                <tr class="border-b hover:bg-gray-50 fade-in">
                    <td class="py-3 px-2">
                        <div class="font-semibold">${brand.name}</div>
                    </td>
                    <td class="py-3 px-2 text-right">
                        <input type="number" 
                               value="${brand.views_28d}" 
                               class="w-24 p-2 border rounded text-right text-sm"
                               onchange="updateBrand('${brand.id}', { views_28d: parseInt(this.value) || 0 })">
                    </td>
                    <td class="py-3 px-2 text-right font-semibold text-green-600">
                        ${formatCurrency(revenue)}
                    </td>
                    <td class="py-3 px-2 text-center">
                        <button onclick="deleteBrand('${brand.id}', '${brand.name}')" 
                                class="text-red-600 hover:text-red-800 p-2">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        // 💬 Messaging System
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            const recipient = document.getElementById('recipientSelect').value;

            if (!message) {
                showNotification('Please enter a message', 'error');
                return;
            }

            const messageData = {
                sender: 'Admin',
                receiver: recipient,
                message: message,
                created_at: new Date().toISOString()
            };

            state.messages.unshift(messageData);
            updateMessages();
            messageInput.value = '';

            try {
                const { error } = await supabase.from('messages').insert([messageData]);
                if (error) throw error;
                showNotification('Message sent to executives! 📤', 'success');
            } catch (error) {
                console.error('❌ Failed to save message:', error);
                showNotification('Message sent locally', 'warning');
            }
        }

        function updateMessages() {
            const container = document.getElementById('messagesContainer');
            const totalMessages = document.getElementById('totalMessages');
            
            if (!state.messages.length) {
                container.innerHTML = '<div class="text-center text-gray-500 text-sm py-4">No messages yet</div>';
                totalMessages.textContent = '0';
                return;
            }

            container.innerHTML = state.messages.map(msg => {
                let messageClass = 'message-admin';
                if (msg.sender === 'CEO') messageClass = 'message-ceo';
                if (msg.sender === 'CFO') messageClass = 'message-cfo';
                if (msg.sender === 'System') messageClass = 'message-system';
                
                return `
                <div class="${messageClass} fade-in">
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-semibold text-sm">${msg.sender}</span>
                        <span class="text-xs opacity-80">${formatTime(msg.created_at)}</span>
                    </div>
                    <div class="text-sm">${msg.message}</div>
                    ${msg.receiver !== 'all' ? `<div class="text-xs opacity-80 mt-1">To: ${msg.receiver}</div>` : ''}
                </div>
                `;
            }).join('');

            totalMessages.textContent = state.messages.length;
            container.scrollTop = container.scrollHeight;
        }

        // 📈 Charts
        function initializeCharts() {
            const perfCtx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(perfCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: '28D Views',
                        data: [],
                        backgroundColor: '#7c3aed',
                        borderColor: '#6d28d9',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            const revCtx = document.getElementById('revenueChart').getContext('2d');
            revenueChart = new Chart(revCtx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Estimated Revenue',
                        data: [0, 0, 0, 0, 0, 0, 0],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }

        function updateCharts() {
            if (!performanceChart || !revenueChart) return;

            const topBrands = state.brands.slice(0, 5);
            performanceChart.data.labels = topBrands.map(brand => brand.name);
            performanceChart.data.datasets[0].data = topBrands.map(brand => brand.views_28d);
            performanceChart.update();

            const revenueData = Array.from({length: 7}, (_, i) => 
                Math.random() * state.statistics.totalRevenue * 0.3 + state.statistics.totalRevenue * 0.7
            );
            revenueChart.data.datasets[0].data = revenueData;
            revenueChart.update();
        }

        // 📤 Bulk Upload
        function showBulkUpload() {
            document.getElementById('bulkUploadModal').classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                handleCSVFile(files[0]);
            }
        }

        function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length > 0) {
                handleCSVFile(files[0]);
            }
        }

        function handleCSVFile(file) {
            Papa.parse(file, {
                header: true,
                complete: function(results) {
                    console.log('CSV parsed:', results);
                    window.csvData = results.data;
                    showNotification(`CSV loaded with ${results.data.length} rows 📁`, 'success');
                },
                error: function(error) {
                    console.error('CSV parse error:', error);
                    showNotification('Error parsing CSV file', 'error');
                }
            });
        }

        async function processCSVUpload() {
            if (!window.csvData || window.csvData.length === 0) {
                showNotification('Please select a CSV file first', 'error');
                return;
            }
            
            const brands = window.csvData
                .filter(row => row.name && row.name.trim() !== '')
                .map(row => ({
                    name: row.name.trim(),
                    views_28d: parseInt(row.views_28d) || 0,
                    revenue: (parseInt(row.views_28d) || 0) / 1000 * 0.12,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                }));
            
            if (brands.length === 0) {
                showNotification('No valid data found in CSV', 'error');
                return;
            }
            
            try {
                let successCount = 0;
                let errorCount = 0;
                
                for (const brand of brands) {
                    try {
                        const { error } = await supabase
                            .from('brands')
                            .insert([brand]);
                            
                        if (error) throw error;
                        successCount++;
                    } catch (error) {
                        console.error(`Failed to add brand ${brand.name}:`, error);
                        errorCount++;
                    }
                }
                
                closeModal('bulkUploadModal');
                document.getElementById('csvFile').value = '';
                delete window.csvData;
                
                if (successCount > 0) {
                    showNotification(`${successCount} brands uploaded successfully! 🎉`, 'success');
                    await notifyExecutives('bulk_upload', { count: successCount });
                }
                if (errorCount > 0) {
                    showNotification(`${errorCount} brands failed to upload`, 'error');
                }
                
            } catch (error) {
                console.error('Error uploading brands:', error);
                showNotification('Failed to upload brands', 'error');
            }
        }

        // 🎨 UI Functions
        function toggleTheme() {
            const body = document.body;
            if (body.classList.contains('theme-dark')) {
                body.className = 'min-h-screen';
                showNotification('Light theme activated ☀️', 'info');
            } else {
                body.className = 'theme-dark min-h-screen';
                showNotification('Dark theme activated 🌙', 'info');
            }
        }

        function showAddBrandForm() {
            document.getElementById('brandName').focus();
        }

        function updateStatistics() {
            document.getElementById('syncCount').textContent = state.statistics.syncCount;
        }

        async function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                showNotification('Signing out... 👋', 'info');
                
                realtimeChannels.forEach(channel => {
                    if (channel && channel.unsubscribe) {
                        channel.unsubscribe();
                    }
                });
                
                await supabase.auth.signOut();
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
            }
        }

        // 🎵 Notification Sound
        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (error) {
                console.log('Audio notification not supported');
            }
        }

        // 🛠️ Utility Functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        function formatTime(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            
            return date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 fade-in ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        function updateLoadingStatus(message) {
            document.getElementById('loadingStatus').textContent = message;
        }

        // 📋 Demo Data (Fallback)
        function loadDemoData() {
            loadDemoBrands();
            loadDemoMessages();
            updateCharts();
        }

        function loadDemoBrands() {
            state.brands = [
                { id: 1, name: 'IAkeys', views_28d: 180000, revenue: 21.6 },
                { id: 2, name: 'Ever-Sportz', views_28d: 150000, revenue: 18.0 },
                { id: 3, name: 'Ever-Moviez', views_28d: 100000, revenue: 12.0 }
            ];
            updateBrandsTable();
        }

        function loadDemoMessages() {
            state.messages = [
                { sender: 'CEO', receiver: 'all', message: 'Great work on the Q3 reports! Looking forward to the new brand data.', created_at: new Date().toISOString() },
                { sender: 'CFO', receiver: 'admin', message: 'The revenue projections look promising. Keep the data coming!', created_at: new Date(Date.now() - 300000).toISOString() },
                { sender: 'System', receiver: 'all', message: 'Admin portal activated. Real-time sync enabled with all executive dashboards.', created_at: new Date(Date.now() - 600000).toISOString() }
            ];
            updateMessages();
        }

        // 🚀 Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
  </html>
