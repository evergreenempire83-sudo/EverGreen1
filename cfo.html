<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EverGreen Empire ‚Äî CFO Financial Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #059669;
            --secondary: #047857;
            --background: #f0fdf4;
            --surface: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #dcfce7;
        }

        .theme-dark {
            --primary: #10b981;
            --secondary: #059669;
            --background: #1e2a1e;
            --surface: #2d3a2d;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #374151;
        }

        body {
            background-color: var(--background);
            color: var(--text);
            transition: all 0.3s ease;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse-glow {
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(5, 150, 105, 0.5); }
            50% { box-shadow: 0 0 20px rgba(5, 150, 105, 0.8); }
        }

        .online-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .message-ceo {
            background: linear-gradient(135deg, #1e40af, #3730a3);
            color: white;
            border-radius: 12px;
            padding: 12px;
            margin: 8px 0;
        }

        .message-cfo {
            background: linear-gradient(135deg, #059669, #047857);
            color: white;
            border-radius: 12px;
            padding: 12px;
            margin: 8px 0;
        }

        .message-admin {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
            color: white;
            border-radius: 12px;
            padding: 12px;
            margin: 8px 0;
        }

        .message-system {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            border-radius: 12px;
            padding: 12px;
            margin: 8px 0;
        }

        .greeting-banner {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
        }

        .profit {
            color: #10b981;
            font-weight: bold;
        }

        .loss {
            color: #ef4444;
            font-weight: bold;
        }

        .financial-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-left: 4px solid #059669;
        }

        .dark .financial-card {
            background: linear-gradient(135deg, #2d3a2d 0%, #1e2a1e 100%);
        }

        .cash-flow-positive {
            border-left: 4px solid #10b981;
        }

        .cash-flow-negative {
            border-left: 4px solid #ef4444;
        }

        .percentage-up {
            color: #10b981;
            font-weight: bold;
        }

        .percentage-down {
            color: #ef4444;
            font-weight: bold;
        }

        .ai-insight {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-left: 4px solid #f59e0b;
        }

        .dark .ai-insight {
            background: linear-gradient(135deg, #3f3f23, #4f4626);
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-green-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <div class="text-xl font-semibold text-gray-800">CFO Financial Hub</div>
            <div class="text-sm text-gray-600 mt-2" id="loadingStatus">Initializing financial analytics...</div>
        </div>
    </div>

    <!-- Security Check Modal -->
    <div id="securityModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 m-3 max-w-md w-full">
            <div class="text-center">
                <i class="fas fa-shield-alt text-4xl text-red-500 mb-4"></i>
                <h3 class="text-lg font-bold mb-2">Authentication Required</h3>
                <p class="text-gray-600 mb-4">Please log in to access the CFO Financial Hub</p>
                <button onclick="redirectToLogin()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                    Go to Login
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
        <!-- Header -->
        <header class="bg-green-800 text-white p-4 sticky top-0 z-40 shadow-lg">
            <div class="max-w-7xl mx-auto flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-lg bg-white/20 flex items-center justify-center">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">EverGreen Empire</h1>
                        <p class="text-sm opacity-90">CFO Financial Hub <span id="connectionStatus" class="online-dot"></span> <span id="syncStatus" class="text-xs">Live Financial Data</span></p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="flex space-x-2">
                        <a href="admin.html" class="p-2 rounded-lg bg-white/10 hover:bg-white/20" title="Admin Portal">
                            <i class="fas fa-cogs"></i>
                        </a>
                        <a href="ceo.html" class="p-2 rounded-lg bg-white/10 hover:bg-white/20" title="CEO Portal">
                            <i class="fas fa-crown"></i>
                        </a>
                    </div>
                    <button onclick="toggleTheme()" class="p-2 rounded-lg bg-white/10 hover:bg-white/20">
                        <i class="fas fa-palette"></i>
                    </button>
                    <button onclick="signOut()" class="bg-red-600 px-4 py-2 rounded-lg hover:bg-red-700 flex items-center">
                        <i class="fas fa-sign-out-alt mr-2"></i>Sign Out
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto p-4">
            <!-- Greeting Banner -->
            <div class="greeting-banner rounded-lg p-6 mb-6 text-white shadow-lg" id="greetingBanner">
                <div class="flex flex-col md:flex-row md:items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold mb-2" id="greetingMessage">Good morning, CFO!</h2>
                        <p class="text-green-100" id="greetingSubtext">Ready to analyze today's financial performance?</p>
                        <div class="flex items-center mt-2 space-x-2" id="greetingStats">
                            <span class="text-xs bg-white/20 px-2 py-1 rounded-full">üí∞ $0 Revenue</span>
                            <span class="text-xs bg-white/20 px-2 py-1 rounded-full">üìä 0 Brands</span>
                            <span class="text-xs bg-white/20 px-2 py-1 rounded-full">üìà 0% Growth</span>
                        </div>
                    </div>
                    <div class="mt-4 md:mt-0 flex items-center space-x-3">
                        <div class="text-right">
                            <div class="text-xs text-green-200">Financial Status</div>
                            <div class="text-sm font-bold" id="portalStatus">All Systems Green</div>
                        </div>
                        <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center pulse-glow">
                            <i class="fas fa-piggy-bank text-white text-lg"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Financial Stats -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="financial-card rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <h3 class="text-base font-bold">Total Revenue</h3>
                        <i class="fas fa-dollar-sign text-green-500"></i>
                    </div>
                    <div class="text-2xl font-bold mt-2" id="totalRevenue">$0</div>
                    <div class="text-xs text-gray-500">28-day estimate</div>
                </div>
                <div class="financial-card rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <h3 class="text-base font-bold">Net Profit</h3>
                        <i class="fas fa-chart-line text-blue-500"></i>
                    </div>
                    <div class="text-2xl font-bold mt-2 profit" id="netProfit">$0</div>
                    <div class="text-xs text-gray-500">After expenses</div>
                </div>
                <div class="financial-card rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <h3 class="text-base font-bold">Profit Margin</h3>
                        <i class="fas fa-percentage text-purple-500"></i>
                    </div>
                    <div class="text-2xl font-bold mt-2 percentage-up" id="profitMargin">0%</div>
                    <div class="text-xs text-gray-500">Revenue efficiency</div>
                </div>
                <div class="financial-card rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <h3 class="text-base font-bold">Cash Flow</h3>
                        <i class="fas fa-exchange-alt text-orange-500"></i>
                    </div>
                    <div class="text-2xl font-bold mt-2 profit" id="cashFlow">$0</div>
                    <div class="text-xs text-gray-500">Monthly projection</div>
                </div>
            </div>

            <!-- Financial Dashboard -->
            <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-6">
                <!-- Balance Sheet & Analytics -->
                <div class="card rounded-lg p-4 xl:col-span-2">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold">Financial Analytics Dashboard</h3>
                        <div class="flex space-x-2">
                            <button onclick="calculateROI()" class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 text-sm">
                                <i class="fas fa-calculator mr-1"></i>Calculate ROI
                            </button>
                            <button onclick="exportFinancials()" class="bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 text-sm">
                                <i class="fas fa-file-export mr-1"></i>Export
                            </button>
                        </div>
                    </div>

                    <!-- Balance Sheet -->
                    <div class="mb-6">
                        <h4 class="font-semibold mb-3 text-lg">Balance Sheet Summary</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h5 class="font-semibold mb-2">Assets</h5>
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span>Cash & Equivalents</span>
                                        <span class="font-semibold" id="cashAssets">$0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Accounts Receivable</span>
                                        <span class="font-semibold" id="receivables">$0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Brand Value</span>
                                        <span class="font-semibold" id="brandValue">$0</span>
                                    </div>
                                    <div class="flex justify-between border-t pt-2">
                                        <span class="font-semibold">Total Assets</span>
                                        <span class="font-semibold text-green-600" id="totalAssets">$0</span>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h5 class="font-semibold mb-2">Liabilities & Equity</h5>
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span>Accounts Payable</span>
                                        <span class="font-semibold" id="payables">$0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Operating Expenses</span>
                                        <span class="font-semibold" id="expenses">$0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Retained Earnings</span>
                                        <span class="font-semibold" id="earnings">$0</span>
                                    </div>
                                    <div class="flex justify-between border-t pt-2">
                                        <span class="font-semibold">Total Liabilities & Equity</span>
                                        <span class="font-semibold text-green-600" id="totalLiabilities">$0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Calculators -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h5 class="font-semibold mb-3">Profit/Loss Calculator</h5>
                            <div class="space-y-3">
                                <div>
                                    <label class="text-sm">Revenue</label>
                                    <input type="number" id="revenueInput" class="w-full p-2 border rounded" value="0">
                                </div>
                                <div>
                                    <label class="text-sm">Expenses</label>
                                    <input type="number" id="expensesInput" class="w-full p-2 border rounded" value="0">
                                </div>
                                <button onclick="calculateProfitLoss()" class="w-full bg-green-600 text-white p-2 rounded hover:bg-green-700">
                                    Calculate P&L
                                </button>
                                <div id="plResult" class="text-center font-semibold"></div>
                            </div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h5 class="font-semibold mb-3">Percentage Calculator</h5>
                            <div class="space-y-3">
                                <div>
                                    <label class="text-sm">Base Value</label>
                                    <input type="number" id="baseValue" class="w-full p-2 border rounded" value="0">
                                </div>
                                <div>
                                    <label class="text-sm">Percentage</label>
                                    <input type="number" id="percentage" class="w-full p-2 border rounded" value="0">
                                </div>
                                <button onclick="calculatePercentage()" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700">
                                    Calculate %
                                </button>
                                <div id="percentageResult" class="text-center font-semibold"></div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Financial Insights -->
                    <div class="ai-insight rounded-lg p-4">
                        <h4 class="font-semibold mb-2">ü§ñ AI Financial Insights</h4>
                        <div id="aiInsights" class="text-sm">
                            <p>Loading financial analysis...</p>
                        </div>
                    </div>
                </div>

                <!-- Executive Communications & Charts -->
                <div class="space-y-6">
                    <!-- Real-time Communications -->
                    <div class="card rounded-lg p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold">Executive Communications</h3>
                            <span class="text-xs text-green-600 bg-green-100 px-2 py-1 rounded-full">Live</span>
                        </div>
                        <div class="space-y-4">
                            <div class="flex flex-col space-y-2">
                                <input type="text" id="messageInput" placeholder="Type your financial update..." class="w-full p-3 border rounded-lg">
                                <select id="recipientSelect" class="w-full p-3 border rounded-lg">
                                    <option value="all">All Executives</option>
                                    <option value="ceo">CEO Only</option>
                                    <option value="admin">Admin Only</option>
                                </select>
                                <button onclick="sendMessage()" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700">
                                    <i class="fas fa-paper-plane mr-2"></i>Send Financial Update
                                </button>
                            </div>
                            <div id="messagesContainer" class="max-h-64 overflow-y-auto space-y-2 border rounded-lg p-3">
                                <!-- Messages will appear here -->
                            </div>
                        </div>
                    </div>

                    <!-- Revenue Distribution Chart -->
                    <div class="card rounded-lg p-4">
                        <h3 class="text-lg font-bold mb-4">Revenue Distribution</h3>
                        <canvas id="revenueChart" height="200"></canvas>
                    </div>

                    <!-- Cash Flow Chart -->
                    <div class="card rounded-lg p-4">
                        <h3 class="text-lg font-bold mb-4">Cash Flow Projection</h3>
                        <canvas id="cashFlowChart" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- Detailed Financial Reports -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Profit & Loss Statement -->
                <div class="card rounded-lg p-4">
                    <h3 class="text-lg font-bold mb-4">Profit & Loss Statement</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b">
                                    <th class="text-left py-3 px-2 font-semibold">Account</th>
                                    <th class="text-right py-3 px-2 font-semibold">Amount</th>
                                    <th class="text-right py-3 px-2 font-semibold">% of Revenue</th>
                                </tr>
                            </thead>
                            <tbody id="plTableBody">
                                <tr><td colspan="3" class="text-center py-4 text-gray-500">Loading financial data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Financial Metrics -->
                <div class="card rounded-lg p-4">
                    <h3 class="text-lg font-bold mb-4">Key Financial Metrics</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-trending-up text-green-500 mr-3"></i>
                                <span class="font-semibold">Gross Margin</span>
                            </div>
                            <span class="text-green-600 font-semibold" id="grossMargin">0%</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-calculator text-blue-500 mr-3"></i>
                                <span class="font-semibold">Operating Margin</span>
                            </div>
                            <span class="text-blue-600 font-semibold" id="operatingMargin">0%</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-rocket text-purple-500 mr-3"></i>
                                <span class="font-semibold">ROI (Return on Investment)</span>
                            </div>
                            <span class="text-purple-600 font-semibold" id="roi">0%</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-orange-50 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-bolt text-orange-500 mr-3"></i>
                                <span class="font-semibold">Current Ratio</span>
                            </div>
                            <span class="text-orange-600 font-semibold" id="currentRatio">0.0</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://clhaquwjevqdzjobthdz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsaGFxdXdqZXZxZHpqb2J0aGR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwNjYxODMsImV4cCI6MjA3NjY0MjE4M30.Ns2raXXMNPAveuogHrcRsTgazQrpTTnzr6ZeURc3pv0';
        
        // Initialize Supabase
        let supabase;
        let realtimeChannels = [];
        let revenueChart, cashFlowChart;

        // Global State
        let state = {
            brands: [],
            messages: [],
            financials: {
                totalRevenue: 0,
                expenses: 0,
                netProfit: 0,
                cashFlow: 0,
                profitMargin: 0
            },
            user: null
        };

        // üéä CFO AUTO GREETINGS SYSTEM
        const cfoGreetings = {
            morning: [
                "Good morning, CFO! üåÖ Ready to analyze today's financial landscape?",
                "Rise and shine, Financial Master! üí∞ The numbers await your expertise!",
                "Morning, CFO! Let's make today financially legendary! üìä",
                "Hello Financial Leader! The empire's treasury is in your hands! üëë"
            ],
            afternoon: [
                "Good afternoon, CFO! üìà How are our financial metrics performing?",
                "Afternoon, Financial Strategist! Time to optimize those revenue streams! üíé",
                "Hello CFO! Hope you're having a profitable day! üéØ",
                "CFO! Perfect time for a financial performance review! üíπ"
            ],
            evening: [
                "Good evening, CFO! üåá Wrapping up a financially successful day?",
                "Evening, Financial Genius! The balance sheets never sleep! üåô",
                "Hello CFO! Making strategic moves while others rest? üí™",
                "CFO! Evening is when financial empires are solidified! üè¶"
            ],
            night: [
                "Working late, CFO? üíº That's why our finances are rock-solid! üåÉ",
                "Good night shift, CFO! The treasury appreciates your dedication! üåå",
                "CFO! Burning the midnight oil for financial excellence? üî•",
                "Late night session, CFO! This is where financial legends are made! ‚≠ê"
            ],
            achievements: [
                "Outstanding work CFO! üíé You've managed ${revenue} revenue with {brands} brands!",
                "Financial excellence, CFO! üèÜ ${revenue} revenue under your leadership!",
                "CFO, you're crushing it! üìä {brands} brands generating massive returns!",
                "Amazing financial stewardship, CFO! üöÄ The empire thrives with your strategy!"
            ]
        };

        // üöÄ Initialize Application
        async function init() {
            console.log('üöÄ Initializing CFO Financial Hub...');
            updateLoadingStatus('Checking authentication...');

            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // Check authentication first
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error || !session) {
                    showSecurityModal();
                    return;
                }

                state.user = {
                    email: session.user.email,
                    role: 'cfo',
                    name: session.user.email.split('@')[0]
                };

                console.log('‚úÖ CFO authenticated:', state.user);
                updateLoadingStatus('Connecting to financial network...');

                await setupRealtimeConnections();
                await loadInitialData();
                
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                
                setupAutoGreeting();
                initializeCharts();
                generateFinancialInsights();
                
                showNotification(`Welcome back, CFO ${state.user.name}! Financial Hub activated! üí∞`, 'success');
                
            } catch (error) {
                console.error('‚ùå Initialization failed:', error);
                showSecurityModal();
            }
        }

        // üéØ Enhanced CFO Auto Greeting System
        function setupAutoGreeting() {
            const now = new Date();
            const hour = now.getHours();
            let timeOfDay = 'morning';
            
            if (hour >= 12 && hour < 17) timeOfDay = 'afternoon';
            else if (hour >= 17 && hour < 21) timeOfDay = 'evening';
            else if (hour >= 21 || hour < 5) timeOfDay = 'night';

            const greetingPool = cfoGreetings[timeOfDay];
            const randomGreeting = greetingPool[Math.floor(Math.random() * greetingPool.length)];
            
            const brandCount = state.brands.length;
            const totalRevenue = state.financials.totalRevenue;
            
            // Use achievement greeting if we have good numbers
            let finalGreeting = randomGreeting;
            if (brandCount >= 3 && totalRevenue >= 50) {
                const achievementGreeting = cfoGreetings.achievements[Math.floor(Math.random() * cfoGreetings.achievements.length)];
                finalGreeting = achievementGreeting
                    .replace('{brands}', brandCount)
                    .replace('${revenue}', `$${totalRevenue.toFixed(2)}`);
            }
            
            const greetingMessage = finalGreeting
                .replace('{name}', state.user.name)
                .replace('{brands}', brandCount)
                .replace('${revenue}', `$${totalRevenue.toFixed(2)}`);

            document.getElementById('greetingMessage').textContent = greetingMessage;
            
            // Update greeting stats
            const growthPercentage = state.financials.profitMargin > 0 ? state.financials.profitMargin.toFixed(1) : '0';
            const statsHTML = `
                <span class="text-xs bg-white/20 px-2 py-1 rounded-full">üí∞ $${totalRevenue.toFixed(2)} Revenue</span>
                <span class="text-xs bg-white/20 px-2 py-1 rounded-full">üìä ${brandCount} Brands</span>
                <span class="text-xs bg-white/20 px-2 py-1 rounded-full">üìà ${growthPercentage}% Growth</span>
            `;
            document.getElementById('greetingStats').innerHTML = statsHTML;
        }

        // üîê SECURITY FUNCTIONS
        function showSecurityModal() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('securityModal').classList.remove('hidden');
        }

        function redirectToLogin() {
            window.location.href = 'index.html';
        }

        // üîÑ Real-time Connections
        async function setupRealtimeConnections() {
            if (!supabase) return;

            try {
                // Real-time messages
                const messagesChannel = supabase
                    .channel('cfo-messages')
                    .on('postgres_changes', 
                        { event: 'INSERT', schema: 'public', table: 'messages' }, 
                        (payload) => {
                            console.log('üí¨ New message:', payload.new);
                            state.messages.unshift(payload.new);
                            updateMessages();
                            playNotificationSound();
                            
                            if (payload.new.sender === 'CEO' || payload.new.sender === 'Admin') {
                                showNotification(`New message from ${payload.new.sender}`, 'info');
                            }
                        }
                    )
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            document.getElementById('connectionStatus').style.background = '#10b981';
                            document.getElementById('syncStatus').textContent = 'Live Financial Data';
                        }
                    });

                realtimeChannels.push(messagesChannel);

                // Real-time brands data
                const brandsChannel = supabase
                    .channel('cfo-brands')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'brands' }, 
                        async (payload) => {
                            console.log('üîÑ Brands data updated:', payload);
                            await loadBrandsData();
                            updateFinancials();
                            
                            if (payload.eventType === 'INSERT') {
                                showNotification(`New brand added: ${payload.new.name}`, 'success');
                            }
                        }
                    )
                    .subscribe();

                realtimeChannels.push(brandsChannel);

            } catch (error) {
                console.error('‚ùå Real-time setup failed:', error);
            }
        }

        // üìä Data Management
        async function loadInitialData() {
            await loadBrandsData();
            await loadMessages();
            updateFinancials();
        }

        async function loadBrandsData() {
            try {
                const { data: brands, error } = await supabase
                    .from('brands')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                
                state.brands = brands || [];
                updateFinancials();
                
                console.log(`‚úÖ Loaded ${state.brands.length} brands for financial analysis`);

            } catch (error) {
                console.error('‚ùå Error loading brands:', error);
                loadDemoBrands();
            }
        }

        async function loadMessages() {
            try {
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) throw error;
                state.messages = messages || [];
                updateMessages();
                
            } catch (error) {
                console.error('‚ùå Error loading messages:', error);
                loadDemoMessages();
            }
        }

        // üí∞ Financial Calculations
        function updateFinancials() {
            // Calculate total revenue from brands
            const totalRevenue = state.brands.reduce((sum, brand) => sum + ((brand.views_28d || 0) / 1000) * 0.12, 0);
            
            // Calculate expenses (simulated as 40% of revenue)
            const expenses = totalRevenue * 0.4;
            
            // Calculate net profit
            const netProfit = totalRevenue - expenses;
            
            // Calculate profit margin
            const profitMargin = totalRevenue > 0 ? (netProfit / totalRevenue) * 100 : 0;
            
            // Calculate cash flow (simulated)
            const cashFlow = netProfit * 0.8;
            
            // Update state
            state.financials = {
                totalRevenue,
                expenses,
                netProfit,
                profitMargin,
                cashFlow
            };
            
            // Update UI
            updateFinancialUI();
            updateBalanceSheet();
            updateProfitLossStatement();
            updateFinancialMetrics();
        }

        function updateFinancialUI() {
            const f = state.financials;
            
            document.getElementById('totalRevenue').textContent = formatCurrency(f.totalRevenue);
            document.getElementById('netProfit').textContent = formatCurrency(f.netProfit);
            document.getElementById('profitMargin').textContent = `${f.profitMargin.toFixed(1)}%`;
            document.getElementById('cashFlow').textContent = formatCurrency(f.cashFlow);
            
            // Color coding
            document.getElementById('netProfit').className = `text-2xl font-bold mt-2 ${f.netProfit >= 0 ? 'profit' : 'loss'}`;
            document.getElementById('profitMargin').className = `text-2xl font-bold mt-2 ${f.profitMargin >= 0 ? 'percentage-up' : 'percentage-down'}`;
            document.getElementById('cashFlow').className = `text-2xl font-bold mt-2 ${f.cashFlow >= 0 ? 'profit' : 'loss'}`;
        }

        function updateBalanceSheet() {
            const f = state.financials;
            
            // Simulated balance sheet items
            const cashAssets = f.totalRevenue * 0.3;
            const receivables = f.totalRevenue * 0.2;
            const brandValue = f.totalRevenue * 2.5; // 2.5x revenue multiple
            const totalAssets = cashAssets + receivables + brandValue;
            
            const payables = f.expenses * 0.6;
            const retainedEarnings = f.netProfit * 0.7;
            const totalLiabilities = payables + f.expenses + retainedEarnings;
            
            document.getElementById('cashAssets').textContent = formatCurrency(cashAssets);
            document.getElementById('receivables').textContent = formatCurrency(receivables);
            document.getElementById('brandValue').textContent = formatCurrency(brandValue);
            document.getElementById('totalAssets').textContent = formatCurrency(totalAssets);
            
            document.getElementById('payables').textContent = formatCurrency(payables);
            document.getElementById('expenses').textContent = formatCurrency(f.expenses);
            document.getElementById('earnings').textContent = formatCurrency(retainedEarnings);
            document.getElementById('totalLiabilities').textContent = formatCurrency(totalLiabilities);
        }

        function updateProfitLossStatement() {
            const f = state.financials;
            const tbody = document.getElementById('plTableBody');
            
            if (state.brands.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">No financial data available</td></tr>';
                return;
            }
            
            const rows = [
                { account: 'Total Revenue', amount: f.totalRevenue, percentage: 100 },
                { account: 'Cost of Revenue', amount: f.expenses * 0.6, percentage: (f.expenses * 0.6 / f.totalRevenue) * 100 },
                { account: 'Gross Profit', amount: f.totalRevenue - (f.expenses * 0.6), percentage: ((f.totalRevenue - (f.expenses * 0.6)) / f.totalRevenue) * 100 },
                { account: 'Operating Expenses', amount: f.expenses * 0.4, percentage: (f.expenses * 0.4 / f.totalRevenue) * 100 },
                { account: 'Operating Income', amount: f.netProfit, percentage: f.profitMargin },
                { account: 'Net Income', amount: f.netProfit, percentage: f.profitMargin }
            ];
            
            tbody.innerHTML = rows.map(row => `
                <tr class="border-b">
                    <td class="py-2 px-2">${row.account}</td>
                    <td class="py-2 px-2 text-right font-semibold ${row.amount >= 0 ? 'profit' : 'loss'}">
                        ${formatCurrency(row.amount)}
                    </td>
                    <td class="py-2 px-2 text-right ${row.percentage >= 0 ? 'percentage-up' : 'percentage-down'}">
                        ${row.percentage.toFixed(1)}%
                    </td>
                </tr>
            `).join('');
        }

        function updateFinancialMetrics() {
            const f = state.financials;
            
            document.getElementById('grossMargin').textContent = f.totalRevenue > 0 ? `${((f.totalRevenue - (f.expenses * 0.6)) / f.totalRevenue * 100).toFixed(1)}%` : '0%';
            document.getElementById('operatingMargin').textContent = `${f.profitMargin.toFixed(1)}%`;
            document.getElementById('roi').textContent = f.totalRevenue > 0 ? `${(f.netProfit / (f.totalRevenue * 0.5) * 100).toFixed(1)}%` : '0%';
            document.getElementById('currentRatio').textContent = (f.totalRevenue * 0.3 / (f.expenses * 0.6)).toFixed(2);
        }

        // üßÆ Financial Calculators
        function calculateProfitLoss() {
            const revenue = parseFloat(document.getElementById('revenueInput').value) || 0;
            const expenses = parseFloat(document.getElementById('expensesInput').value) || 0;
            const profit = revenue - expenses;
            const margin = revenue > 0 ? (profit / revenue) * 100 : 0;
            
            const result = document.getElementById('plResult');
            result.innerHTML = `
                <div class="${profit >= 0 ? 'profit' : 'loss'}">
                    ${profit >= 0 ? 'üí∞ Profit:' : 'üìâ Loss:'} ${formatCurrency(Math.abs(profit))}<br>
                    <small>Margin: ${margin.toFixed(1)}%</small>
                </div>
            `;
        }

        function calculatePercentage() {
            const base = parseFloat(document.getElementById('baseValue').value) || 0;
            const percentage = parseFloat(document.getElementById('percentage').value) || 0;
            const result = (base * percentage) / 100;
            
            const resultElement = document.getElementById('percentageResult');
            resultElement.innerHTML = `
                <div class="percentage-up">
                    ${percentage}% of ${formatCurrency(base)} = ${formatCurrency(result)}<br>
                    <small>Total: ${formatCurrency(base + result)}</small>
                </div>
            `;
        }

        function calculateROI() {
            const investment = state.financials.totalRevenue * 0.5; // Simulated investment
            const netProfit = state.financials.netProfit;
            const roi = investment > 0 ? (netProfit / investment) * 100 : 0;
            
            showNotification(`ROI Calculation: ${roi.toFixed(1)}% return on investment`, 'info');
        }

        // ü§ñ AI Financial Insights
        function generateFinancialInsights() {
            const f = state.financials;
            const brandCount = state.brands.length;
            
            let insights = [];
            
            if (f.profitMargin > 20) {
                insights.push("üìà <strong>Excellent Profit Margin:</strong> Your current margin indicates strong financial health and efficient operations.");
            } else if (f.profitMargin > 10) {
                insights.push("‚úÖ <strong>Healthy Profit Margin:</strong> Maintain current strategies while exploring cost optimization opportunities.");
            } else {
                insights.push("‚ö†Ô∏è <strong>Margin Improvement Opportunity:</strong> Consider reviewing expenses and revenue streams for optimization.");
            }
            
            if (brandCount >= 5) {
                insights.push("üè¢ <strong>Strong Brand Portfolio:</strong> Diversified revenue streams provide stability and growth potential.");
            } else if (brandCount >= 3) {
                insights.push("üìä <strong>Growing Portfolio:</strong> Consider strategic acquisitions to further diversify revenue.");
            }
            
            if (f.cashFlow > f.totalRevenue * 0.3) {
                insights.push("üíß <strong>Strong Cash Flow:</strong> Excellent liquidity position for investments and expansion.");
            }
            
            if (f.totalRevenue > 100) {
                insights.push("üöÄ <strong>Revenue Milestone:</strong> Consider reinvesting profits into marketing and brand development.");
            }
            
            // Default insight if no specific conditions met
            if (insights.length === 0) {
                insights.push("üìã <strong>Financial Foundation:</strong> Focus on building brand portfolio and optimizing revenue streams.");
            }
            
            document.getElementById('aiInsights').innerHTML = insights.map(insight => `<p class="mb-2">${insight}</p>`).join('');
        }

        // üí¨ Messaging System
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            const recipient = document.getElementById('recipientSelect').value;

            if (!message) {
                showNotification('Please enter a message', 'error');
                return;
            }

            const messageData = {
                sender: 'CFO',
                receiver: recipient,
                message: message,
                created_at: new Date().toISOString()
            };

            state.messages.unshift(messageData);
            updateMessages();
            messageInput.value = '';

            try {
                const { error } = await supabase.from('messages').insert([messageData]);
                if (error) throw error;
                showNotification('Financial update sent to executives! üì§', 'success');
            } catch (error) {
                console.error('‚ùå Failed to save message:', error);
                showNotification('Message sent locally', 'warning');
            }
        }

        function updateMessages() {
            const container = document.getElementById('messagesContainer');
            const totalMessages = document.getElementById('totalMessages');
            
            if (!state.messages.length) {
                container.innerHTML = '<div class="text-center text-gray-500 text-sm py-4">No messages yet</div>';
                return;
            }

            container.innerHTML = state.messages.map(msg => {
                let messageClass = 'message-cfo';
                if (msg.sender === 'CEO') messageClass = 'message-ceo';
                if (msg.sender === 'Admin') messageClass = 'message-admin';
                if (msg.sender === 'System') messageClass = 'message-system';
                
                return `
                <div class="${messageClass} fade-in">
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-semibold text-sm">${msg.sender}</span>
                        <span class="text-xs opacity-80">${formatTime(msg.created_at)}</span>
                    </div>
                    <div class="text-sm">${msg.message}</div>
                    ${msg.receiver !== 'all' ? `<div class="text-xs opacity-80 mt-1">To: ${msg.receiver}</div>` : ''}
                </div>
                `;
            }).join('');

            container.scrollTop = container.scrollHeight;
        }

        // üìà Charts
        function initializeCharts() {
            // Revenue Distribution Chart
            const revCtx = document.getElementById('revenueChart').getContext('2d');
            revenueChart = new Chart(revCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#10b981', '#059669', '#047857', '#065f46', '#064e3b',
                            '#ec4899', '#8b5cf6', '#3b82f6', '#f59e0b', '#ef4444'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Cash Flow Chart
            const cashCtx = document.getElementById('cashFlowChart').getContext('2d');
            cashFlowChart = new Chart(cashCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Cash Flow',
                        data: [0, 0, 0, 0, 0, 0],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true
                }
            });

            updateCharts();
        }

        function updateCharts() {
            if (!revenueChart || !cashFlowChart) return;

            // Update revenue distribution
            const topBrands = state.brands.slice(0, 5);
            revenueChart.data.labels = topBrands.map(brand => brand.name);
            revenueChart.data.datasets[0].data = topBrands.map(brand => (brand.views_28d / 1000) * 0.12);
            revenueChart.update();

            // Update cash flow projection
            const baseCash = state.financials.cashFlow;
            const cashFlowData = Array.from({length: 6}, (_, i) => 
                baseCash * (0.8 + (i * 0.1)) + (Math.random() * baseCash * 0.2)
            );
            cashFlowChart.data.datasets[0].data = cashFlowData;
            cashFlowChart.update();
        }

        // üì§ Export Functionality
        function exportFinancials() {
            const financialData = {
                timestamp: new Date().toISOString(),
                brands: state.brands,
                financials: state.financials,
                balanceSheet: {
                    assets: {
                        cash: parseFloat(document.getElementById('cashAssets').textContent.replace('$', '')),
                        receivables: parseFloat(document.getElementById('receivables').textContent.replace('$', '')),
                        brandValue: parseFloat(document.getElementById('brandValue').textContent.replace('$', ''))
                    },
                    liabilities: {
                        payables: parseFloat(document.getElementById('payables').textContent.replace('$', '')),
                        expenses: parseFloat(document.getElementById('expenses').textContent.replace('$', '')),
                        earnings: parseFloat(document.getElementById('earnings').textContent.replace('$', ''))
                    }
                }
            };
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(financialData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "evergreen_financial_report.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            
            showNotification('Financial report exported successfully! üìÑ', 'success');
        }

        // üé® UI Functions
        function toggleTheme() {
            const body = document.body;
            if (body.classList.contains('theme-dark')) {
                body.className = 'min-h-screen';
                showNotification('Light theme activated ‚òÄÔ∏è', 'info');
            } else {
                body.className = 'theme-dark min-h-screen';
                showNotification('Dark theme activated üåô', 'info');
            }
        }

        async function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                showNotification('Signing out... üëã', 'info');
                
                realtimeChannels.forEach(channel => {
                    if (channel && channel.unsubscribe) {
                        channel.unsubscribe();
                    }
                });
                
                await supabase.auth.signOut();
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
            }
        }

        // üéµ Notification Sound
        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 600;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (error) {
                console.log('Audio notification not supported');
            }
        }

        // üõ†Ô∏è Utility Functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        function formatTime(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            
            return date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 fade-in ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        function updateLoadingStatus(message) {
            document.getElementById('loadingStatus').textContent = message;
        }

        // üìã Demo Data (Fallback)
        function loadDemoBrands() {
            state.brands = [
                { id: 1, name: 'IAkeys', views_28d: 180000, revenue: 21.6 },
                { id: 2, name: 'Ever-Sportz', views_28d: 150000, revenue: 18.0 },
                { id: 3, name: 'Ever-Moviez', views_28d: 100000, revenue: 12.0 }
            ];
            updateFinancials();
        }

        function loadDemoMessages() {
            state.messages = [
                { sender: 'CEO', receiver: 'all', message: 'Great work on the Q3 financial reports! The numbers look strong.', created_at: new Date().toISOString() },
                { sender: 'Admin', receiver: 'cfo', message: 'New brand data has been uploaded for financial analysis.', created_at: new Date(Date.now() - 300000).toISOString() },
                { sender: 'System', receiver: 'all', message: 'CFO Financial Hub activated. Real-time sync enabled with all executive dashboards.', created_at: new Date(Date.now() - 600000).toISOString() }
            ];
            updateMessages();
        }

        // üöÄ Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
