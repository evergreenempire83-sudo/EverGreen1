<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EverGreen Empire â€” AI CFO Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-ceo {
            background: linear-gradient(135deg, #1e40af, #3730a3);
            color: white;
            border-radius: 12px;
            padding: 12px;
            margin: 8px 0;
        }
        .message-cfo {
            background: linear-gradient(135deg, #059669, #047857);
            color: white;
            border-radius: 12px;
            padding: 12px;
            margin: 8px 0;
        }
        .message-admin {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
            color: white;
            border-radius: 12px;
            padding: 12px;
            margin: 8px 0;
        }
        .ai-insight {
            border-left: 4px solid #8b5cf6;
            background: linear-gradient(135deg, #faf5ff, #f3e8ff);
            padding: 16px;
            border-radius: 8px;
            margin: 8px 0;
        }
        .online-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .empty-state {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
        }
        .mobile-menu {
            transition: all 0.3s ease;
        }
        .logout-modal {
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
        }
        @media (max-width: 768px) {
            .responsive-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
        }
        .shake {
            animation: shake 0.5s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .financial-card {
            transition: all 0.3s ease;
        }
        .financial-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .greeting-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Authentication Check Screen -->
    <div id="authCheckScreen" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <div class="text-xl font-semibold text-gray-800">Security Verification</div>
            <div class="text-sm text-gray-600 mt-2" id="authStatus">Checking authentication...</div>
        </div>
    </div>

    <!-- Simple Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white z-40 flex items-center justify-center hidden">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-green-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <div class="text-xl font-semibold text-gray-800">AI CFO Portal</div>
            <div class="text-sm text-gray-600 mt-2" id="loadingStatus">Loading financial dashboard...</div>
        </div>
    </div>

    <!-- Auto Logout Modal -->
    <div id="autoLogoutModal" class="logout-modal fixed inset-0 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex items-center mb-4">
                <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center mr-4">
                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-gray-800">Session Timeout Warning</h3>
                    <p class="text-sm text-gray-600">You will be logged out due to inactivity</p>
                </div>
            </div>
            <div class="mb-4">
                <div class="flex justify-between text-sm text-gray-600 mb-1">
                    <span>Time remaining:</span>
                    <span id="timeRemaining">2:00</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="timeoutProgress" class="bg-red-600 h-2 rounded-full transition-all duration:1000" style="width: 100%"></div>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3">
                <button id="cancelLogout" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all text-sm sm:text-base">
                    Stay Logged In
                </button>
                <button id="confirmLogout" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all text-sm sm:text-base">
                    Log Out Now
                </button>
            </div>
        </div>
    </div>

    <!-- Access Denied Screen -->
    <div id="accessDeniedScreen" class="fixed inset-0 bg-white z-50 flex items-center justify-center hidden">
        <div class="text-center max-w-md mx-4">
            <div class="w-20 h-20 rounded-full bg-red-100 flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-ban text-red-600 text-2xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Access Denied</h2>
            <p class="text-gray-600 mb-6">You don't have permission to access the CFO Portal. Please login with a CFO account.</p>
            <button onclick="redirectToLogin()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-all">
                <i class="fas fa-sign-in-alt mr-2"></i>Go to Login
            </button>
        </div>
    </div>

    <!-- Main Portal Content (Hidden until authenticated) -->
    <div id="portalContent" class="hidden">
        <!-- Header -->
        <header class="bg-green-800 text-white p-4 sticky top-0 z-40 shadow-lg">
            <div class="max-w-7xl mx-auto flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-lg bg-white/20 flex items-center justify-center">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">EverGreen Empire</h1>
                        <p class="text-sm opacity-90">AI CFO Portal <span id="connectionStatus" class="online-dot"></span> <span id="syncStatus" class="text-xs">Connected</span></p>
                    </div>
                </div>
                
                <!-- Desktop Navigation -->
                <div class="hidden md:flex items-center space-x-3">
                    <div class="text-right text-sm hidden sm:block">
                        <div class="font-medium" id="userEmail">CFO User</div>
                        <div class="text-xs opacity-80" id="sessionTimer">Session: 30:00</div>
                    </div>
                    <button onclick="toggleTheme()" class="p-2 rounded-lg bg-white/10 hover:bg-white/20 transition-all">
                        <i class="fas fa-palette"></i>
                    </button>
                    <button onclick="generateAIReport()" class="p-2 rounded-lg bg-purple-600 hover:bg-purple-700 transition-all">
                        <i class="fas fa-robot"></i>
                    </button>
                    <button onclick="signOut()" class="p-2 rounded-lg bg-red-600 hover:bg-red-700 transition-all flex items-center">
                        <i class="fas fa-sign-out-alt"></i>
                        <span class="ml-2 hidden sm:inline">Sign Out</span>
                    </button>
                </div>
                
                <!-- Mobile Menu Button -->
                <div class="md:hidden">
                    <button id="mobileMenuButton" class="p-2 rounded-lg bg-white/10 hover:bg-white/20 transition-all">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>
            
            <!-- Mobile Menu -->
            <div id="mobileMenu" class="mobile-menu md:hidden mt-4 bg-green-700 rounded-lg p-4 hidden">
                <div class="flex flex-col space-y-3">
                    <div class="text-white text-sm p-2 border-b border-green-600">
                        <div class="font-medium" id="mobileUserEmail">CFO User</div>
                        <div class="text-xs opacity-80" id="mobileSessionTimer">Session: 30:00</div>
                    </div>
                    <button onclick="toggleTheme()" class="flex items-center p-2 rounded-lg bg-white/10 hover:bg-white/20 transition-all text-white">
                        <i class="fas fa-palette mr-3"></i>
                        <span>Toggle Theme</span>
                    </button>
                    <button onclick="generateAIReport()" class="flex items-center p-2 rounded-lg bg-purple-600 hover:bg-purple-700 transition-all text-white">
                        <i class="fas fa-robot mr-3"></i>
                        <span>AI Report</span>
                    </button>
                    <button onclick="signOut()" class="flex items-center p-2 rounded-lg bg-red-600 hover:bg-red-700 transition-all text-white">
                        <i class="fas fa-sign-out-alt mr-3"></i>
                        <span>Sign Out</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto p-4">
            <!-- Greeting Banner -->
            <div class="greeting-banner rounded-lg p-6 mb-6 text-white shadow-lg">
                <div class="flex flex-col md:flex-row md:items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold mb-2" id="greetingMessage">Good morning, CFO!</h2>
                        <p class="text-blue-100" id="greetingSubtext">Ready to analyze today's financial performance?</p>
                    </div>
                    <div class="mt-4 md:mt-0 flex items-center space-x-3">
                        <div class="text-right">
                            <div class="text-xs text-blue-200">Portal Status</div>
                            <div class="text-sm font-bold" id="portalStatus">All Systems Active</div>
                        </div>
                        <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center">
                            <i class="fas fa-shield-alt text-white text-lg"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Welcome Banner -->
            <div class="bg-white rounded-lg p-4 shadow-sm border mb-6">
                <div class="flex flex-col md:flex-row md:items-center justify-between">
                    <div class="mb-4 md:mb-0">
                        <h2 class="text-xl font-bold text-gray-800 mb-1">Financial Command Center</h2>
                        <p class="text-sm text-gray-600">AI-Powered Financial Analytics & Executive Network</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="text-right">
                            <div class="text-xs text-gray-600">AI Status</div>
                            <div class="text-sm font-bold text-green-600" id="aiStatus">Waiting for Data</div>
                        </div>
                        <div class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center">
                            <i class="fas fa-brain text-gray-400 text-lg"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Financial KPIs -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="financial-card bg-gradient-to-br from-green-500 to-green-600 text-white rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-base font-bold">Total Revenue</h3>
                        <i class="fas fa-dollar-sign text-lg opacity-80"></i>
                    </div>
                    <div class="text-2xl font-bold mb-1" id="totalRevenue">$0</div>
                    <div class="flex items-center text-xs">
                        <i class="fas fa-minus mr-1"></i>
                        <span>0%</span>
                        <span class="ml-2 opacity-80">Waiting for data</span>
                    </div>
                </div>

                <div class="financial-card bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-base font-bold">Net Profit</h3>
                        <i class="fas fa-percentage text-lg opacity-80"></i>
                    </div>
                    <div class="text-2xl font-bold mb-1" id="netProfit">$0</div>
                    <div class="flex items-center text-xs">
                        <i class="fas fa-minus mr-1"></i>
                        <span>0%</span>
                        <span class="ml-2 opacity-80">Waiting for data</span>
                    </div>
                </div>

                <div class="financial-card bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-base font-bold">Cash Flow</h3>
                        <i class="fas fa-money-bill-wave text-lg opacity-80"></i>
                    </div>
                    <div class="text-2xl font-bold mb-1" id="cashFlow">$0</div>
                    <div class="flex items-center text-xs">
                        <i class="fas fa-minus mr-1"></i>
                        <span>$0</span>
                        <span class="ml-2 opacity-80">Waiting for data</span>
                    </div>
                </div>

                <div class="financial-card bg-gradient-to-br from-indigo-500 to-indigo-600 text-white rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-base font-bold">ROI</h3>
                        <i class="fas fa-chart-line text-lg opacity-80"></i>
                    </div>
                    <div class="text-2xl font-bold mb-1" id="roi">0%</div>
                    <div class="flex items-center text-xs">
                        <i class="fas fa-minus mr-1"></i>
                        <span>0%</span>
                        <span class="ml-2 opacity-80">Waiting for data</span>
                    </div>
                </div>
            </div>

            <!-- Financial Statements & AI Analytics -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <!-- Profit & Loss Statement -->
                <div class="bg-white rounded-lg p-4 shadow-sm border lg:col-span-2">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold flex items-center">
                            <i class="fas fa-file-invoice-dollar mr-2 text-green-500"></i>Profit & Loss Statement
                        </h3>
                        <div class="flex space-x-2">
                            <button onclick="generatePLReport()" class="bg-green-600 text-white px-3 py-1 rounded-lg hover:bg-green-700 transition-all text-sm">
                                <i class="fas fa-sync-alt mr-1"></i>Refresh
                            </button>
                            <button onclick="exportPLStatement()" class="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 transition-all text-sm">
                                <i class="fas fa-download mr-1"></i>Export
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b-2 border-gray-200">
                                    <th class="text-left py-3 font-semibold">Category</th>
                                    <th class="text-right py-3 font-semibold">Current Qtr</th>
                                    <th class="text-right py-3 font-semibold">Prev Qtr</th>
                                    <th class="text-right py-3 font-semibold">Variance</th>
                                </tr>
                            </thead>
                            <tbody id="plStatementBody">
                                <tr>
                                    <td colspan="4" class="text-center py-8">
                                        <div class="empty-state">
                                            <i class="fas fa-file-invoice-dollar text-4xl text-gray-400 mb-4"></i>
                                            <div class="text-gray-600 font-semibold mb-2">No Financial Data Available</div>
                                            <div class="text-sm text-gray-500">Waiting for Admin to upload financial data</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Balance Sheet -->
                <div class="bg-white rounded-lg p-4 shadow-sm border">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold flex items-center">
                            <i class="fas fa-balance-scale mr-2 text-blue-500"></i>Balance Sheet
                        </h3>
                        <button onclick="generateBalanceSheet()" class="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 transition-all text-sm">
                            <i class="fas fa-sync-alt mr-1"></i>Update
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2">Assets</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-sm">Cash & Equivalents</span>
                                    <span class="text-sm font-medium">$0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm">Accounts Receivable</span>
                                    <span class="text-sm font-medium">$0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm">Inventory</span>
                                    <span class="text-sm font-medium">$0</span>
                                </div>
                                <div class="flex justify-between border-t pt-2">
                                    <span class="text-sm font-semibold">Total Assets</span>
                                    <span class="text-sm font-semibold">$0</span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2">Liabilities</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-sm">Accounts Payable</span>
                                    <span class="text-sm font-medium">$0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm">Short-term Debt</span>
                                    <span class="text-sm font-medium">$0</span>
                                </div>
                                <div class="flex justify-between border-t pt-2">
                                    <span class="text-sm font-semibold">Total Liabilities</span>
                                    <span class="text-sm font-semibold">$0</span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2">Equity</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-sm">Retained Earnings</span>
                                    <span class="text-sm font-medium">$0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm">Common Stock</span>
                                    <span class="text-sm font-medium">$0</span>
                                </div>
                                <div class="flex justify-between border-t pt-2">
                                    <span class="text-sm font-semibold">Total Equity</span>
                                    <span class="text-sm font-semibold">$0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Insights & Communications -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- AI Financial Advisor -->
                <div class="bg-white rounded-lg p-4 shadow-sm border">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold flex items-center">
                            <i class="fas fa-robot mr-2 text-purple-500"></i>AI Financial Advisor
                        </h3>
                        <span class="text-xs text-green-600 bg-green-100 px-2 py-1 rounded-full">Gemini AI Ready</span>
                    </div>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="generateAIInsight('revenue')" class="bg-green-600 hover:bg-green-700 text-white p-2 rounded-lg text-sm transition-all">
                                 Revenue Analysis
                            </button>
                            <button onclick="generateAIInsight('profitability')" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg text-sm transition-all">
                                 Profitability
                            </button>
                            <button onclick="generateAIInsight('costs')" class="bg-purple-600 hover:bg-purple-700 text-white p-2 rounded-lg text-sm transition-all">
                                 Cost Analysis
                            </button>
                            <button onclick="generateAIInsight('investment')" class="bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded-lg text-sm transition-all">
                                 Investments
                            </button>
                        </div>
                        <div id="aiOutput" class="min-h-[200px] max-h-[300px] overflow-y-auto p-3 bg-gray-50 rounded-lg border">
                            <div class="text-center text-gray-500 py-8">
                                <i class="fas fa-robot text-2xl mb-2 text-purple-500"></i>
                                <div class="text-sm">Select an analysis type to get AI insights</div>
                                <div class="text-xs mt-1">Powered by Google Gemini</div>
                            </div>
                        </div>
                        <button onclick="generateQuickAdvice()" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-2 rounded-lg hover:from-purple-700 hover:to-indigo-700 transition-all text-sm">
                            <i class="fas fa-bolt mr-1"></i>Quick Financial Advice
                        </button>
                    </div>
                </div>

                <!-- Executive Communications -->
                <div class="bg-white rounded-lg p-4 shadow-sm border">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold">Executive Communications</h3>
                        <div class="flex items-center text-xs text-green-600">
                            <span class="online-dot"></span>
                            <span>Live with CEO & Admin</span>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="flex flex-col space-y-2">
                            <input type="text" id="messageInput" placeholder="Type your message to CEO or Admin..." class="w-full p-2 border rounded-lg text-sm">
                            <select id="recipientSelect" class="w-full p-2 border rounded-lg text-sm">
                                <option value="all">All Executives (CEO & Admin)</option>
                                <option value="ceo">CEO Only</option>
                                <option value="admin">Admin Team Only</option>
                                <option value="cfo">CFO Team Only</option>
                            </select>
                            <button onclick="sendMessage()" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-all">
                                <i class="fas fa-paper-plane mr-1"></i>Send Message
                            </button>
                        </div>
                        <div id="messagesContainer" class="max-h-48 overflow-y-auto space-y-2 border rounded-lg p-2">
                            <div class="text-center text-gray-500 text-sm py-4">Loading executive messages...</div>
                        </div>
                        <div class="flex flex-col md:flex-row md:items-center justify-between text-xs text-gray-500">
                            <span>Connected to: CEO, Admin, CFO</span>
                            <span id="messageCount" class="mt-1 md:mt-0">0 messages</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Financial Spreadsheet -->
            <div class="bg-white rounded-lg p-4 shadow-sm border mb-6">
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-4">
                    <h3 class="text-lg font-bold mb-2 md:mb-0">Financial Spreadsheet</h3>
                    <div class="flex space-x-2">
                        <button onclick="addRow()" class="bg-green-600 text-white px-3 py-1 rounded-lg hover:bg-green-700 transition-all text-sm">
                            <i class="fas fa-plus mr-1"></i>Add Row
                        </button>
                        <button onclick="calculateTotals()" class="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 transition-all text-sm">
                            <i class="fas fa-calculator mr-1"></i>Calculate
                        </button>
                        <button onclick="exportSpreadsheet()" class="bg-indigo-600 text-white px-3 py-1 rounded-lg hover:bg-indigo-700 transition-all text-sm">
                            <i class="fas fa-download mr-1"></i>Export
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto responsive-table">
                    <table class="w-full min-w-[600px] text-sm">
                        <thead>
                            <tr class="border-b-2 border-gray-200">
                                <th class="text-left py-3 font-semibold">Account</th>
                                <th class="text-right py-3 font-semibold">Budget</th>
                                <th class="text-right py-3 font-semibold">Actual</th>
                                <th class="text-right py-3 font-semibold">Variance</th>
                                <th class="text-right py-3 font-semibold">%</th>
                                <th class="text-center py-3 font-semibold">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="spreadsheetBody">
                            <tr>
                                <td colspan="6" class="text-center py-8">
                                    <div class="empty-state">
                                        <i class="fas fa-table text-4xl text-gray-400 mb-4"></i>
                                        <div class="text-gray-600 font-semibold mb-2">No Spreadsheet Data</div>
                                        <div class="text-sm text-gray-500">Add rows to start tracking financial data</div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="border-t-2 border-gray-300 font-semibold">
                                <td class="py-3">Total</td>
                                <td class="text-right py-3" id="totalBudget">$0</td>
                                <td class="text-right py-3" id="totalActual">$0</td>
                                <td class="text-right py-3" id="totalVariance">$0</td>
                                <td class="text-right py-3" id="totalVariancePercent">0%</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://clhaquwjevqdzjobthdz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsaGFxdXdqZXZxZHpqb2J0aGR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwNjYxODMsImV4cCI6MjA3NjY0MjE4M30.Ns2raXXMNPAveuogHrcRsTgazQrpTTnzr6ZeURc3pv0';
        
        // Gemini AI Configuration (Replace with your actual API key)
        const GEMINI_API_KEY = 'YOUR_GEMINI_API_KEY';
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`;
        
        // Initialize Supabase
        let supabase;
        let realtimeChannels = [];

        // Auto logout variables
        let inactivityTimer;
        let logoutWarningTimer;
        let sessionTimer;
        const LOGOUT_TIME = 30 * 60 * 1000; // 30 minutes
        const WARNING_TIME = 2 * 60 * 1000; // 2 minutes warning
        let sessionTimeLeft = LOGOUT_TIME;

        // Global State - ALL VALUES START AT 0
        let state = {
            brands: [],
            messages: [],
            user: { role: 'cfo', name: 'CFO' },
            financialData: {
                revenue: 0,
                profit: 0,
                cashFlow: 0,
                roi: 0
            },
            spreadsheetData: []
        };

        //  AUTHENTICATION SECURITY FUNCTIONS
        async function checkAuthentication() {
            updateAuthStatus('Initializing security...');
            
            try {
                // Initialize Supabase
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                updateAuthStatus('Checking session...');
                
                // Check if user has valid session
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    console.error('Session check error:', error);
                    showAccessDenied();
                    return;
                }
                
                if (!session) {
                    console.log('No valid session found');
                    showAccessDenied();
                    return;
                }
                
                // Verify CFO role
                const userEmail = session.user.email;
                updateAuthStatus('Verifying CFO access...');
                
                if (!userEmail.includes('cfo@')) {
                    console.log('Access denied: Not a CFO account');
                    showAccessDenied();
                    return;
                }
                
                // Authentication successful - show portal
                showPortal();
                initializeUserSession(userEmail);
                
            } catch (error) {
                console.error('Authentication error:', error);
                showAccessDenied();
            }
        }

        function showAccessDenied() {
            document.getElementById('authCheckScreen').classList.add('hidden');
            document.getElementById('accessDeniedScreen').classList.remove('hidden');
        }

        function showPortal() {
            document.getElementById('authCheckScreen').classList.add('hidden');
            document.getElementById('portalContent').classList.remove('hidden');
            document.getElementById('loadingScreen').classList.remove('hidden');
            
            // Initialize portal functionality
            initializePortal();
        }

        function initializeUserSession(email) {
            // Update UI with user info
            document.getElementById('userEmail').textContent = email;
            document.getElementById('mobileUserEmail').textContent = email;
            
            // Set up auto-greeting
            setupAutoGreeting();
            
            // Start session timer display
            updateSessionTimer();
            sessionTimer = setInterval(updateSessionTimer, 1000);
        }

        //  AUTO GREETING FUNCTIONALITY
        function setupAutoGreeting() {
            const now = new Date();
            const hour = now.getHours();
            let greeting = '';
            let subtext = '';

            if (hour < 12) {
                greeting = 'Good morning, CFO!';
                subtext = 'Ready to analyze today\'s financial performance?';
            } else if (hour < 17) {
                greeting = 'Good afternoon, CFO!';
                subtext = 'How\'s the financial landscape looking today?';
            } else if (hour < 21) {
                greeting = 'Good evening, CFO!';
                subtext = 'Working late on financial analysis?';
            } else {
                greeting = 'Working late hours, CFO?';
                subtext = 'Don\'t forget to take breaks during your financial review!';
            }

            // Update greeting elements
            document.getElementById('greetingMessage').textContent = greeting;
            document.getElementById('greetingSubtext').textContent = subtext;

            // Show appropriate status based on time
            if (hour >= 21 || hour < 6) {
                document.getElementById('portalStatus').textContent = 'Late Hours Mode';
                document.getElementById('portalStatus').classList.add('text-yellow-300');
            }
        }

        function updateSessionTimer() {
            const minutes = Math.floor(sessionTimeLeft / 60000);
            const seconds = Math.floor((sessionTimeLeft % 60000) / 1000);
            const timerText = `Session: ${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            document.getElementById('sessionTimer').textContent = timerText;
            document.getElementById('mobileSessionTimer').textContent = timerText;
            
            sessionTimeLeft -= 1000;
            
            if (sessionTimeLeft <= 0) {
                clearInterval(sessionTimer);
            }
        }

        function redirectToLogin() {
            window.location.href = 'index.html';
        }

        //  AUTO LOGOUT SYSTEM
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            clearTimeout(logoutWarningTimer);
            sessionTimeLeft = LOGOUT_TIME;
            
            // Set the main logout timer
            inactivityTimer = setTimeout(showLogoutWarning, LOGOUT_TIME);
        }

        function showLogoutWarning() {
            const modal = document.getElementById('autoLogoutModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            let timeLeft = WARNING_TIME / 1000;
            const timeRemainingEl = document.getElementById('timeRemaining');
            const progressBar = document.getElementById('timeoutProgress');
            
            logoutWarningTimer = setInterval(() => {
                timeLeft--;
                
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timeRemainingEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                const progressPercent = (timeLeft / (WARNING_TIME / 1000)) * 100;
                progressBar.style.width = `${progressPercent}%`;
                
                if (timeLeft <= 0) {
                    clearInterval(logoutWarningTimer);
                    signOut();
                }
            }, 1000);
            
            // Setup modal buttons
            document.getElementById('cancelLogout').onclick = function() {
                clearInterval(logoutWarningTimer);
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                resetInactivityTimer();
                showNotification('Session extended', 'success');
            };
            
            document.getElementById('confirmLogout').onclick = function() {
                clearInterval(logoutWarningTimer);
                signOut();
            };
        }

        function setupActivityListeners() {
            const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
            events.forEach(event => {
                document.addEventListener(event, resetInactivityTimer, false);
            });
        }

        //  LOGOUT FUNCTION
        async function signOut() {
            showNotification('Signing out...', 'info');
            
            // Clean up real-time connections
            realtimeChannels.forEach(channel => {
                if (channel && channel.unsubscribe) {
                    channel.unsubscribe();
                }
            });
            
            // Clear all timers
            clearTimeout(inactivityTimer);
            clearTimeout(logoutWarningTimer);
            clearInterval(sessionTimer);
            
            // Sign out from Supabase
            if (supabase) {
                try {
                    await supabase.auth.signOut();
                } catch (error) {
                    console.error('Sign out error:', error);
                }
            }
            
            // Clear local storage
            sessionStorage.clear();
            localStorage.clear();
            
            // Redirect to login
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1000);
        }

        //  PORTAL FUNCTIONALITY
        async function initializePortal() {
            updateLoadingStatus('Initializing AI CFO Portal...');
            
            try {
                updateLoadingStatus('Setting up real-time connections...');
                await setupRealtimeConnections();
                
                updateLoadingStatus('Loading financial data...');
                await loadInitialData();
                
                // Initialize financial statements with $0 values
                initializePLStatement();
                initializeSpreadsheet();
                
                // Show main content
                document.getElementById('loadingScreen').classList.add('hidden');
                
                showNotification('AI CFO Portal loaded successfully! Financial data will update when Admin uploads information.', 'success');
                
            } catch (error) {
                console.error('Portal initialization failed:', error);
                updateLoadingStatus('Using offline mode...');
                
                setTimeout(() => {
                    document.getElementById('loadingScreen').classList.add('hidden');
                    loadZeroData();
                    showNotification('Running in offline mode - waiting for Admin data', 'warning');
                }, 2000);
            }
        }

        // REAL-TIME CONNECTIONS
        async function setupRealtimeConnections() {
            if (!supabase) return;

            try {
                // Real-time messages
                const messagesChannel = supabase
                    .channel('cfo-executive-messages')
                    .on('postgres_changes', 
                        { 
                            event: 'INSERT', 
                            schema: 'public', 
                            table: 'messages',
                            filter: 'receiver=in.(all,cfo,admin,ceo)'
                        }, 
                        (payload) => {
                            if (payload.new.sender !== 'CFO') {
                                state.messages.unshift(payload.new);
                                updateMessages();
                                
                                if (payload.new.sender === 'CEO' || payload.new.sender === 'Admin') {
                                    showNotification(`New message from ${payload.new.sender}`, 'info');
                                    playNotificationSound();
                                }
                            }
                        }
                    )
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            document.getElementById('aiStatus').textContent = 'AI Active';
                            document.getElementById('connectionStatus').style.background = '#10b981';
                            document.getElementById('syncStatus').textContent = 'Connected to CEO & Admin';
                        }
                    });

                realtimeChannels.push(messagesChannel);

                // Real-time brands data - will update when Admin adds data
                const brandsChannel = supabase
                    .channel('cfo-brands-data')
                    .on('postgres_changes', 
                        { 
                            event: '*', 
                            schema: 'public', 
                            table: 'brands' 
                        }, 
                        async (payload) => {
                            console.log(' Brands data updated by Admin:', payload);
                            await loadBrandsData();
                            showNotification('Financial data updated from Admin!', 'success');
                        }
                    )
                    .subscribe();

                realtimeChannels.push(brandsChannel);

            } catch (error) {
                console.error('Real-time setup failed:', error);
            }
        }

        // DATA MANAGEMENT FUNCTIONS
        async function loadInitialData() {
            await loadMessages();
            await loadBrandsData();
        }

        async function loadMessages() {
            if (!supabase) {
                loadDemoMessages();
                return;
            }

            try {
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select('*')
                    .or('receiver.eq.all,receiver.eq.cfo,receiver.eq.admin,receiver.eq.ceo')
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) throw error;
                state.messages = messages || [];
                updateMessages();
                
            } catch (error) {
                console.error('Error loading messages:', error);
                loadDemoMessages();
            }
        }

        async function loadBrandsData() {
            if (!supabase) {
                return;
            }

            try {
                const { data: brands, error } = await supabase
                    .from('brands')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                
                // Update state with brands data (will be empty initially)
                state.brands = brands || [];
                
                if (state.brands.length > 0) {
                    // Calculate financial metrics when Admin adds data
                    calculateFinancialMetrics();
                    showNotification(`Loaded ${state.brands.length} brands from Admin`, 'success');
                }
                
            } catch (error) {
                console.error('Error loading brands:', error);
            }
        }

        // FINANCIAL CALCULATIONS - Only runs when Admin adds data
        function calculateFinancialMetrics() {
            let totalRevenue = 0;
            let totalViews = 0;

            // Calculate from actual brand data
            state.brands.forEach(brand => {
                const views28d = brand.views_28d || 0;
                totalViews += views28d;
                totalRevenue += (views28d / 1000) * 0.12; // RPM calculation
            });

            const operatingCosts = totalRevenue * 0.65;
            const netProfit = totalRevenue - operatingCosts;
            const profitMargin = totalRevenue > 0 ? (netProfit / totalRevenue) * 100 : 0;
            const cashFlow = netProfit * 0.85;

            // Update UI with actual calculations
            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('netProfit').textContent = formatCurrency(netProfit);
            document.getElementById('cashFlow').textContent = formatCurrency(cashFlow);
            document.getElementById('roi').textContent = `${profitMargin.toFixed(1)}%`;

            // Update growth indicators
            const revenueElement = document.querySelector('#totalRevenue + .flex.items-center');
            if (revenueElement) {
                revenueElement.innerHTML = `<i class="fas fa-arrow-up mr-1"></i><span>${totalRevenue > 0 ? 'Calculated' : '0%'}</span><span class="ml-2 opacity-80">from brand data</span>`;
            }

            // Store for AI analysis
            state.financialData.revenue = totalRevenue;
            state.financialData.profit = netProfit;
            state.financialData.cashFlow = cashFlow;
            state.financialData.roi = profitMargin;

            // Update AI status
            document.getElementById('aiStatus').textContent = 'AI Analyzing Data';
            document.getElementById('aiStatus').classList.remove('text-gray-600');
            document.getElementById('aiStatus').classList.add('text-green-600');
        }

        // FINANCIAL STATEMENTS - Start with $0 values
        function initializePLStatement() {
            // Keep empty state until Admin adds data
            const tbody = document.getElementById('plStatementBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center py-8">
                        <div class="empty-state">
                            <i class="fas fa-file-invoice-dollar text-4xl text-gray-400 mb-4"></i>
                            <div class="text-gray-600 font-semibold mb-2">No Financial Data Available</div>
                            <div class="text-sm text-gray-500">Waiting for Admin to upload financial data</div>
                        </div>
                    </td>
                </tr>
            `;
        }

        function initializeSpreadsheet() {
            // Start with empty spreadsheet
            state.spreadsheetData = [];
            calculateTotals();
        }

        function updateSpreadsheet(index, field, value) {
            if (field === 'budget' || field === 'actual') {
                value = parseFloat(value) || 0;
            }
            state.spreadsheetData[index][field] = value;
            calculateTotals();
        }

        function addRow() {
            state.spreadsheetData.push({
                account: 'New Account',
                budget: 0,
                actual: 0
            });
            updateSpreadsheetUI();
            showNotification('New row added to spreadsheet', 'success');
        }

        function deleteRow(index) {
            state.spreadsheetData.splice(index, 1);
            updateSpreadsheetUI();
            showNotification('Row deleted from spreadsheet', 'info');
        }

        function updateSpreadsheetUI() {
            const tbody = document.getElementById('spreadsheetBody');
            
            if (state.spreadsheetData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-8">
                            <div class="empty-state">
                                <i class="fas fa-table text-4xl text-gray-400 mb-4"></i>
                                <div class="text-gray-600 font-semibold mb-2">No Spreadsheet Data</div>
                                <div class="text-sm text-gray-500">Add rows to start tracking financial data</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = state.spreadsheetData.map((item, index) => {
                const variance = item.actual - item.budget;
                const variancePercent = item.budget !== 0 ? (variance / item.budget) * 100 : 0;
                const isPositive = variance >= 0;
                
                return `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-2"><input type="text" value="${item.account}" class="w-full p-1 border rounded" onchange="updateSpreadsheet(${index}, 'account', this.value)"></td>
                    <td class="py-2"><input type="number" value="${item.budget}" class="w-full p-1 border rounded text-right" onchange="updateSpreadsheet(${index}, 'budget', this.value)"></td>
                    <td class="py-2"><input type="number" value="${item.actual}" class="w-full p-1 border rounded text-right" onchange="updateSpreadsheet(${index}, 'actual', this.value)"></td>
                    <td class="py-2 text-right ${isPositive ? 'text-green-600' : 'text-red-600'}">${isPositive ? '+' : ''}${formatCurrency(variance)}</td>
                    <td class="py-2 text-right ${isPositive ? 'text-green-600' : 'text-red-600'}">${isPositive ? '+' : ''}${variancePercent.toFixed(1)}%</td>
                    <td class="py-2 text-center">
                        <button onclick="deleteRow(${index})" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                `;
            }).join('');
            
            calculateTotals();
        }

        function calculateTotals() {
            let totalBudget = 0;
            let totalActual = 0;
            
            state.spreadsheetData.forEach(item => {
                totalBudget += item.budget;
                totalActual += item.actual;
            });
            
            const totalVariance = totalActual - totalBudget;
            const totalVariancePercent = totalBudget !== 0 ? (totalVariance / totalBudget) * 100 : 0;
            
            document.getElementById('totalBudget').textContent = formatCurrency(totalBudget);
            document.getElementById('totalActual').textContent = formatCurrency(totalActual);
            document.getElementById('totalVariance').textContent = formatCurrency(totalVariance);
            document.getElementById('totalVariancePercent').textContent = `${totalVariancePercent.toFixed(1)}%`;
            
            // Update color based on variance
            const varianceElement = document.getElementById('totalVariance');
            const percentElement = document.getElementById('totalVariancePercent');
            
            if (totalVariance >= 0) {
                varianceElement.className = 'text-right py-3 text-green-600 font-semibold';
                percentElement.className = 'text-right py-3 text-green-600 font-semibold';
            } else {
                varianceElement.className = 'text-right py-3 text-red-600 font-semibold';
                percentElement.className = 'text-right py-3 text-red-600 font-semibold';
            }
        }

        // AI INTEGRATION
        async function generateAIInsight(type) {
            const aiOutput = document.getElementById('aiOutput');
            
            aiOutput.innerHTML = `
                <div class="flex flex-col items-center justify-center py-8">
                    <div class="w-12 h-12 border-4 border-purple-600 border-t-transparent rounded-full animate-spin mb-4"></div>
                    <div class="text-purple-600 font-semibold">AI Analyzing Financial Data...</div>
                </div>
            `;

            try {
                // In a real implementation, you would call the Gemini API here
                // For demo purposes, we'll simulate the API call
                setTimeout(() => {
                    const insights = {
                        revenue: state.financialData.revenue > 0 ? [
                            " Revenue Analysis: Your Q3 revenue shows strong performance.",
                            ` Current revenue: ${formatCurrency(state.financialData.revenue)}`,
                            " Areas for improvement: Consider expanding to new markets",
                            " Recommendation: Focus on high-margin product lines"
                        ] : [
                            " Revenue Analysis: No revenue data available yet.",
                            " Waiting for Admin to upload brand performance data",
                            " Financial metrics will update automatically",
                            " Suggestion: Contact Admin to upload CSV data"
                        ],
                        profitability: state.financialData.profit > 0 ? [
                            " Profitability Analysis: Strong margins detected",
                            ` Current profit: ${formatCurrency(state.financialData.profit)}`,
                            " Well-controlled operating expenses",
                            " Opportunity: Further optimize supply chain"
                        ] : [
                            " Profitability Analysis: No profit data available",
                            " Waiting for financial data from Admin",
                            " Profit calculations will appear here",
                            " Check back after Admin uploads data"
                        ]
                    };

                    aiOutput.innerHTML = (insights[type] || insights.revenue).map(insight => `
                        <div class="ai-insight fade-in">
                            <div class="text-sm font-medium text-gray-900">${insight}</div>
                        </div>
                    `).join('');

                    showNotification(`AI ${type} analysis completed!`, 'success');
                }, 2000);

            } catch (error) {
                console.error('AI analysis error:', error);
                aiOutput.innerHTML = `
                    <div class="ai-insight fade-in">
                        <div class="text-sm font-medium text-gray-900"> AI service temporarily unavailable. Using cached insights.</div>
                    </div>
                `;
                showNotification('AI service issue - using fallback data', 'warning');
            }
        }

        function generateQuickAdvice() {
            const aiOutput = document.getElementById('aiOutput');
            aiOutput.innerHTML = `
                <div class="flex flex-col items-center justify-center py-8">
                    <div class="w-12 h-12 border-4 border-purple-600 border-t-transparent rounded-full animate-spin mb-4"></div>
                    <div class="text-purple-600 font-semibold">Generating Quick Financial Advice...</div>
                </div>
            `;

            setTimeout(() => {
                if (state.financialData.revenue > 0) {
                    aiOutput.innerHTML = `
                        <div class="ai-insight fade-in">
                            <div class="text-sm font-medium text-gray-900"> Immediate Opportunity: Optimize working capital management</div>
                        </div>
                        <div class="ai-insight fade-in">
                            <div class="text-sm font-medium text-gray-900"> Growth Focus: Expand into complementary product lines</div>
                        </div>
                        <div class="ai-insight fade-in">
                            <div class="text-sm font-medium text-gray-900"> Risk Management: Review currency exposure for international sales</div>
                        </div>
                    `;
                } else {
                    aiOutput.innerHTML = `
                        <div class="ai-insight fade-in">
                            <div class="text-sm font-medium text-gray-900"> Quick Advice: Contact Admin to upload brand performance data</div>
                        </div>
                        <div class="ai-insight fade-in">
                            <div class="text-sm font-medium text-gray-900"> Once data is available, I'll provide specific recommendations</div>
                        </div>
                        <div class="ai-insight fade-in">
                            <div class="text-sm font-medium text-gray-900"> Financial metrics update automatically when data is added</div>
                        </div>
                    `;
                }
                showNotification('AI financial advice generated!', 'success');
            }, 1500);
        }

        function generateAIReport() {
            if (state.financialData.revenue > 0) {
                showNotification('Generating comprehensive AI financial report...', 'info');
                setTimeout(() => {
                    showNotification('AI financial report generated and saved!', 'success');
                }, 3000);
            } else {
                showNotification('Need financial data from Admin to generate report', 'warning');
            }
        }

        // MESSAGING SYSTEM
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            const recipient = document.getElementById('recipientSelect').value;

            if (!message) {
                showNotification('Please enter a message', 'error');
                return;
            }

            const messageData = {
                sender: 'CFO',
                receiver: recipient,
                message: message,
                read: false,
                created_at: new Date().toISOString()
            };

            state.messages.unshift(messageData);
            updateMessages();
            messageInput.value = '';

            if (supabase) {
                try {
                    const { error } = await supabase.from('messages').insert([messageData]);
                    if (error) throw error;
                    showNotification('Message sent to executives!', 'success');
                } catch (error) {
                    console.error('Failed to save message:', error);
                    showNotification('Message sent locally (connection issue)', 'warning');
                }
            } else {
                showNotification('Message sent (offline mode)', 'info');
            }
        }

        function updateMessages() {
            const container = document.getElementById('messagesContainer');
            const messageCount = document.getElementById('messageCount');
            
            if (!state.messages.length) {
                container.innerHTML = '<div class="text-center text-gray-500 text-sm py-4">No messages yet</div>';
                messageCount.textContent = '0 messages';
                return;
            }

            container.innerHTML = state.messages.map(msg => {
                let messageClass = 'message-other';
                if (msg.sender === 'CEO') messageClass = 'message-ceo';
                if (msg.sender === 'CFO') messageClass = 'message-cfo';
                if (msg.sender === 'Admin') messageClass = 'message-admin';
                
                return `
                <div class="${messageClass} fade-in">
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-semibold text-sm">${msg.sender}</span>
                        <span class="text-xs opacity-80">${formatTime(msg.created_at)}</span>
                    </div>
                    <div class="text-sm">${msg.message}</div>
                    ${msg.receiver !== 'all' ? `<div class="text-xs opacity-80 mt-1">To: ${msg.receiver}</div>` : ''}
                </div>
                `;
            }).join('');

            messageCount.textContent = `${state.messages.length} messages`;
            container.scrollTop = container.scrollHeight;
        }

        // EXPORT FUNCTIONS
        function exportPLStatement() {
            if (state.financialData.revenue > 0) {
                showNotification('Exporting Profit & Loss statement...', 'info');
                setTimeout(() => {
                    showNotification('P&L statement exported successfully!', 'success');
                }, 1500);
            } else {
                showNotification('No financial data available to export', 'warning');
            }
        }

        function exportSpreadsheet() {
            if (state.spreadsheetData.length > 0) {
                showNotification('Exporting financial spreadsheet...', 'info');
                setTimeout(() => {
                    showNotification('Spreadsheet exported successfully!', 'success');
                }, 1500);
            } else {
                showNotification('No spreadsheet data available to export', 'warning');
            }
        }

        function generatePLReport() {
            if (state.financialData.revenue > 0) {
                showNotification('Generating P&L report with AI insights...', 'info');
                setTimeout(() => {
                    showNotification('P&L report updated with latest data!', 'success');
                }, 2000);
            } else {
                showNotification('Waiting for Admin to upload financial data', 'info');
            }
        }

        function generateBalanceSheet() {
            showNotification('Updating balance sheet...', 'info');
            setTimeout(() => {
                showNotification('Balance sheet updated!', 'success');
            }, 1500);
        }

        // ZERO DATA STATE
        function loadZeroData() {
            // All values remain at 0
            document.getElementById('totalRevenue').textContent = '$0';
            document.getElementById('netProfit').textContent = '$0';
            document.getElementById('cashFlow').textContent = '$0';
            document.getElementById('roi').textContent = '0%';
            
            initializePLStatement();
            initializeSpreadsheet();
        }

        function loadDemoMessages() {
            state.messages = [
                { 
                    sender: 'CEO', 
                    receiver: 'all', 
                    message: 'Welcome to the executive network! Let me know when you have the financial overview ready.', 
                    created_at: new Date().toISOString() 
                },
                { 
                    sender: 'Admin', 
                    receiver: 'cfo', 
                    message: 'I will upload the brand performance data shortly. The portal will update automatically.', 
                    created_at: new Date(Date.now() - 300000).toISOString() 
                },
                { 
                    sender: 'System', 
                    receiver: 'cfo', 
                    message: 'Financial metrics will appear here once Admin uploads data to the system.', 
                    created_at: new Date(Date.now() - 600000).toISOString() 
                }
            ];
            updateMessages();
        }

        // UTILITY FUNCTIONS
        function updateAuthStatus(message) {
            const statusEl = document.getElementById('authStatus');
            if (statusEl) statusEl.textContent = message;
        }

        function updateLoadingStatus(message) {
            const statusEl = document.getElementById('loadingStatus');
            if (statusEl) statusEl.textContent = message;
        }

        function formatCurrency(amount) {
            if (amount === 0) return '$0';
            if (amount >= 1000000) {
                return '$' + (amount / 1000000).toFixed(1) + 'M';
            } else if (amount >= 1000) {
                return '$' + (amount / 1000).toFixed(0) + 'K';
            }
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        function formatTime(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            
            return date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 fade-in ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                type === 'warning' ? 'bg-yellow-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (error) {
                console.log('Audio notification not supported');
            }
        }

        function toggleTheme() {
            const body = document.body;
            if (body.classList.contains('bg-gray-50')) {
                body.className = 'bg-gray-900 text-white min-h-screen';
                showNotification('Dark theme activated', 'info');
            } else {
                body.className = 'bg-gray-50 min-h-screen';
                showNotification('Light theme activated', 'info');
            }
        }

        // MOBILE MENU FUNCTIONALITY
        function setupMobileMenu() {
            const mobileMenuButton = document.getElementById('mobileMenuButton');
            const mobileMenu = document.getElementById('mobileMenu');
            
            if (mobileMenuButton && mobileMenu) {
                mobileMenuButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    mobileMenu.classList.toggle('hidden');
                });
                
                // Close mobile menu when clicking outside
                document.addEventListener('click', function(event) {
                    if (!mobileMenu.contains(event.target) && !mobileMenuButton.contains(event.target)) {
                        mobileMenu.classList.add('hidden');
                    }
                });
            }
        }

        // CLEANUP ON PAGE UNLOAD
        window.addEventListener('beforeunload', () => {
            realtimeChannels.forEach(channel => {
                if (channel && channel.unsubscribe) {
                    channel.unsubscribe();
                }
            });
            
            clearTimeout(inactivityTimer);
            clearTimeout(logoutWarningTimer);
            clearInterval(sessionTimer);
        });

        // INITIALIZE APPLICATION
        document.addEventListener('DOMContentLoaded', function() {
            // Start authentication check
            checkAuthentication();
            
            // Setup mobile menu
            setupMobileMenu();
            
            // Setup activity listeners for auto-logout
            setupActivityListeners();
        });
    </script>
</body>
                    </html>
