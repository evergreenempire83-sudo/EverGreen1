<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EverGreen Empire â€” CFO Portal</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-ceo {
            background: linear-gradient(135deg, #1e40af, #3730a3);
            color: white;
            border-radius: 12px;
            padding: 12px;
            margin: 8px 0;
        }

        .message-cfo {
            background: linear-gradient(135deg, #059669, #047857);
            color: white;
            border-radius: 12px;
            padding: 12px;
            margin: 8px 0;
        }

        .message-admin {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
            color: white;
            border-radius: 12px;
            padding: 12px;
            margin: 8px 0;
        }

        .ai-insight {
            border-left: 4px solid #8b5cf6;
            background: linear-gradient(135deg, #faf5ff, #f3e8ff);
            padding: 16px;
            border-radius: 8px;
            margin: 8px 0;
        }

        .online-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .empty-state {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Simple Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-green-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <div class="text-xl font-semibold text-gray-800">CFO Portal</div>
            <div class="text-sm text-gray-600 mt-2" id="loadingStatus">Connecting to executive network...</div>
        </div>
    </div>

    <!-- Simple Header -->
    <header class="bg-green-800 text-white p-4 sticky top-0 z-40 shadow-lg">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 rounded-lg bg-white/20 flex items-center justify-center">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold">EverGreen Empire</h1>
                    <p class="text-sm opacity-90">CFO Portal <span id="connectionStatus" class="online-dot"></span> <span id="syncStatus" class="text-xs">Connecting...</span></p>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <button onclick="toggleTheme()" class="p-2 rounded-lg bg-white/10 hover:bg-white/20">
                    <i class="fas fa-palette"></i>
                </button>
                <button onclick="generateQuickAdvice()" class="p-2 rounded-lg bg-purple-600 hover:bg-purple-700">
                    <i class="fas fa-robot"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto p-4" id="mainContent" style="display: none;">
        <!-- Welcome Banner -->
        <div class="bg-white rounded-lg p-4 shadow-sm border mb-4">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-bold text-gray-800 mb-1">Financial Command Center</h2>
                    <p class="text-sm text-gray-600">Connected to CEO & Admin - Real-time Executive Network</p>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="text-right">
                        <div class="text-xs text-gray-600">Network Status</div>
                        <div class="text-sm font-bold text-green-600" id="networkStatus">Live</div>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center">
                        <i class="fas fa-network-wired text-green-600 text-lg"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Financial KPIs -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
            <div class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-base font-bold">Total Revenue</h3>
                    <i class="fas fa-dollar-sign text-lg opacity-80"></i>
                </div>
                <div class="text-2xl font-bold mb-1" id="totalRevenue">$0.00</div>
                <div class="flex items-center text-xs">
                    <i class="fas fa-minus mr-1"></i>
                    <span>0%</span>
                    <span class="ml-2 opacity-80">Waiting for data</span>
                </div>
            </div>

            <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-base font-bold">Profit Margin</h3>
                    <i class="fas fa-percentage text-lg opacity-80"></i>
                </div>
                <div class="text-2xl font-bold mb-1" id="profitMargin">0%</div>
                <div class="text-xs opacity-80">Waiting for data</div>
            </div>

            <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-base font-bold">Op. Costs</h3>
                    <i class="fas fa-money-bill-wave text-lg opacity-80"></i>
                </div>
                <div class="text-2xl font-bold mb-1" id="operatingCosts">$0.00</div>
                <div class="text-xs opacity-80">Waiting for data</div>
            </div>

            <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 text-white rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-base font-bold">Cash Flow</h3>
                    <i class="fas fa-exchange-alt text-lg opacity-80"></i>
                </div>
                <div class="text-2xl font-bold mb-1" id="cashFlow">$0.00</div>
                <div class="text-xs opacity-80">Waiting for data</div>
            </div>
        </div>

        <!-- AI Insights & Communications -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
            <!-- AI Financial Advisor -->
            <div class="bg-white rounded-lg p-4 shadow-sm border">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-base font-bold flex items-center">
                        <i class="fas fa-robot mr-2 text-purple-500"></i>AI Financial Advisor
                    </h3>
                    <span class="text-xs text-green-600 bg-green-100 px-2 py-1 rounded-full">Online</span>
                </div>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="generateAIInsight('revenue')" class="bg-green-600 hover:bg-green-700 text-white p-2 rounded-lg text-sm transition-all">
                             Revenue
                        </button>
                        <button onclick="generateAIInsight('profitability')" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg text-sm transition-all">
                             Profitability
                        </button>
                        <button onclick="generateAIInsight('costs')" class="bg-purple-600 hover:bg-purple-700 text-white p-2 rounded-lg text-sm transition-all">
                             Cost Analysis
                        </button>
                        <button onclick="generateAIInsight('investment')" class="bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded-lg text-sm transition-all">
                             Investments
                        </button>
                    </div>
                    <div id="aiOutput" class="min-h-[200px] max-h-[300px] overflow-y-auto p-3 bg-gray-50 rounded-lg border">
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-robot text-2xl mb-2 text-purple-500"></i>
                            <div class="text-sm">Select an analysis type to get AI insights</div>
                            <div class="text-xs mt-1">Powered by Google Gemini</div>
                        </div>
                    </div>
                    <button onclick="generateQuickAdvice()" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-2 rounded-lg hover:from-purple-700 hover:to-indigo-700 transition-all text-sm">
                        <i class="fas fa-bolt mr-1"></i>Quick Financial Advice
                    </button>
                </div>
            </div>

            <!-- Real-time Executive Communications -->
            <div class="bg-white rounded-lg p-4 shadow-sm border">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-base font-bold">Executive Communications</h3>
                    <div class="flex items-center text-xs text-green-600">
                        <span class="online-dot"></span>
                        <span>Live with CEO & Admin</span>
                    </div>
                </div>
                <div class="space-y-3">
                    <div class="flex flex-col space-y-2">
                        <input type="text" id="messageInput" placeholder="Type your message to CEO or Admin..." class="w-full p-2 border rounded-lg text-sm">
                        <select id="recipientSelect" class="w-full p-2 border rounded-lg text-sm">
                            <option value="all">All Executives (CEO & Admin)</option>
                            <option value="ceo">CEO Only</option>
                            <option value="admin">Admin Team Only</option>
                            <option value="cfo">CFO Team Only</option>
                        </select>
                        <button onclick="sendMessage()" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-all">
                            <i class="fas fa-paper-plane mr-1"></i>Send Message
                        </button>
                    </div>
                    <div id="messagesContainer" class="max-h-48 overflow-y-auto space-y-2 border rounded-lg p-2">
                        <div class="text-center text-gray-500 text-sm py-4">Loading executive messages...</div>
                    </div>
                    <div class="flex items-center justify-between text-xs text-gray-500">
                        <span>Connected to: CEO, Admin, CFO</span>
                        <span id="messageCount">0 messages</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="bg-white rounded-lg p-4 shadow-sm border">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-base font-bold">Brand Performance</h3>
                <div class="flex space-x-2">
                    <button onclick="loadBrandsData()" class="bg-green-600 text-white px-3 py-1 rounded-lg hover:bg-green-700 transition-all text-sm">
                        <i class="fas fa-sync-alt mr-1"></i>Refresh
                    </button>
                    <button onclick="exportData()" class="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 transition-all text-sm">
                        <i class="fas fa-download mr-1"></i>Export
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full min-w-[600px]">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left py-2 font-semibold text-sm">Brand</th>
                            <th class="text-left py-2 font-semibold text-sm">28D Revenue</th>
                            <th class="text-left py-2 font-semibold text-sm">Est. Profit</th>
                            <th class="text-left py-2 font-semibold text-sm">ROI</th>
                            <th class="text-left py-2 font-semibold text-sm">Trend</th>
                            <th class="text-left py-2 font-semibold text-sm">Last Updated</th>
                        </tr>
                    </thead>
                    <tbody id="brandsTableBody">
                        <tr>
                            <td colspan="6" class="text-center py-4 text-gray-500">Loading brand data from Admin...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // Same Supabase configuration as CEO and Admin portals
        const SUPABASE_URL = 'https://clhaquwjevqdzjobthdz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsaGFxdXdqZXZxZHpqb2J0aGR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwNjYxODMsImV4cCI6MjA3NjY0MjE4M30.Ns2raXXMNPAveuogHrcRsTgazQrpTTnzr6ZeURc3pv0';
        
        // Initialize Supabase (same as CEO and Admin)
        let supabase;
        let realtimeChannels = [];

        // Global State - START WITH ZERO DATA
        let state = {
            brands: [], // Empty array - no brands until Admin adds them
            messages: [],
            user: { role: 'cfo', name: 'CFO' },
            totalRevenue: 0,
            profitMargin: 0,
            operatingCosts: 0,
            cashFlow: 0
        };

        // Update loading status
        function updateLoadingStatus(message) {
            const statusEl = document.getElementById('loadingStatus');
            if (statusEl) {
                statusEl.textContent = message;
            }
            console.log('Loading:', message);
        }

        // Initialize Application
        async function init() {
            console.log(' Initializing CFO Portal with Real-time Executive Network...');
            updateLoadingStatus('Connecting to Supabase database...');

            try {
                // Initialize Supabase (same connection as CEO and Admin)
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log(' Supabase connected successfully');
                
                updateLoadingStatus('Setting up real-time messaging...');
                
                // Setup real-time connections to CEO and Admin
                await setupRealtimeConnections();
                
                // Load initial data - will be empty until Admin adds data
                await loadInitialData();
                
                // Show main content
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                
                showNotification('Connected to CEO & Admin executive network!', 'success');
                
            } catch (error) {
                console.error(' Initialization failed:', error);
                updateLoadingStatus('Using offline mode - some features limited');
                
                // Fallback: Show main content with ZERO data
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    loadZeroData();
                    showNotification('Running in offline mode - real-time features disabled', 'warning');
                }, 2000);
            }
        }

        // REAL-TIME CONNECTION TO CEO & ADMIN
        async function setupRealtimeConnections() {
            if (!supabase) {
                console.log(' Supabase not available - real-time features disabled');
                document.getElementById('networkStatus').textContent = 'Offline';
                document.getElementById('connectionStatus').style.background = '#ef4444';
                return;
            }

            updateLoadingStatus('Connecting to CEO & Admin real-time channels...');

            try {
                // REAL-TIME MESSAGES - Connect to same messages table as CEO and Admin
                const messagesChannel = supabase
                    .channel('cfo-executive-messages')
                    .on('postgres_changes', 
                        { 
                            event: 'INSERT', 
                            schema: 'public', 
                            table: 'messages',
                            filter: 'receiver=in.(all,cfo,admin,ceo)'
                        }, 
                        (payload) => {
                            console.log(' New executive message:', payload);
                            
                            // Add message to state (unless it's our own)
                            if (payload.new.sender !== 'CFO') {
                                state.messages.unshift(payload.new);
                                updateMessages();
                                
                                // Show notification for new messages from CEO or Admin
                                if (payload.new.sender === 'CEO' || payload.new.sender === 'Admin') {
                                    showNotification(`New message from ${payload.new.sender}`, 'info');
                                    playNotificationSound();
                                }
                            }
                        }
                    )
                    .subscribe((status) => {
                        console.log(' Messages subscription status:', status);
                        if (status === 'SUBSCRIBED') {
                            document.getElementById('networkStatus').textContent = 'Live';
                            document.getElementById('connectionStatus').style.background = '#10b981';
                            document.getElementById('syncStatus').textContent = 'Connected to CEO & Admin';
                        }
                    });

                realtimeChannels.push(messagesChannel);

                // REAL-TIME BRANDS DATA - Sync with Admin portal updates
                const brandsChannel = supabase
                    .channel('cfo-brands-data')
                    .on('postgres_changes', 
                        { 
                            event: '*', 
                            schema: 'public', 
                            table: 'brands' 
                        }, 
                        async (payload) => {
                            console.log(' Brands data updated by Admin:', payload);
                            
                            // Refresh brands data when Admin makes changes
                            await loadBrandsData();
                            showNotification('Brand data updated from Admin', 'success');
                        }
                    )
                    .subscribe((status) => {
                        console.log(' Brands subscription status:', status);
                    });

                realtimeChannels.push(brandsChannel);

                updateLoadingStatus('Real-time executive network connected!');

            } catch (error) {
                console.error(' Real-time setup failed:', error);
                document.getElementById('networkStatus').textContent = 'Offline';
                document.getElementById('connectionStatus').style.background = '#ef4444';
            }
        }

        // Load initial data from shared database - WILL BE EMPTY INITIALLY
        async function loadInitialData() {
            updateLoadingStatus('Loading executive messages...');
            await loadMessages();
            
            updateLoadingStatus('Loading brand performance data...');
            await loadBrandsData(); // This will be empty until Admin adds data
            
            // Update financial metrics with actual data (will be 0 initially)
            calculateFinancialMetrics();
        }

        // Load messages from shared database (same as CEO and Admin)
        async function loadMessages() {
            if (!supabase) {
                loadDemoMessages();
                return;
            }

            try {
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select('*')
                    .or('receiver.eq.all,receiver.eq.cfo,receiver.eq.admin,receiver.eq.ceo')
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) throw error;

                state.messages = messages || [];
                updateMessages();
                
            } catch (error) {
                console.error('Error loading messages:', error);
                loadDemoMessages();
            }
        }

        // Load brands data from shared database - STARTS EMPTY
        async function loadBrandsData() {
            if (!supabase) {
                loadZeroData();
                return;
            }

            try {
                const { data: brands, error } = await supabase
                    .from('brands')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // This will be empty array until Admin adds brands
                state.brands = brands || [];
                updateBrandsTable();
                calculateFinancialMetrics(); // Recalculate with new data
                
                if (state.brands.length === 0) {
                    showNotification('No brand data available. Waiting for Admin to upload data.', 'info');
                } else {
                    showNotification(`Loaded ${state.brands.length} brands from Admin`, 'success');
                }
                
            } catch (error) {
                console.error('Error loading brands:', error);
                loadZeroData();
            }
        }

        // Calculate financial metrics based on actual brand data
        function calculateFinancialMetrics() {
            let totalRevenue = 0;
            let totalViews = 0;

            // Calculate from actual brand data (will be 0 if no brands)
            state.brands.forEach(brand => {
                const views28d = brand.views_28d || 0;
                totalViews += views28d;
                totalRevenue += (views28d / 1000) * 0.12; // RPM calculation
            });

            const operatingCosts = totalRevenue * 0.65;
            const netProfit = totalRevenue - operatingCosts;
            const profitMargin = totalRevenue > 0 ? (netProfit / totalRevenue) * 100 : 0;
            const cashFlow = netProfit * 0.85;

            // Update UI with actual calculations
            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('profitMargin').textContent = `${profitMargin.toFixed(1)}%`;
            document.getElementById('operatingCosts').textContent = formatCurrency(operatingCosts);
            document.getElementById('cashFlow').textContent = formatCurrency(cashFlow);

            // Update growth indicator
            const growthElement = document.querySelector('#totalRevenue + .flex.items-center');
            if (growthElement) {
                if (totalRevenue > 0) {
                    growthElement.innerHTML = `<i class="fas fa-arrow-up mr-1"></i><span>${totalRevenue > 0 ? 'Calculated' : '0%'}</span><span class="ml-2 opacity-80">from brand data</span>`;
                } else {
                    growthElement.innerHTML = `<i class="fas fa-minus mr-1"></i><span>0%</span><span class="ml-2 opacity-80">Waiting for data</span>`;
                }
            }

            // Store for AI analysis
            state.totalRevenue = totalRevenue;
            state.profitMargin = profitMargin;
            state.operatingCosts = operatingCosts;
            state.cashFlow = cashFlow;
        }

        // Send message to CEO and Admin
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            const recipient = document.getElementById('recipientSelect').value;

            if (!message) {
                showNotification('Please enter a message', 'error');
                return;
            }

            const messageData = {
                sender: 'CFO',
                receiver: recipient,
                message: message,
                read: false,
                created_at: new Date().toISOString()
            };

            // Add to local state immediately for instant feedback
            state.messages.unshift(messageData);
            updateMessages();
            messageInput.value = '';

            // Save to shared database (CEO and Admin will see it instantly)
            if (supabase) {
                try {
                    const { error } = await supabase.from('messages').insert([messageData]);
                    if (error) throw error;
                    console.log(' Message saved to shared database - CEO & Admin notified');
                    showNotification('Message sent to executives!', 'success');
                } catch (error) {
                    console.error('Failed to save message:', error);
                    showNotification('Message sent locally (connection issue)', 'warning');
                }
            } else {
                showNotification('Message sent (offline mode)', 'info');
            }
        }

        // Update messages UI
        function updateMessages() {
            const container = document.getElementById('messagesContainer');
            const messageCount = document.getElementById('messageCount');
            
            if (!state.messages.length) {
                container.innerHTML = '<div class="text-center text-gray-500 text-sm py-4">No messages yet</div>';
                messageCount.textContent = '0 messages';
                return;
            }

            container.innerHTML = state.messages.map(msg => {
                let messageClass = 'message-other';
                if (msg.sender === 'CEO') messageClass = 'message-ceo';
                if (msg.sender === 'CFO') messageClass = 'message-cfo';
                if (msg.sender === 'Admin') messageClass = 'message-admin';
                
                return `
                <div class="${messageClass} fade-in">
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-semibold text-sm">${msg.sender}</span>
                        <span class="text-xs opacity-80">${formatTime(msg.created_at)}</span>
                    </div>
                    <div class="text-sm">${msg.message}</div>
                    ${msg.receiver !== 'all' ? `<div class="text-xs opacity-80 mt-1">To: ${msg.receiver}</div>` : ''}
                </div>
                `;
            }).join('');

            messageCount.textContent = `${state.messages.length} messages`;
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        // Update brands table - SHOWS EMPTY STATE INITIALLY
        function updateBrandsTable() {
            const tbody = document.getElementById('brandsTableBody');
            
            if (!state.brands.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-8">
                            <div class="empty-state">
                                <i class="fas fa-database text-4xl text-gray-400 mb-4"></i>
                                <div class="text-gray-600 font-semibold mb-2">No Brand Data Available</div>
                                <div class="text-sm text-gray-500 mb-4">Waiting for Admin to upload brand performance data</div>
                                <div class="text-xs text-gray-400">Revenue and metrics will update automatically when data is available</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = state.brands.map(brand => {
                const revenue = (brand.views_28d / 1000) * 0.12;
                const profit = revenue * 0.35; // Assuming 35% profit margin
                const roi = ((profit / (revenue * 0.7)) * 100).toFixed(1);
                const lastUpdated = brand.updated_at ? formatTime(brand.updated_at) : 'Recently';
                
                return `
                <tr class="border-b hover:bg-gray-50 fade-in">
                    <td class="py-2 font-semibold">${brand.name || 'Unknown Brand'}</td>
                    <td class="py-2">${formatCurrency(revenue)}</td>
                    <td class="py-2">${formatCurrency(profit)}</td>
                    <td class="py-2 ${roi > 40 ? 'text-green-600' : 'text-orange-600'}">${roi}%</td>
                    <td class="py-2">
                        <span class="px-2 py-1 rounded-full text-xs ${roi > 40 ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}">
                            ${roi > 40 ? '' : ''}
                        </span>
                    </td>
                    <td class="py-2 text-xs text-gray-500">${lastUpdated}</td>
                </tr>
                `;
            }).join('');
        }

        // ZERO DATA STATE - No demo data, just empty state
        function loadZeroData() {
            state.brands = []; // Empty array
            state.messages = [
                { 
                    sender: 'System', 
                    receiver: 'cfo', 
                    message: 'Welcome! Financial data will appear here when Admin uploads brand information.', 
                    created_at: new Date().toISOString() 
                }
            ];
            updateBrandsTable();
            updateMessages();
            calculateFinancialMetrics(); // This will set everything to 0
        }

        function loadDemoMessages() {
            state.messages = [
                { 
                    sender: 'CEO', 
                    receiver: 'all', 
                    message: 'Need Q3 financial projections by EOD tomorrow.', 
                    created_at: new Date().toISOString() 
                },
                { 
                    sender: 'Admin', 
                    receiver: 'cfo', 
                    message: 'I will upload brand performance data shortly.', 
                    created_at: new Date(Date.now() - 300000).toISOString() 
                },
                { 
                    sender: 'System', 
                    receiver: 'cfo', 
                    message: 'Financial metrics will update when Admin adds brand data.', 
                    created_at: new Date(Date.now() - 600000).toISOString() 
                }
            ];
            updateMessages();
        }

        // Notification sound
        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (error) {
                console.log('Audio notification not supported');
            }
        }

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        function formatTime(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            
            return date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 fade-in ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                type === 'warning' ? 'bg-yellow-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // Theme toggle
        function toggleTheme() {
            const body = document.body;
            if (body.classList.contains('bg-gray-50')) {
                body.className = 'bg-gray-900 text-white min-h-screen';
            } else {
                body.className = 'bg-gray-50 min-h-screen';
            }
        }

        // AI Insights - uses actual financial data (which starts at 0)
        async function generateAIInsight(type) {
            const aiOutput = document.getElementById('aiOutput');
            
            aiOutput.innerHTML = `
                <div class="flex flex-col items-center justify-center py-8">
                    <div class="w-12 h-12 border-4 border-purple-600 border-t-transparent rounded-full animate-spin mb-4"></div>
                    <div class="text-purple-600 font-semibold">Analyzing Financial Data...</div>
                </div>
            `;

            setTimeout(() => {
                // Use actual financial data from state
                const insights = {
                    revenue: [
                        state.totalRevenue > 0 ? 
                        ` Current revenue: ${formatCurrency(state.totalRevenue)} - ${state.brands.length} brands active` :
                        " No revenue data available yet - waiting for Admin to upload brand information",
                        " Revenue tracking will begin when brand data is available",
                        " Ask Admin to upload CSV with brand performance metrics"
                    ],
                    profitability: [
                        state.profitMargin > 0 ?
                        ` Current profit margin: ${state.profitMargin.toFixed(1)}%` :
                        " Profit margin analysis requires brand performance data",
                        " Margin optimization suggestions will appear when data is available",
                        " Contact Admin to set up brand tracking"
                    ]
                };

                aiOutput.innerHTML = (insights[type] || insights.revenue).map(insight => `
                    <div class="ai-insight fade-in">
                        <div class="text-sm font-medium text-gray-900">${insight}</div>
                    </div>
                `).join('');

                showNotification(`${type} analysis completed!`, 'success');
            }, 2000);
        }

        function generateQuickAdvice() {
            if (state.totalRevenue === 0) {
                const aiOutput = document.getElementById('aiOutput');
                aiOutput.innerHTML = `
                    <div class="ai-insight fade-in">
                        <div class="text-sm font-medium text-gray-900"> Quick Advice: Contact Admin to upload brand performance data to start financial tracking</div>
                    </div>
                    <div class="ai-insight fade-in">
                        <div class="text-sm font-medium text-gray-900"> Once data is available, I'll provide revenue optimization suggestions</div>
                    </div>
                    <div class="ai-insight fade-in">
                        <div class="text-sm font-medium text-gray-900"> Financial metrics update automatically when Admin adds new data</div>
                    </div>
                `;
            } else {
                generateAIInsight('revenue');
            }
        }

        function exportData() {
            if (state.brands.length === 0) {
                showNotification('No data available to export', 'warning');
            } else {
                showNotification('Data export started...', 'info');
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            realtimeChannels.forEach(channel => {
                if (channel && channel.unsubscribe) {
                    channel.unsubscribe();
                }
            });
        });

        // Initialize when DOM loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
