<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EverGreen Empire â€” CFO Portal</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-ceo {
            background: linear-gradient(135deg, #1e40af, #3730a3);
            color: white;
            border-radius: 12px;
            padding: 12px;
            margin: 8px 0;
        }

        .message-cfo {
            background: linear-gradient(135deg, #059669, #047857);
            color: white;
            border-radius: 12px;
            padding: 12px;
            margin: 8px 0;
        }

        .message-admin {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
            color: white;
            border-radius: 12px;
            padding: 12px;
            margin: 8px 0;
        }

        .ai-insight {
            border-left: 4px solid #8b5cf6;
            background: linear-gradient(135deg, #faf5ff, #f3e8ff);
            padding: 16px;
            border-radius: 8px;
            margin: 8px 0;
        }

        .online-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .empty-state {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
        }
        
        /* Mobile menu styles */
        .mobile-menu {
            transition: all 0.3s ease;
        }
        
        /* Auto logout modal */
        .logout-modal {
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
        }
        
        /* Responsive table */
        @media (max-width: 768px) {
            .responsive-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
        }
        
        /* New styles for financial tools */
        .metric-card {
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .audio-visualizer {
            height: 4px;
            background: linear-gradient(90deg, #10b981, #3b82f6, #8b5cf6);
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }
        
        .audio-bar {
            height: 100%;
            width: 10%;
            background: white;
            opacity: 0.7;
            border-radius: 2px;
            animation: audioWave 1.5s infinite ease-in-out;
        }
        
        @keyframes audioWave {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(1000%); }
        }
        
        .growth-indicator {
            display: inline-flex;
            align-items: center;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .growth-positive {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .growth-negative {
            background-color: #fee2e2;
            color: #dc2626;
        }
        
        .growth-neutral {
            background-color: #f3f4f6;
            color: #6b7280;
        }
        
        .brand-metric {
            transition: all 0.5s ease;
        }
        
        .metric-update {
            animation: metricUpdate 1s ease;
        }
        
        @keyframes metricUpdate {
            0% { background-color: transparent; }
            50% { background-color: rgba(34, 197, 94, 0.2); }
            100% { background-color: transparent; }
        }
        
        /* Spreadsheet styles */
        .spreadsheet-container {
            overflow: auto;
            max-height: 400px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        
        .spreadsheet-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .spreadsheet-table th,
        .spreadsheet-table td {
            border: 1px solid #d1d5db;
            padding: 8px;
            text-align: left;
            min-width: 120px;
        }
        
        .spreadsheet-table th {
            background-color: #f9fafb;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .spreadsheet-table td {
            background-color: white;
        }
        
        .spreadsheet-table td:focus {
            outline: 2px solid #3b82f6;
            background-color: #f0f9ff;
        }
        
        .editable-cell {
            cursor: cell;
        }
        
        .row-header {
            background-color: #f9fafb;
            font-weight: 600;
            text-align: center;
            position: sticky;
            left: 0;
            z-index: 10;
        }
        
        /* Audit tool styles */
        .audit-finding {
            border-left: 4px solid;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 4px;
        }
        
        .audit-critical {
            border-left-color: #dc2626;
            background-color: #fef2f2;
        }
        
        .audit-high {
            border-left-color: #ea580c;
            background-color: #fff7ed;
        }
        
        .audit-medium {
            border-left-color: #d97706;
            background-color: #fffbeb;
        }
        
        .audit-low {
            border-left-color: #65a30d;
            background-color: #f7fee7;
        }
        
        .money-lost {
            color: #dc2626;
            font-weight: 600;
        }
        
        .tab-button {
            padding: 8px 16px;
            border-radius: 6px 6px 0 0;
            background-color: #f3f4f6;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab-button.active {
            background-color: white;
            border-bottom: none;
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
            padding: 16px;
            border: 1px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 8px 8px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Greeting styles */
        .greeting-container {
            background: linear-gradient(135deg, #1e40af, #3730a3);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }
        
        .greeting-container::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 150px;
            height: 150px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(40%, -40%);
        }
        
        .greeting-container::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(-30%, 30%);
        }
        
        .greeting-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            opacity: 0.9;
        }
        
        .greeting-text {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .greeting-subtext {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .time-display {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 5px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Simple Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-green-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <div class="text-xl font-semibold text-gray-800">CFO Portal</div>
            <div class="text-sm text-gray-600 mt-2" id="loadingStatus">Connecting to executive network...</div>
        </div>
    </div>

    <!-- Auto Logout Modal -->
    <div id="autoLogoutModal" class="logout-modal fixed inset-0 hidden items-center justify-center">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex items-center mb-4">
                <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center mr-4">
                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-gray-800">Session Timeout Warning</h3>
                    <p class="text-sm text-gray-600">You will be logged out due to inactivity</p>
                </div>
            </div>
            <div class="mb-4">
                <div class="flex justify-between text-sm text-gray-600 mb-1">
                    <span>Time remaining:</span>
                    <span id="timeRemaining">2:00</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="timeoutProgress" class="bg-red-600 h-2 rounded-full transition-all duration:1000" style="width: 100%"></div>
                </div>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancelLogout" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all">
                    Stay Logged In
                </button>
                <button id="confirmLogout" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all">
                    Log Out Now
                </button>
            </div>
        </div>
    </div>

    <!-- Simple Header -->
    <header class="bg-green-800 text-white p-4 sticky top-0 z-40 shadow-lg">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 rounded-lg bg-white/20 flex items-center justify-center">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold">EverGreen Empire</h1>
                    <p class="text-sm opacity-90">CFO Portal <span id="connectionStatus" class="online-dot"></span> <span id="syncStatus" class="text-xs">Connecting...</span></p>
                </div>
            </div>
            
            <!-- Desktop Navigation -->
            <div class="hidden md:flex items-center space-x-3">
                <button onclick="toggleTheme()" class="p-2 rounded-lg bg-white/10 hover:bg-white/20">
                    <i class="fas fa-palette"></i>
                </button>
                <button onclick="generateQuickAdvice()" class="p-2 rounded-lg bg-purple-600 hover:bg-purple-700">
                    <i class="fas fa-robot"></i>
                </button>
                <button onclick="signOut()" class="p-2 rounded-lg bg-red-600 hover:bg-red-700">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="ml-2">Sign Out</span>
                </button>
            </div>
            
            <!-- Mobile Menu Button -->
            <div class="md:hidden">
                <button id="mobileMenuButton" class="p-2 rounded-lg bg-white/10 hover:bg-white/20">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
        
        <!-- Mobile Menu -->
        <div id="mobileMenu" class="mobile-menu md:hidden mt-4 bg-green-700 rounded-lg p-4 hidden">
            <div class="flex flex-col space-y-3">
                <button onclick="toggleTheme()" class="flex items-center p-2 rounded-lg bg-white/10 hover:bg-white/20">
                    <i class="fas fa-palette mr-2"></i>
                    <span>Toggle Theme</span>
                </button>
                <button onclick="generateQuickAdvice()" class="flex items-center p-2 rounded-lg bg-purple-600 hover:bg-purple-700">
                    <i class="fas fa-robot mr-2"></i>
                    <span>AI Advice</span>
                </button>
                <button onclick="signOut()" class="flex items-center p-2 rounded-lg bg-red-600 hover:bg-red-700">
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    <span>Sign Out</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto p-4" id="mainContent" style="display: none;">
        <!-- Dynamic Greeting Banner -->
        <div id="greetingBanner" class="greeting-container fade-in">
            <div class="flex flex-col md:flex-row md:items-center justify-between relative z-10">
                <div class="mb-4 md:mb-0">
                    <div class="greeting-icon" id="greetingIcon">
                        <i class="fas fa-sun"></i>
                    </div>
                    <div class="greeting-text" id="greetingText">Good Morning, CFO!</div>
                    <div class="greeting-subtext" id="greetingSubtext">Welcome to your financial command center</div>
                    <div class="time-display" id="currentTimeDisplay">Loading time...</div>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="text-right">
                        <div class="text-xs opacity-90">Executive Network</div>
                        <div class="text-sm font-bold" id="networkStatus">Live</div>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center">
                        <i class="fas fa-network-wired text-lg"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Financial KPIs -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
            <div class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-lg p-4 metric-card">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-base font-bold">Total Revenue</h3>
                    <i class="fas fa-dollar-sign text-lg opacity-80"></i>
                </div>
                <div class="text-2xl font-bold mb-1" id="totalRevenue">$0.00</div>
                <div class="flex items-center text-xs">
                    <i class="fas fa-minus mr-1"></i>
                    <span>0%</span>
                    <span class="ml-2 opacity-80">Waiting for data</span>
                </div>
            </div>

            <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-lg p-4 metric-card">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-base font-bold">Profit Margin</h3>
                    <i class="fas fa-percentage text-lg opacity-80"></i>
                </div>
                <div class="text-2xl font-bold mb-1" id="profitMargin">0%</div>
                <div class="text-xs opacity-80">Waiting for data</div>
            </div>

            <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-lg p-4 metric-card">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-base font-bold">Op. Costs</h3>
                    <i class="fas fa-money-bill-wave text-lg opacity-80"></i>
                </div>
                <div class="text-2xl font-bold mb-1" id="operatingCosts">$0.00</div>
                <div class="text-xs opacity-80">Waiting for data</div>
            </div>

            <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 text-white rounded-lg p-4 metric-card">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-base font-bold">Cash Flow</h3>
                    <i class="fas fa-exchange-alt text-lg opacity-80"></i>
                </div>
                <div class="text-2xl font-bold mb-1" id="cashFlow">$0.00</div>
                <div class="text-xs opacity-80">Waiting for data</div>
            </div>
        </div>

        <!-- Financial Tools Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
            <!-- Tax Calculator -->
            <div class="bg-white rounded-lg p-4 shadow-sm border">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-base font-bold flex items-center">
                        <i class="fas fa-calculator mr-2 text-blue-500"></i>Tax Calculator
                    </h3>
                    <span class="text-xs text-blue-600 bg-blue-100 px-2 py-1 rounded-full">Live</span>
                </div>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs text-gray-600">Revenue</label>
                            <input type="number" id="taxRevenue" placeholder="0.00" class="w-full p-2 border rounded-lg text-sm" value="0">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">Tax Rate (%)</label>
                            <input type="number" id="taxRate" placeholder="20" class="w-full p-2 border rounded-lg text-sm" value="20">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs text-gray-600">Deductions</label>
                            <input type="number" id="taxDeductions" placeholder="0.00" class="w-full p-2 border rounded-lg text-sm" value="0">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">Credits</label>
                            <input type="number" id="taxCredits" placeholder="0.00" class="w-full p-2 border rounded-lg text-sm" value="0">
                        </div>
                    </div>
                    <button onclick="calculateTax()" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-all text-sm">
                        <i class="fas fa-calculator mr-1"></i>Calculate Tax
                    </button>
                    <div id="taxResult" class="bg-blue-50 border border-blue-200 rounded-lg p-3 hidden">
                        <div class="flex justify-between text-sm">
                            <span>Taxable Income:</span>
                            <span id="taxableIncome" class="font-semibold">$0.00</span>
                        </div>
                        <div class="flex justify-between text-sm mt-1">
                            <span>Tax Amount:</span>
                            <span id="taxAmount" class="font-semibold">$0.00</span>
                        </div>
                        <div class="flex justify-between text-sm mt-1">
                            <span>After Tax:</span>
                            <span id="afterTax" class="font-semibold text-green-600">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Brand Audio Summaries -->
            <div class="bg-white rounded-lg p-4 shadow-sm border">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-base font-bold flex items-center">
                        <i class="fas fa-headphones mr-2 text-purple-500"></i>Brand Audio Summaries
                    </h3>
                    <span class="text-xs text-purple-600 bg-purple-100 px-2 py-1 rounded-full">New</span>
                </div>
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium">Brand Performance Audio</span>
                        <button id="toggleAudio" onclick="toggleAudioSummary()" class="bg-purple-600 text-white px-3 py-1 rounded-lg hover:bg-purple-700 transition-all text-sm">
                            <i class="fas fa-play mr-1"></i>Play
                        </button>
                    </div>
                    <div class="audio-visualizer hidden" id="audioVisualizer">
                        <div class="audio-bar"></div>
                    </div>
                    <div class="text-xs text-gray-500">
                        Listen to an audio summary of brand performance metrics and growth trends.
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <div>
                            <label class="text-xs text-gray-600">Voice</label>
                            <select id="voiceSelect" class="w-full p-2 border rounded-lg text-sm">
                                <option value="male">Male Voice</option>
                                <option value="female">Female Voice</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">Speed</label>
                            <select id="speedSelect" class="w-full p-2 border rounded-lg text-sm">
                                <option value="0.8">Slow</option>
                                <option value="1" selected>Normal</option>
                                <option value="1.2">Fast</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Audit Tool & Spreadsheet Section -->
        <div class="bg-white rounded-lg shadow-sm border mb-4">
            <!-- Tabs -->
            <div class="flex border-b">
                <button class="tab-button active" data-tab="audit-tool">
                    <i class="fas fa-search-dollar mr-2"></i>Audit Tool
                </button>
                <button class="tab-button" data-tab="spreadsheet">
                    <i class="fas fa-table mr-2"></i>Financial Spreadsheet
                </button>
                <button class="tab-button" data-tab="automation">
                    <i class="fas fa-robot mr-2"></i>Automation
                </button>
            </div>

            <!-- Audit Tool Content -->
            <div id="audit-tool" class="tab-content active">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">Financial Audit & Money Loss Detection</h3>
                    <button onclick="runAudit()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-all">
                        <i class="fas fa-search mr-1"></i>Run Audit
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <h4 class="font-semibold text-red-800">Money Lost</h4>
                            <i class="fas fa-exclamation-triangle text-red-600"></i>
                        </div>
                        <div class="text-2xl font-bold text-red-700 mt-2" id="totalMoneyLost">$0.00</div>
                        <div class="text-sm text-red-600 mt-1" id="moneyLostTrend">No issues detected</div>
                    </div>
                    
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <h4 class="font-semibold text-orange-800">Audit Findings</h4>
                            <i class="fas fa-clipboard-list text-orange-600"></i>
                        </div>
                        <div class="text-2xl font-bold text-orange-700 mt-2" id="auditFindingsCount">0</div>
                        <div class="text-sm text-orange-600 mt-1">Potential issues</div>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <h4 class="font-semibold text-blue-800">Recovery Potential</h4>
                            <i class="fas fa-hand-holding-usd text-blue-600"></i>
                        </div>
                        <div class="text-2xl font-bold text-blue-700 mt-2" id="recoveryPotential">$0.00</div>
                        <div class="text-sm text-blue-600 mt-1">Estimated recoverable</div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h4 class="font-semibold mb-2">Audit Configuration</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-gray-600">Audit Period</label>
                            <select id="auditPeriod" class="w-full p-2 border rounded-lg text-sm">
                                <option value="7">Last 7 days</option>
                                <option value="30" selected>Last 30 days</option>
                                <option value="90">Last 90 days</option>
                                <option value="365">Last year</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-gray-600">Audit Sensitivity</label>
                            <select id="auditSensitivity" class="w-full p-2 border rounded-lg text-sm">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="extreme">Extreme</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div id="auditResults">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-search text-3xl mb-3 text-gray-400"></i>
                        <div class="text-lg font-semibold">No Audit Results Yet</div>
                        <div class="text-sm mt-1">Run the audit to detect financial discrepancies and money loss</div>
                    </div>
                </div>
            </div>

            <!-- Spreadsheet Content -->
            <div id="spreadsheet" class="tab-content">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">Financial Spreadsheet</h3>
                    <div class="flex space-x-2">
                        <button onclick="addRow()" class="bg-green-600 text-white px-3 py-1 rounded-lg hover:bg-green-700 transition-all text-sm">
                            <i class="fas fa-plus mr-1"></i>Add Row
                        </button>
                        <button onclick="addColumn()" class="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 transition-all text-sm">
                            <i class="fas fa-plus mr-1"></i>Add Column
                        </button>
                        <button onclick="exportSpreadsheet()" class="bg-purple-600 text-white px-3 py-1 rounded-lg hover:bg-purple-700 transition-all text-sm">
                            <i class="fas fa-download mr-1"></i>Export
                        </button>
                    </div>
                </div>
                
                <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="text-sm text-gray-600">Spreadsheet Name</label>
                        <input type="text" id="spreadsheetName" value="Financial Analysis" class="w-full p-2 border rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="text-sm text-gray-600">Auto-save</label>
                        <div class="flex items-center mt-1">
                            <input type="checkbox" id="autoSave" checked class="mr-2">
                            <label for="autoSave" class="text-sm">Enable auto-save</label>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm text-gray-600">Template</label>
                        <select id="spreadsheetTemplate" class="w-full p-2 border rounded-lg text-sm" onchange="loadTemplate()">
                            <option value="blank">Blank</option>
                            <option value="budget">Budget Analysis</option>
                            <option value="forecast">Revenue Forecast</option>
                            <option value="expense">Expense Tracking</option>
                        </select>
                    </div>
                </div>
                
                <div class="spreadsheet-container">
                    <table class="spreadsheet-table" id="financialSpreadsheet">
                        <thead>
                            <tr>
                                <th class="row-header">#</th>
                                <!-- Columns will be generated dynamically -->
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Rows will be generated dynamically -->
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-4 flex justify-between items-center text-sm text-gray-600">
                    <div>
                        <span id="spreadsheetStats">0 rows, 0 columns</span>
                    </div>
                    <div>
                        <span id="lastSaved">Not saved yet</span>
                    </div>
                </div>
            </div>

            <!-- Automation Content -->
            <div id="automation" class="tab-content">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">Financial Automation</h3>
                    <button onclick="createAutomation()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-all">
                        <i class="fas fa-plus mr-1"></i>New Automation
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold mb-3">Available Automations</h4>
                        <div class="space-y-3">
                            <div class="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer" onclick="setupAutomation('reconciliation')">
                                <div class="flex items-center justify-between">
                                    <div class="font-medium">Financial Reconciliation</div>
                                    <i class="fas fa-exchange-alt text-blue-600"></i>
                                </div>
                                <div class="text-sm text-gray-600 mt-1">Automatically reconcile transactions and flag discrepancies</div>
                            </div>
                            
                            <div class="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer" onclick="setupAutomation('reporting')">
                                <div class="flex items-center justify-between">
                                    <div class="font-medium">Automated Reporting</div>
                                    <i class="fas fa-chart-bar text-green-600"></i>
                                </div>
                                <div class="text-sm text-gray-600 mt-1">Generate and distribute financial reports on schedule</div>
                            </div>
                            
                            <div class="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer" onclick="setupAutomation('alerts')">
                                <div class="flex items-center justify-between">
                                    <div class="font-medium">Anomaly Alerts</div>
                                    <i class="fas fa-bell text-red-600"></i>
                                </div>
                                <div class="text-sm text-gray-600 mt-1">Get notified of unusual financial activities</div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold mb-3">Active Automations</h4>
                        <div id="activeAutomations" class="space-y-3">
                            <div class="text-center text-gray-500 py-4">
                                <i class="fas fa-robot text-2xl mb-2 text-gray-400"></i>
                                <div class="text-sm">No active automations</div>
                                <div class="text-xs mt-1">Set up your first automation to save time</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Growth Metrics Section -->
        <div class="bg-white rounded-lg p-4 shadow-sm border mb-4">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-base font-bold">Growth Metrics</h3>
                <span class="text-xs text-green-600 bg-green-100 px-2 py-1 rounded-full">Live Updates</span>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center p-3 bg-gray-50 rounded-lg">
                    <div class="text-xs text-gray-600 mb-1">MoM Growth</div>
                    <div class="text-lg font-bold text-green-600" id="momGrowth">0.0%</div>
                    <div class="growth-indicator growth-neutral mt-1" id="momIndicator">
                        <i class="fas fa-minus mr-1"></i> No data
                    </div>
                </div>
                <div class="text-center p-3 bg-gray-50 rounded-lg">
                    <div class="text-xs text-gray-600 mb-1">QoQ Growth</div>
                    <div class="text-lg font-bold text-blue-600" id="qoqGrowth">0.0%</div>
                    <div class="growth-indicator growth-neutral mt-1" id="qoqIndicator">
                        <i class="fas fa-minus mr-1"></i> No data
                    </div>
                </div>
                <div class="text-center p-3 bg-gray-50 rounded-lg">
                    <div class="text-xs text-gray-600 mb-1">YoY Growth</div>
                    <div class="text-lg font-bold text-purple-600" id="yoyGrowth">0.0%</div>
                    <div class="growth-indicator growth-neutral mt-1" id="yoyIndicator">
                        <i class="fas fa-minus mr-1"></i> No data
                    </div>
                </div>
                <div class="text-center p-3 bg-gray-50 rounded-lg">
                    <div class="text-xs text-gray-600 mb-1">Market Share</div>
                    <div class="text-lg font-bold text-indigo-600" id="marketShare">0.0%</div>
                    <div class="growth-indicator growth-neutral mt-1" id="marketIndicator">
                        <i class="fas fa-minus mr-1"></i> No data
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Insights & Communications -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
            <!-- AI Financial Advisor -->
            <div class="bg-white rounded-lg p-4 shadow-sm border">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-base font-bold flex items-center">
                        <i class="fas fa-robot mr-2 text-purple-500"></i>AI Financial Advisor
                    </h3>
                    <span class="text-xs text-green-600 bg-green-100 px-2 py-1 rounded-full">Online</span>
                </div>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="generateAIInsight('revenue')" class="bg-green-600 hover:bg-green-700 text-white p-2 rounded-lg text-sm transition-all">
                             Revenue
                        </button>
                        <button onclick="generateAIInsight('profitability')" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg text-sm transition-all">
                             Profitability
                        </button>
                        <button onclick="generateAIInsight('costs')" class="bg-purple-600 hover:bg-purple-700 text-white p-2 rounded-lg text-sm transition-all">
                             Cost Analysis
                        </button>
                        <button onclick="generateAIInsight('investment')" class="bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded-lg text-sm transition-all">
                             Investments
                        </button>
                    </div>
                    <div id="aiOutput" class="min-h-[200px] max-h-[300px] overflow-y-auto p-3 bg-gray-50 rounded-lg border">
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-robot text-2xl mb-2 text-purple-500"></i>
                            <div class="text-sm">Select an analysis type to get AI insights</div>
                            <div class="text-xs mt-1">Powered by Google Gemini</div>
                        </div>
                    </div>
                    <button onclick="generateQuickAdvice()" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-2 rounded-lg hover:from-purple-700 hover:to-indigo-700 transition-all text-sm">
                        <i class="fas fa-bolt mr-1"></i>Quick Financial Advice
                    </button>
                </div>
            </div>

            <!-- Real-time Executive Communications -->
            <div class="bg-white rounded-lg p-4 shadow-sm border">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-base font-bold">Executive Communications</h3>
                    <div class="flex items-center text-xs text-green-600">
                        <span class="online-dot"></span>
                        <span>Live with CEO & Admin</span>
                    </div>
                </div>
                <div class="space-y-3">
                    <div class="flex flex-col space-y-2">
                        <input type="text" id="messageInput" placeholder="Type your message to CEO or Admin..." class="w-full p-2 border rounded-lg text-sm">
                        <select id="recipientSelect" class="w-full p-2 border rounded-lg text-sm">
                            <option value="all">All Executives (CEO & Admin)</option>
                            <option value="ceo">CEO Only</option>
                            <option value="admin">Admin Team Only</option>
                            <option value="cfo">CFO Team Only</option>
                        </select>
                        <button onclick="sendMessage()" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-all">
                            <i class="fas fa-paper-plane mr-1"></i>Send Message
                        </button>
                    </div>
                    <div id="messagesContainer" class="max-h-48 overflow-y-auto space-y-2 border rounded-lg p-2">
                        <div class="text-center text-gray-500 text-sm py-4">Loading executive messages...</div>
                    </div>
                    <div class="flex flex-col md:flex-row md:items-center justify-between text-xs text-gray-500">
                        <span>Connected to: CEO, Admin, CFO</span>
                        <span id="messageCount" class="mt-1 md:mt-0">0 messages</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="bg-white rounded-lg p-4 shadow-sm border">
            <div class="flex flex-col md:flex-row md:items-center justify-between mb-3">
                <h3 class="text-base font-bold mb-2 md:mb-0">Brand Performance</h3>
                <div class="flex space-x-2">
                    <button onclick="loadBrandsData()" class="bg-green-600 text-white px-3 py-1 rounded-lg hover:bg-green-700 transition-all text-sm">
                        <i class="fas fa-sync-alt mr-1"></i>Refresh
                    </button>
                    <button onclick="exportData()" class="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 transition-all text-sm">
                        <i class="fas fa-download mr-1"></i>Export
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto responsive-table">
                <table class="w-full min-w-[600px]">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left py-2 font-semibold text-sm">Brand</th>
                            <th class="text-left py-2 font-semibold text-sm">28D Revenue</th>
                            <th class="text-left py-2 font-semibold text-sm">Est. Profit</th>
                            <th class="text-left py-2 font-semibold text-sm">ROI</th>
                            <th class="text-left py-2 font-semibold text-sm">Growth</th>
                            <th class="text-left py-2 font-semibold text-sm">Trend</th>
                            <th class="text-left py-2 font-semibold text-sm">Last Updated</th>
                        </tr>
                    </thead>
                    <tbody id="brandsTableBody">
                        <tr>
                            <td colspan="7" class="text-center py-4 text-gray-500">Loading brand data from Admin...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // Same Supabase configuration as CEO and Admin portals
        const SUPABASE_URL = 'https://clhaquwjevqdzjobthdz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsaGFxdXdqZXZxZHpqb2J0aGR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwNjYxODMsImV4cCI6MjA3NjY0MjE4M30.Ns2raXXMNPAveuogHrcRsTgazQrpTTnzr6ZeURc3pv0';
        
        // Initialize Supabase (same as CEO and Admin)
        let supabase;
        let realtimeChannels = [];

        // Auto logout variables
        let inactivityTimer;
        let logoutWarningTimer;
        const LOGOUT_TIME = 30 * 60 * 1000; // 30 minutes in milliseconds
        const WARNING_TIME = 2 * 60 * 1000; // 2 minutes warning before logout

        // Audio variables
        let audioPlaying = false;
        let speechSynthesis = window.speechSynthesis;

        // Spreadsheet variables
        let spreadsheetData = [];
        let spreadsheetColumns = ['A', 'B', 'C', 'D'];
        let spreadsheetRows = 10;
        let autoSaveInterval;

        // Greeting variables
        let greetingInterval;

        // Global State - START WITH ZERO DATA
        let state = {
            brands: [], // Empty array - no brands until Admin adds them
            messages: [],
            user: { role: 'cfo', name: 'CFO' },
            totalRevenue: 0,
            profitMargin: 0,
            operatingCosts: 0,
            cashFlow: 0,
            previousMetrics: {
                totalRevenue: 0,
                profitMargin: 0,
                operatingCosts: 0,
                cashFlow: 0
            }
        };

        // Update loading status
        function updateLoadingStatus(message) {
            const statusEl = document.getElementById('loadingStatus');
            if (statusEl) {
                statusEl.textContent = message;
            }
            console.log('Loading:', message);
        }

        // Initialize Application
        async function init() {
            console.log(' Initializing CFO Portal with Real-time Executive Network...');
            updateLoadingStatus('Connecting to Supabase database...');

            try {
                // Initialize Supabase (same connection as CEO and Admin)
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log(' Supabase connected successfully');
                
                updateLoadingStatus('Setting up real-time messaging...');
                
                // Setup real-time connections to CEO and Admin
                await setupRealtimeConnections();
                
                // Load initial data - will be empty until Admin adds data
                await loadInitialData();
                
                // Show main content
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                
                // Initialize auto logout timer
                resetInactivityTimer();
                setupActivityListeners();
                
                // Initialize spreadsheet
                initializeSpreadsheet();
                
                // Initialize greeting system
                initializeGreeting();
                
                showNotification('Connected to CEO & Admin executive network!', 'success');
                
            } catch (error) {
                console.error(' Initialization failed:', error);
                updateLoadingStatus('Using offline mode - some features limited');
                
                // Fallback: Show main content with ZERO data
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    loadZeroData();
                    initializeSpreadsheet();
                    initializeGreeting();
                    showNotification('Running in offline mode - real-time features disabled', 'warning');
                }, 2000);
            }
        }

        // GREETING SYSTEM
        function initializeGreeting() {
            // Update greeting immediately
            updateGreeting();
            
            // Set up interval to update greeting every minute
            greetingInterval = setInterval(updateGreeting, 60000);
            
            // Also update time display every second
            setInterval(updateTimeDisplay, 1000);
        }

        function updateGreeting() {
            const now = new Date();
            const hour = now.getHours();
            const greetingBanner = document.getElementById('greetingBanner');
            const greetingText = document.getElementById('greetingText');
            const greetingSubtext = document.getElementById('greetingSubtext');
            const greetingIcon = document.getElementById('greetingIcon');
            
            let greeting, subtext, icon, gradient;
            
            // Determine greeting based on time of day
            if (hour >= 5 && hour < 12) {
                // Morning (5:00 AM - 11:59 AM)
                greeting = "Good Morning, CFO!";
                subtext = "Welcome to your financial command center";
                icon = '<i class="fas fa-sun"></i>';
                gradient = "linear-gradient(135deg, #f59e0b, #d97706)";
            } else if (hour >= 12 && hour < 17) {
                // Afternoon (12:00 PM - 4:59 PM)
                greeting = "Good Afternoon, CFO!";
                subtext = "Your financial dashboard is updated and ready";
                icon = '<i class="fas fa-sun"></i>';
                gradient = "linear-gradient(135deg, #3b82f6, #1e40af)";
            } else if (hour >= 17 && hour < 21) {
                // Evening (5:00 PM - 8:59 PM)
                greeting = "Good Evening, CFO!";
                subtext = "Wrapping up the day's financial activities";
                icon = '<i class="fas fa-moon"></i>';
                gradient = "linear-gradient(135deg, #7c3aed, #5b21b6)";
            } else {
                // Night (9:00 PM - 4:59 AM)
                greeting = "Working Late, CFO?";
                subtext = "Your financial dashboard never sleeps";
                icon = '<i class="fas fa-moon"></i>';
                gradient = "linear-gradient(135deg, #1e293b, #0f172a)";
            }
            
            // Update the greeting elements
            greetingText.textContent = greeting;
            greetingSubtext.textContent = subtext;
            greetingIcon.innerHTML = icon;
            
            // Update the background gradient
            greetingBanner.style.background = gradient;
            
            // Update time display
            updateTimeDisplay();
        }

        function updateTimeDisplay() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit',
                hour12: true 
            });
            const dateString = now.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            document.getElementById('currentTimeDisplay').textContent = `${dateString} â€¢ ${timeString}`;
        }

        // REAL-TIME CONNECTION TO CEO & ADMIN
        async function setupRealtimeConnections() {
            if (!supabase) {
                console.log(' Supabase not available - real-time features disabled');
                document.getElementById('networkStatus').textContent = 'Offline';
                document.getElementById('connectionStatus').style.background = '#ef4444';
                return;
            }

            updateLoadingStatus('Connecting to CEO & Admin real-time channels...');

            try {
                // REAL-TIME MESSAGES - Connect to same messages table as CEO and Admin
                const messagesChannel = supabase
                    .channel('cfo-executive-messages')
                    .on('postgres_changes', 
                        { 
                            event: 'INSERT', 
                            schema: 'public', 
                            table: 'messages',
                            filter: 'receiver=in.(all,cfo,admin,ceo)'
                        }, 
                        (payload) => {
                            console.log(' New executive message:', payload);
                            
                            // Add message to state (unless it's our own)
                            if (payload.new.sender !== 'CFO') {
                                state.messages.unshift(payload.new);
                                updateMessages();
                                
                                // Show notification for new messages from CEO or Admin
                                if (payload.new.sender === 'CEO' || payload.new.sender === 'Admin') {
                                    showNotification(`New message from ${payload.new.sender}`, 'info');
                                    playNotificationSound();
                                }
                            }
                        }
                    )
                    .subscribe((status) => {
                        console.log(' Messages subscription status:', status);
                        if (status === 'SUBSCRIBED') {
                            document.getElementById('networkStatus').textContent = 'Live';
                            document.getElementById('connectionStatus').style.background = '#10b981';
                            document.getElementById('syncStatus').textContent = 'Connected to CEO & Admin';
                        }
                    });

                realtimeChannels.push(messagesChannel);

                // REAL-TIME BRANDS DATA - Sync with Admin portal updates
                const brandsChannel = supabase
                    .channel('cfo-brands-data')
                    .on('postgres_changes', 
                        { 
                            event: '*', 
                            schema: 'public', 
                            table: 'brands' 
                        }, 
                        async (payload) => {
                            console.log(' Brands data updated by Admin:', payload);
                            
                            // Refresh brands data when Admin makes changes
                            await loadBrandsData();
                            showNotification('Brand data updated from Admin', 'success');
                        }
                    )
                    .subscribe((status) => {
                        console.log(' Brands subscription status:', status);
                    });

                realtimeChannels.push(brandsChannel);

                updateLoadingStatus('Real-time executive network connected!');

            } catch (error) {
                console.error(' Real-time setup failed:', error);
                document.getElementById('networkStatus').textContent = 'Offline';
                document.getElementById('connectionStatus').style.background = '#ef4444';
            }
        }

        // Load initial data from shared database - WILL BE EMPTY INITIALLY
        async function loadInitialData() {
            updateLoadingStatus('Loading executive messages...');
            await loadMessages();
            
            updateLoadingStatus('Loading brand performance data...');
            await loadBrandsData(); // This will be empty until Admin adds data
            
            // Update financial metrics with actual data (will be 0 initially)
            calculateFinancialMetrics();
        }

        // Load messages from shared database (same as CEO and Admin)
        async function loadMessages() {
            if (!supabase) {
                loadDemoMessages();
                return;
            }

            try {
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select('*')
                    .or('receiver.eq.all,receiver.eq.cfo,receiver.eq.admin,receiver.eq.ceo')
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) throw error;

                state.messages = messages || [];
                updateMessages();
                
            } catch (error) {
                console.error('Error loading messages:', error);
                loadDemoMessages();
            }
        }

        // Load brands data from shared database - STARTS EMPTY
        async function loadBrandsData() {
            if (!supabase) {
                loadZeroData();
                return;
            }

            try {
                const { data: brands, error } = await supabase
                    .from('brands')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // This will be empty array until Admin adds brands
                state.brands = brands || [];
                updateBrandsTable();
                calculateFinancialMetrics(); // Recalculate with new data
                
                if (state.brands.length === 0) {
                    showNotification('No brand data available. Waiting for Admin to upload data.', 'info');
                } else {
                    showNotification(`Loaded ${state.brands.length} brands from Admin`, 'success');
                }
                
            } catch (error) {
                console.error('Error loading brands:', error);
                loadZeroData();
            }
        }

        // Calculate financial metrics based on actual brand data
        function calculateFinancialMetrics() {
            let totalRevenue = 0;
            let totalViews = 0;

            // Calculate from actual brand data (will be 0 if no brands)
            state.brands.forEach(brand => {
                const views28d = brand.views_28d || 0;
                totalViews += views28d;
                totalRevenue += (views28d / 1000) * 0.12; // RPM calculation
            });

            const operatingCosts = totalRevenue * 0.65;
            const netProfit = totalRevenue - operatingCosts;
            const profitMargin = totalRevenue > 0 ? (netProfit / totalRevenue) * 100 : 0;
            const cashFlow = netProfit * 0.85;

            // Update UI with actual calculations
            updateMetricWithAnimation('totalRevenue', formatCurrency(totalRevenue));
            updateMetricWithAnimation('profitMargin', `${profitMargin.toFixed(1)}%`);
            updateMetricWithAnimation('operatingCosts', formatCurrency(operatingCosts));
            updateMetricWithAnimation('cashFlow', formatCurrency(cashFlow));

            // Update growth indicators
            updateGrowthIndicators(totalRevenue, profitMargin);

            // Update growth indicator
            const growthElement = document.querySelector('#totalRevenue + .flex.items-center');
            if (growthElement) {
                if (totalRevenue > 0) {
                    growthElement.innerHTML = `<i class="fas fa-arrow-up mr-1"></i><span>${totalRevenue > 0 ? 'Calculated' : '0%'}</span><span class="ml-2 opacity-80">from brand data</span>`;
                } else {
                    growthElement.innerHTML = `<i class="fas fa-minus mr-1"></i><span>0%</span><span class="ml-2 opacity-80">Waiting for data</span>`;
                }
            }

            // Store for AI analysis
            state.totalRevenue = totalRevenue;
            state.profitMargin = profitMargin;
            state.operatingCosts = operatingCosts;
            state.cashFlow = cashFlow;
        }

        // Update metric with animation effect
        function updateMetricWithAnimation(elementId, newValue) {
            const element = document.getElementById(elementId);
            if (element && element.textContent !== newValue) {
                element.classList.add('metric-update');
                element.textContent = newValue;
                setTimeout(() => {
                    element.classList.remove('metric-update');
                }, 1000);
            }
        }

        // Update growth indicators
        function updateGrowthIndicators(revenue, margin) {
            // Generate random growth values for demo purposes
            // In a real app, these would be calculated from historical data
            const momGrowth = revenue > 0 ? (Math.random() * 15 - 5).toFixed(1) : 0;
            const qoqGrowth = revenue > 0 ? (Math.random() * 25 - 10).toFixed(1) : 0;
            const yoyGrowth = revenue > 0 ? (Math.random() * 40 - 15).toFixed(1) : 0;
            const marketShare = revenue > 0 ? (Math.random() * 10).toFixed(1) : 0;

            // Update growth metrics
            updateGrowthMetric('momGrowth', momGrowth, 'momIndicator');
            updateGrowthMetric('qoqGrowth', qoqGrowth, 'qoqIndicator');
            updateGrowthMetric('yoyGrowth', yoyGrowth, 'yoyIndicator');
            updateGrowthMetric('marketShare', marketShare, 'marketIndicator');
        }

        // Update individual growth metric
        function updateGrowthMetric(elementId, value, indicatorId) {
            const element = document.getElementById(elementId);
            const indicator = document.getElementById(indicatorId);
            
            if (element && indicator) {
                element.textContent = `${value}%`;
                
                // Update indicator based on value
                if (value > 0) {
                    indicator.className = 'growth-indicator growth-positive mt-1';
                    indicator.innerHTML = `<i class="fas fa-arrow-up mr-1"></i> +${value}%`;
                } else if (value < 0) {
                    indicator.className = 'growth-indicator growth-negative mt-1';
                    indicator.innerHTML = `<i class="fas fa-arrow-down mr-1"></i> ${value}%`;
                } else {
                    indicator.className = 'growth-indicator growth-neutral mt-1';
                    indicator.innerHTML = `<i class="fas fa-minus mr-1"></i> ${value}%`;
                }
            }
        }

        // Send message to CEO and Admin
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            const recipient = document.getElementById('recipientSelect').value;

            if (!message) {
                showNotification('Please enter a message', 'error');
                return;
            }

            const messageData = {
                sender: 'CFO',
                receiver: recipient,
                message: message,
                read: false,
                created_at: new Date().toISOString()
            };

            // Add to local state immediately for instant feedback
            state.messages.unshift(messageData);
            updateMessages();
            messageInput.value = '';

            // Save to shared database (CEO and Admin will see it instantly)
            if (supabase) {
                try {
                    const { error } = await supabase.from('messages').insert([messageData]);
                    if (error) throw error;
                    console.log(' Message saved to shared database - CEO & Admin notified');
                    showNotification('Message sent to executives!', 'success');
                } catch (error) {
                    console.error('Failed to save message:', error);
                    showNotification('Message sent locally (connection issue)', 'warning');
                }
            } else {
                showNotification('Message sent (offline mode)', 'info');
            }
        }

        // Update messages UI
        function updateMessages() {
            const container = document.getElementById('messagesContainer');
            const messageCount = document.getElementById('messageCount');
            
            if (!state.messages.length) {
                container.innerHTML = '<div class="text-center text-gray-500 text-sm py-4">No messages yet</div>';
                messageCount.textContent = '0 messages';
                return;
            }

            container.innerHTML = state.messages.map(msg => {
                let messageClass = 'message-other';
                if (msg.sender === 'CEO') messageClass = 'message-ceo';
                if (msg.sender === 'CFO') messageClass = 'message-cfo';
                if (msg.sender === 'Admin') messageClass = 'message-admin';
                
                return `
                <div class="${messageClass} fade-in">
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-semibold text-sm">${msg.sender}</span>
                        <span class="text-xs opacity-80">${formatTime(msg.created_at)}</span>
                    </div>
                    <div class="text-sm">${msg.message}</div>
                    ${msg.receiver !== 'all' ? `<div class="text-xs opacity-80 mt-1">To: ${msg.receiver}</div>` : ''}
                </div>
                `;
            }).join('');

            messageCount.textContent = `${state.messages.length} messages`;
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        // Update brands table - SHOWS EMPTY STATE INITIALLY
        function updateBrandsTable() {
            const tbody = document.getElementById('brandsTableBody');
            
            if (!state.brands.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-8">
                            <div class="empty-state">
                                <i class="fas fa-database text-4xl text-gray-400 mb-4"></i>
                                <div class="text-gray-600 font-semibold mb-2">No Brand Data Available</div>
                                <div class="text-sm text-gray-500 mb-4">Waiting for Admin to upload brand performance data</div>
                                <div class="text-xs text-gray-400">Revenue and metrics will update automatically when data is available</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = state.brands.map(brand => {
                const revenue = (brand.views_28d / 1000) * 0.12;
                const profit = revenue * 0.35; // Assuming 35% profit margin
                const roi = ((profit / (revenue * 0.7)) * 100).toFixed(1);
                const growth = (Math.random() * 30 - 10).toFixed(1); // Random growth for demo
                const lastUpdated = brand.updated_at ? formatTime(brand.updated_at) : 'Recently';
                
                // Determine growth indicator
                let growthClass = 'growth-neutral';
                let growthIcon = 'fa-minus';
                if (growth > 5) {
                    growthClass = 'growth-positive';
                    growthIcon = 'fa-arrow-up';
                } else if (growth < -5) {
                    growthClass = 'growth-negative';
                    growthIcon = 'fa-arrow-down';
                }
                
                return `
                <tr class="border-b hover:bg-gray-50 fade-in brand-metric">
                    <td class="py-2 font-semibold">${brand.name || 'Unknown Brand'}</td>
                    <td class="py-2">${formatCurrency(revenue)}</td>
                    <td class="py-2">${formatCurrency(profit)}</td>
                    <td class="py-2 ${roi > 40 ? 'text-green-600' : 'text-orange-600'}">${roi}%</td>
                    <td class="py-2">
                        <span class="growth-indicator ${growthClass}">
                            <i class="fas ${growthIcon} mr-1"></i> ${growth}%
                        </span>
                    </td>
                    <td class="py-2">
                        <span class="px-2 py-1 rounded-full text-xs ${roi > 40 ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}">
                            ${roi > 40 ? '' : ''}
                        </span>
                    </td>
                    <td class="py-2 text-xs text-gray-500">${lastUpdated}</td>
                </tr>
                `;
            }).join('');
        }

        // ZERO DATA STATE - No demo data, just empty state
        function loadZeroData() {
            state.brands = []; // Empty array
            state.messages = [
                { 
                    sender: 'System', 
                    receiver: 'cfo', 
                    message: 'Welcome! Financial data will appear here when Admin uploads brand information.', 
                    created_at: new Date().toISOString() 
                }
            ];
            updateBrandsTable();
            updateMessages();
            calculateFinancialMetrics(); // This will set everything to 0
        }

        function loadDemoMessages() {
            state.messages = [
                { 
                    sender: 'CEO', 
                    receiver: 'all', 
                    message: 'Need Q3 financial projections by EOD tomorrow.', 
                    created_at: new Date().toISOString() 
                },
                { 
                    sender: 'Admin', 
                    receiver: 'cfo', 
                    message: 'I will upload brand performance data shortly.', 
                    created_at: new Date(Date.now() - 300000).toISOString() 
                },
                { 
                    sender: 'System', 
                    receiver: 'cfo', 
                    message: 'Financial metrics will update when Admin adds brand data.', 
                    created_at: new Date(Date.now() - 600000).toISOString() 
                }
            ];
            updateMessages();
        }

        // Tax Calculator
        function calculateTax() {
            const revenue = parseFloat(document.getElementById('taxRevenue').value) || 0;
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            const deductions = parseFloat(document.getElementById('taxDeductions').value) || 0;
            const credits = parseFloat(document.getElementById('taxCredits').value) || 0;
            
            const taxableIncome = Math.max(0, revenue - deductions);
            const taxAmount = (taxableIncome * taxRate / 100) - credits;
            const afterTax = revenue - Math.max(0, taxAmount);
            
            document.getElementById('taxableIncome').textContent = formatCurrency(taxableIncome);
            document.getElementById('taxAmount').textContent = formatCurrency(Math.max(0, taxAmount));
            document.getElementById('afterTax').textContent = formatCurrency(afterTax);
            
            const taxResult = document.getElementById('taxResult');
            taxResult.classList.remove('hidden');
            
            showNotification('Tax calculation completed!', 'success');
        }

        // Audio Summary Toggle
        function toggleAudioSummary() {
            const toggleButton = document.getElementById('toggleAudio');
            const visualizer = document.getElementById('audioVisualizer');
            
            if (!audioPlaying) {
                // Start audio summary
                audioPlaying = true;
                toggleButton.innerHTML = '<i class="fas fa-pause mr-1"></i>Pause';
                toggleButton.classList.remove('bg-purple-600');
                toggleButton.classList.add('bg-red-600');
                visualizer.classList.remove('hidden');
                
                // Generate and speak brand summary
                speakBrandSummary();
            } else {
                // Stop audio summary
                audioPlaying = false;
                toggleButton.innerHTML = '<i class="fas fa-play mr-1"></i>Play';
                toggleButton.classList.remove('bg-red-600');
                toggleButton.classList.add('bg-purple-600');
                visualizer.classList.add('hidden');
                
                // Stop speech
                if (speechSynthesis.speaking) {
                    speechSynthesis.cancel();
                }
            }
        }

        // Generate and speak brand summary
        function speakBrandSummary() {
            if (!speechSynthesis) return;
            
            // Stop any current speech
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            
            const voiceType = document.getElementById('voiceSelect').value;
            const speed = parseFloat(document.getElementById('speedSelect').value);
            
            // Create speech synthesis utterance
            const utterance = new SpeechSynthesisUtterance();
            
            // Set voice properties
            utterance.rate = speed;
            utterance.pitch = 1;
            utterance.volume = 0.8;
            
            // Generate summary text based on available data
            let summaryText = "Brand Performance Summary. ";
            
            if (state.brands.length === 0) {
                summaryText += "No brand data available yet. Waiting for Admin to upload performance metrics.";
            } else {
                summaryText += `Currently tracking ${state.brands.length} brands. `;
                summaryText += `Total revenue is ${formatCurrency(state.totalRevenue)}. `;
                summaryText += `Profit margin is ${state.profitMargin.toFixed(1)} percent. `;
                
                // Find top performing brand
                if (state.brands.length > 0) {
                    const topBrand = state.brands.reduce((prev, current) => {
                        const prevRevenue = (prev.views_28d / 1000) * 0.12;
                        const currentRevenue = (current.views_28d / 1000) * 0.12;
                        return prevRevenue > currentRevenue ? prev : current;
                    });
                    
                    const topBrandRevenue = (topBrand.views_28d / 1000) * 0.12;
                    summaryText += `Top performing brand is ${topBrand.name} with revenue of ${formatCurrency(topBrandRevenue)}. `;
                }
                
                summaryText += "End of brand performance summary.";
            }
            
            utterance.text = summaryText;
            
            // Set up event listeners for the utterance
            utterance.onend = function() {
                audioPlaying = false;
                const toggleButton = document.getElementById('toggleAudio');
                const visualizer = document.getElementById('audioVisualizer');
                
                toggleButton.innerHTML = '<i class="fas fa-play mr-1"></i>Play';
                toggleButton.classList.remove('bg-red-600');
                toggleButton.classList.add('bg-purple-600');
                visualizer.classList.add('hidden');
            };
            
            utterance.onerror = function(event) {
                console.error('Speech synthesis error:', event);
                audioPlaying = false;
                const toggleButton = document.getElementById('toggleAudio');
                const visualizer = document.getElementById('audioVisualizer');
                
                toggleButton.innerHTML = '<i class="fas fa-play mr-1"></i>Play';
                toggleButton.classList.remove('bg-red-600');
                toggleButton.classList.add('bg-purple-600');
                visualizer.classList.add('hidden');
                
                showNotification('Audio summary failed. Please try again.', 'error');
            };
            
            // Speak the summary
            speechSynthesis.speak(utterance);
        }

        // AUDIT TOOL FUNCTIONS
        function runAudit() {
            const auditPeriod = document.getElementById('auditPeriod').value;
            const sensitivity = document.getElementById('auditSensitivity').value;
            
            // Show loading state
            const auditResults = document.getElementById('auditResults');
            auditResults.innerHTML = `
                <div class="text-center py-8">
                    <div class="w-12 h-12 border-4 border-red-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                    <div class="text-lg font-semibold">Running Financial Audit</div>
                    <div class="text-sm text-gray-600 mt-1">Analyzing ${auditPeriod} days of financial data</div>
                </div>
            `;
            
            // Simulate audit processing
            setTimeout(() => {
                generateAuditResults(auditPeriod, sensitivity);
            }, 2000);
        }

        function generateAuditResults(period, sensitivity) {
            // Generate simulated audit findings based on available data
            const findings = [];
            let totalMoneyLost = 0;
            
            // Only generate findings if we have brand data
            if (state.brands.length > 0) {
                // Calculate potential money loss based on revenue and random factors
                const baseLoss = state.totalRevenue * 0.02; // Assume 2% base loss
                
                // Generate different types of audit findings
                if (Math.random() > 0.3) {
                    const lostAmount = baseLoss * (0.5 + Math.random() * 0.5);
                    totalMoneyLost += lostAmount;
                    findings.push({
                        title: "Revenue Recognition Issue",
                        description: `Potential revenue underreporting of approximately ${formatCurrency(lostAmount)}`,
                        severity: "high",
                        category: "Revenue",
                        impact: lostAmount
                    });
                }
                
                if (Math.random() > 0.5) {
                    const lostAmount = baseLoss * (0.2 + Math.random() * 0.3);
                    totalMoneyLost += lostAmount;
                    findings.push({
                        title: "Expense Classification Error",
                        description: `Misclassified expenses potentially costing ${formatCurrency(lostAmount)}`,
                        severity: "medium",
                        category: "Expenses",
                        impact: lostAmount
                    });
                }
                
                if (Math.random() > 0.7) {
                    const lostAmount = baseLoss * (0.1 + Math.random() * 0.2);
                    totalMoneyLost += lostAmount;
                    findings.push({
                        title: "Duplicate Payments",
                        description: `Possible duplicate vendor payments totaling ${formatCurrency(lostAmount)}`,
                        severity: "critical",
                        category: "Payments",
                        impact: lostAmount
                    });
                }
                
                // Add more findings based on sensitivity
                if (sensitivity === "high" || sensitivity === "extreme") {
                    if (Math.random() > 0.6) {
                        const lostAmount = baseLoss * (0.05 + Math.random() * 0.1);
                        totalMoneyLost += lostAmount;
                        findings.push({
                            title: "Tax Calculation Discrepancy",
                            description: `Potential tax overpayment of ${formatCurrency(lostAmount)}`,
                            severity: "medium",
                            category: "Tax",
                            impact: lostAmount
                        });
                    }
                }
            } else {
                // No brand data - generic findings
                findings.push({
                    title: "Insufficient Data for Complete Audit",
                    description: "Cannot perform full financial audit without brand performance data",
                    severity: "medium",
                    category: "Data",
                    impact: 0
                });
            }
            
            // Update audit metrics
            document.getElementById('totalMoneyLost').textContent = formatCurrency(totalMoneyLost);
            document.getElementById('auditFindingsCount').textContent = findings.length;
            document.getElementById('recoveryPotential').textContent = formatCurrency(totalMoneyLost * 0.7); // Assume 70% recovery
            
            // Update trend indicator
            const trendElement = document.getElementById('moneyLostTrend');
            if (totalMoneyLost > 0) {
                trendElement.textContent = `${findings.length} issues found`;
                trendElement.className = "text-sm text-red-600 mt-1";
            } else {
                trendElement.textContent = "No issues detected";
                trendElement.className = "text-sm text-green-600 mt-1";
            }
            
            // Display findings
            displayAuditFindings(findings);
            
            showNotification(`Audit completed: ${findings.length} findings`, 'info');
        }

        function displayAuditFindings(findings) {
            const auditResults = document.getElementById('auditResults');
            
            if (findings.length === 0) {
                auditResults.innerHTML = `
                    <div class="text-center text-green-600 py-8">
                        <i class="fas fa-check-circle text-3xl mb-3"></i>
                        <div class="text-lg font-semibold">No Issues Found</div>
                        <div class="text-sm mt-1">Financial audit completed with no discrepancies detected</div>
                    </div>
                `;
                return;
            }
            
            let findingsHTML = '<h4 class="font-semibold mb-3">Audit Findings</h4>';
            
            findings.forEach(finding => {
                let severityClass = 'audit-low';
                let severityIcon = 'fa-info-circle';
                
                switch(finding.severity) {
                    case 'critical':
                        severityClass = 'audit-critical';
                        severityIcon = 'fa-exclamation-triangle';
                        break;
                    case 'high':
                        severityClass = 'audit-high';
                        severityIcon = 'fa-exclamation-circle';
                        break;
                    case 'medium':
                        severityClass = 'audit-medium';
                        severityIcon = 'fa-info-circle';
                        break;
                }
                
                findingsHTML += `
                    <div class="audit-finding ${severityClass}">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-semibold flex items-center">
                                    <i class="fas ${severityIcon} mr-2"></i>
                                    ${finding.title}
                                </div>
                                <div class="text-sm mt-1">${finding.description}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs bg-gray-200 px-2 py-1 rounded-full">${finding.category}</div>
                                ${finding.impact > 0 ? `<div class="money-lost mt-1">${formatCurrency(finding.impact)}</div>` : ''}
                            </div>
                        </div>
                        <div class="flex justify-end mt-2">
                            <button class="text-xs bg-blue-600 text-white px-3 py-1 rounded mr-2">Investigate</button>
                            <button class="text-xs bg-gray-600 text-white px-3 py-1 rounded">Dismiss</button>
                        </div>
                    </div>
                `;
            });
            
            auditResults.innerHTML = findingsHTML;
        }

        // SPREADSHEET FUNCTIONS
        function initializeSpreadsheet() {
            // Set up tab functionality
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all tabs and contents
                    document.querySelectorAll('.tab-button').forEach(tab => tab.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Initialize empty spreadsheet
            createSpreadsheet(5, 5);
            
            // Set up auto-save if enabled
            const autoSaveCheckbox = document.getElementById('autoSave');
            if (autoSaveCheckbox.checked) {
                autoSaveInterval = setInterval(saveSpreadsheet, 30000); // Auto-save every 30 seconds
            }
            
            // Update auto-save setting when changed
            autoSaveCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    autoSaveInterval = setInterval(saveSpreadsheet, 30000);
                } else {
                    clearInterval(autoSaveInterval);
                }
            });
        }

        function createSpreadsheet(rows, cols) {
            const table = document.getElementById('financialSpreadsheet');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            
            // Clear existing content
            thead.innerHTML = '';
            tbody.innerHTML = '';
            
            // Create header row
            let headerRow = '<th class="row-header">#</th>';
            spreadsheetColumns = [];
            
            for (let i = 0; i < cols; i++) {
                const colName = String.fromCharCode(65 + i); // A, B, C, ...
                spreadsheetColumns.push(colName);
                headerRow += `<th>${colName}</th>`;
            }
            
            thead.innerHTML = `<tr>${headerRow}</tr>`;
            
            // Create data rows
            spreadsheetData = [];
            for (let i = 0; i < rows; i++) {
                let rowHTML = `<td class="row-header">${i + 1}</td>`;
                const rowData = [];
                
                for (let j = 0; j < cols; j++) {
                    const cellId = `${spreadsheetColumns[j]}${i + 1}`;
                    rowHTML += `<td class="editable-cell" contenteditable="true" data-cell="${cellId}"></td>`;
                    rowData.push('');
                }
                
                tbody.innerHTML += `<tr>${rowHTML}</tr>`;
                spreadsheetData.push(rowData);
            }
            
            // Add event listeners to cells
            table.querySelectorAll('.editable-cell').forEach(cell => {
                cell.addEventListener('blur', function() {
                    const cellId = this.getAttribute('data-cell');
                    updateSpreadsheetData(cellId, this.textContent);
                });
                
                cell.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.blur();
                    }
                });
            });
            
            // Update stats
            updateSpreadsheetStats();
        }

        function updateSpreadsheetData(cellId, value) {
            const col = cellId.charAt(0);
            const row = parseInt(cellId.substring(1)) - 1;
            const colIndex = spreadsheetColumns.indexOf(col);
            
            if (colIndex !== -1 && row >= 0 && row < spreadsheetData.length) {
                spreadsheetData[row][colIndex] = value;
                
                // Auto-save if enabled
                if (document.getElementById('autoSave').checked) {
                    saveSpreadsheet();
                }
            }
        }

        function addRow() {
            const tbody = document.querySelector('#financialSpreadsheet tbody');
            const rowCount = tbody.children.length;
            const colCount = spreadsheetColumns.length;
            
            let rowHTML = `<td class="row-header">${rowCount + 1}</td>`;
            const rowData = [];
            
            for (let j = 0; j < colCount; j++) {
                const cellId = `${spreadsheetColumns[j]}${rowCount + 1}`;
                rowHTML += `<td class="editable-cell" contenteditable="true" data-cell="${cellId}"></td>`;
                rowData.push('');
            }
            
            tbody.innerHTML += `<tr>${rowHTML}</tr>`;
            spreadsheetData.push(rowData);
            
            // Add event listeners to new cells
            const newRow = tbody.lastElementChild;
            newRow.querySelectorAll('.editable-cell').forEach(cell => {
                cell.addEventListener('blur', function() {
                    const cellId = this.getAttribute('data-cell');
                    updateSpreadsheetData(cellId, this.textContent);
                });
                
                cell.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.blur();
                    }
                });
            });
            
            updateSpreadsheetStats();
        }

        function addColumn() {
            const newColName = String.fromCharCode(65 + spreadsheetColumns.length);
            spreadsheetColumns.push(newColName);
            
            // Update header
            const thead = document.querySelector('#financialSpreadsheet thead tr');
            thead.innerHTML += `<th>${newColName}</th>`;
            
            // Update rows
            const tbody = document.querySelector('#financialSpreadsheet tbody');
            const rows = tbody.children;
            
            for (let i = 0; i < rows.length; i++) {
                const cellId = `${newColName}${i + 1}`;
                rows[i].innerHTML += `<td class="editable-cell" contenteditable="true" data-cell="${cellId}"></td>`;
                spreadsheetData[i].push('');
                
                // Add event listener to new cell
                const newCell = rows[i].lastElementChild;
                newCell.addEventListener('blur', function() {
                    const cellId = this.getAttribute('data-cell');
                    updateSpreadsheetData(cellId, this.textContent);
                });
                
                newCell.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.blur();
                    }
                });
            }
            
            updateSpreadsheetStats();
        }

        function loadTemplate() {
            const template = document.getElementById('spreadsheetTemplate').value;
            
            if (template === 'blank') {
                createSpreadsheet(5, 5);
            } else if (template === 'budget') {
                createSpreadsheet(10, 6);
                // Pre-populate with budget template
                setTimeout(() => {
                    const table = document.getElementById('financialSpreadsheet');
                    const cells = table.querySelectorAll('.editable-cell');
                    
                    // Set header values
                    if (cells[0]) cells[0].textContent = 'Category';
                    if (cells[1]) cells[1].textContent = 'Budgeted';
                    if (cells[2]) cells[2].textContent = 'Actual';
                    if (cells[3]) cells[3].textContent = 'Variance';
                    if (cells[4]) cells[4].textContent = 'Variance %';
                    if (cells[5]) cells[5].textContent = 'Notes';
                    
                    // Set row values
                    if (cells[6]) cells[6].textContent = 'Marketing';
                    if (cells[12]) cells[12].textContent = 'Operations';
                    if (cells[18]) cells[18].textContent = 'R&D';
                    if (cells[24]) cells[24].textContent = 'Administrative';
                    
                    // Trigger data update
                    cells.forEach(cell => {
                        const cellId = cell.getAttribute('data-cell');
                        if (cellId) updateSpreadsheetData(cellId, cell.textContent);
                    });
                }, 100);
            } else if (template === 'forecast') {
                createSpreadsheet(8, 5);
                // Pre-populate with forecast template
                setTimeout(() => {
                    const table = document.getElementById('financialSpreadsheet');
                    const cells = table.querySelectorAll('.editable-cell');
                    
                    // Set header values
                    if (cells[0]) cells[0].textContent = 'Month';
                    if (cells[1]) cells[1].textContent = 'Revenue';
                    if (cells[2]) cells[2].textContent = 'Expenses';
                    if (cells[3]) cells[3].textContent = 'Profit';
                    if (cells[4]) cells[4].textContent = 'Growth %';
                    
                    // Set row values
                    const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August'];
                    for (let i = 0; i < months.length && i * 5 + 5 < cells.length; i++) {
                        if (cells[i * 5 + 5]) cells[i * 5 + 5].textContent = months[i];
                    }
                    
                    // Trigger data update
                    cells.forEach(cell => {
                        const cellId = cell.getAttribute('data-cell');
                        if (cellId) updateSpreadsheetData(cellId, cell.textContent);
                    });
                }, 100);
            }
            
            showNotification(`Loaded ${template} template`, 'success');
        }

        function saveSpreadsheet() {
            const spreadsheetName = document.getElementById('spreadsheetName').value;
            const timestamp = new Date().toLocaleTimeString();
            
            document.getElementById('lastSaved').textContent = `Last saved: ${timestamp}`;
            
            // In a real application, you would save to a database or local storage
            console.log('Saving spreadsheet:', spreadsheetName, spreadsheetData);
            
            showNotification('Spreadsheet auto-saved', 'info');
        }

        function exportSpreadsheet() {
            const spreadsheetName = document.getElementById('spreadsheetName').value;
            
            // Create CSV content
            let csvContent = '';
            
            // Add headers
            csvContent += ',"' + spreadsheetColumns.join('","') + '"\n';
            
            // Add data rows
            for (let i = 0; i < spreadsheetData.length; i++) {
                csvContent += `${i + 1},"${spreadsheetData[i].join('","')}"\n`;
            }
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${spreadsheetName}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Spreadsheet exported as CSV', 'success');
        }

        function updateSpreadsheetStats() {
            const rowCount = document.querySelectorAll('#financialSpreadsheet tbody tr').length;
            const colCount = spreadsheetColumns.length;
            document.getElementById('spreadsheetStats').textContent = `${rowCount} rows, ${colCount} columns`;
        }

        // AUTOMATION FUNCTIONS
        function setupAutomation(type) {
            let automationConfig = {};
            
            switch(type) {
                case 'reconciliation':
                    automationConfig = {
                        name: 'Financial Reconciliation',
                        description: 'Automatically reconcile transactions and flag discrepancies',
                        type: 'reconciliation',
                        schedule: 'daily',
                        status: 'active'
                    };
                    break;
                case 'reporting':
                    automationConfig = {
                        name: 'Automated Reporting',
                        description: 'Generate and distribute financial reports on schedule',
                        type: 'reporting',
                        schedule: 'weekly',
                        status: 'active'
                    };
                    break;
                case 'alerts':
                    automationConfig = {
                        name: 'Anomaly Alerts',
                        description: 'Get notified of unusual financial activities',
                        type: 'alerts',
                        schedule: 'realtime',
                        status: 'active'
                    };
                    break;
            }
            
            addAutomation(automationConfig);
        }

        function addAutomation(config) {
            const automationHTML = `
                <div class="border rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-medium">${config.name}</div>
                            <div class="text-sm text-gray-600 mt-1">${config.description}</div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">${config.status}</span>
                            <button class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mt-3 text-xs text-gray-500">
                        <span>Schedule: ${config.schedule}</span>
                        <span>Type: ${config.type}</span>
                    </div>
                </div>
            `;
            
            const activeAutomations = document.getElementById('activeAutomations');
            
            // If it's the placeholder, replace it
            if (activeAutomations.querySelector('.text-center')) {
                activeAutomations.innerHTML = automationHTML;
            } else {
                activeAutomations.innerHTML += automationHTML;
            }
            
            showNotification(`Automation "${config.name}" activated`, 'success');
        }

        function createAutomation() {
            // In a real application, this would open a modal to configure a new automation
            showNotification('Use the available automation templates or contact IT for custom automations', 'info');
        }

        // Notification sound
        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (error) {
                console.log('Audio notification not supported');
            }
        }

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        function formatTime(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            
            return date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 fade-in ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                type === 'warning' ? 'bg-yellow-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // Theme toggle
        function toggleTheme() {
            const body = document.body;
            if (body.classList.contains('bg-gray-50')) {
                body.className = 'bg-gray-900 text-white min-h-screen';
            } else {
                body.className = 'bg-gray-50 min-h-screen';
            }
        }

        // AI Insights - uses actual financial data (which starts at 0)
        async function generateAIInsight(type) {
            const aiOutput = document.getElementById('aiOutput');
            
            aiOutput.innerHTML = `
                <div class="flex flex-col items-center justify-center py-8">
                    <div class="w-12 h-12 border-4 border-purple-600 border-t-transparent rounded-full animate-spin mb-4"></div>
                    <div class="text-purple-600 font-semibold">Analyzing Financial Data...</div>
                </div>
            `;

            setTimeout(() => {
                // Use actual financial data from state
                const insights = {
                    revenue: [
                        state.totalRevenue > 0 ? 
                        ` Current revenue: ${formatCurrency(state.totalRevenue)} - ${state.brands.length} brands active` :
                        " No revenue data available yet - waiting for Admin to upload brand information",
                        " Revenue tracking will begin when brand data is available",
                        " Ask Admin to upload CSV with brand performance metrics"
                    ],
                    profitability: [
                        state.profitMargin > 0 ?
                        ` Current profit margin: ${state.profitMargin.toFixed(1)}%` :
                        " Profit margin analysis requires brand performance data",
                        " Margin optimization suggestions will appear when data is available",
                        " Contact Admin to set up brand tracking"
                    ]
                };

                aiOutput.innerHTML = (insights[type] || insights.revenue).map(insight => `
                    <div class="ai-insight fade-in">
                        <div class="text-sm font-medium text-gray-900">${insight}</div>
                    </div>
                `).join('');

                showNotification(`${type} analysis completed!`, 'success');
            }, 2000);
        }

        function generateQuickAdvice() {
            if (state.totalRevenue === 0) {
                const aiOutput = document.getElementById('aiOutput');
                aiOutput.innerHTML = `
                    <div class="ai-insight fade-in">
                        <div class="text-sm font-medium text-gray-900"> Quick Advice: Contact Admin to upload brand performance data to start financial tracking</div>
                    </div>
                    <div class="ai-insight fade-in">
                        <div class="text-sm font-medium text-gray-900"> Once data is available, I'll provide revenue optimization suggestions</div>
                    </div>
                    <div class="ai-insight fade-in">
                        <div class="text-sm font-medium text-gray-900"> Financial metrics update automatically when Admin adds new data</div>
                    </div>
                `;
            } else {
                generateAIInsight('revenue');
            }
        }

        function exportData() {
            if (state.brands.length === 0) {
                showNotification('No data available to export', 'warning');
            } else {
                showNotification('Data export started...', 'info');
            }
        }

        // Sign out function
        function signOut() {
            showNotification('Signing out...', 'info');
            
            // Clean up real-time connections
            realtimeChannels.forEach(channel => {
                if (channel && channel.unsubscribe) {
                    channel.unsubscribe();
                }
            });
            
            // Clear timers
            clearTimeout(inactivityTimer);
            clearTimeout(logoutWarningTimer);
            
            // Stop audio if playing
            if (audioPlaying && speechSynthesis) {
                speechSynthesis.cancel();
            }
            
            // Clear auto-save interval
            clearInterval(autoSaveInterval);
            
            // Clear greeting interval
            clearInterval(greetingInterval);
            
            // Simulate sign out process
            setTimeout(() => {
                // In a real application, you would redirect to login page
                // For this demo, we'll just reload the page
                window.location.reload();
            }, 1000);
        }

        // Auto logout functionality
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            clearTimeout(logoutWarningTimer);
            
            // Set the main logout timer
            inactivityTimer = setTimeout(showLogoutWarning, LOGOUT_TIME);
        }

        function showLogoutWarning() {
            // Show the logout warning modal
            const modal = document.getElementById('autoLogoutModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            let timeLeft = WARNING_TIME / 1000; // Convert to seconds
            const timeRemainingEl = document.getElementById('timeRemaining');
            const progressBar = document.getElementById('timeoutProgress');
            
            // Update the countdown
            logoutWarningTimer = setInterval(() => {
                timeLeft--;
                
                // Update the time display
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timeRemainingEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                // Update the progress bar
                const progressPercent = (timeLeft / (WARNING_TIME / 1000)) * 100;
                progressBar.style.width = `${progressPercent}%`;
                
                // Auto logout when time is up
                if (timeLeft <= 0) {
                    clearInterval(logoutWarningTimer);
                    signOut();
                }
            }, 1000);
            
            // Setup event listeners for the modal buttons
            document.getElementById('cancelLogout').onclick = function() {
                clearInterval(logoutWarningTimer);
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                resetInactivityTimer();
                showNotification('Session extended', 'success');
            };
            
            document.getElementById('confirmLogout').onclick = function() {
                clearInterval(logoutWarningTimer);
                signOut();
            };
        }

        function setupActivityListeners() {
            // Reset timer on user activity
            const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'];
            events.forEach(event => {
                document.addEventListener(event, resetInactivityTimer, false);
            });
        }

        // Mobile menu functionality
        function setupMobileMenu() {
            const mobileMenuButton = document.getElementById('mobileMenuButton');
            const mobileMenu = document.getElementById('mobileMenu');
            
            mobileMenuButton.addEventListener('click', function() {
                mobileMenu.classList.toggle('hidden');
            });
            
            // Close mobile menu when clicking outside
            document.addEventListener('click', function(event) {
                if (!mobileMenu.contains(event.target) && !mobileMenuButton.contains(event.target)) {
                    mobileMenu.classList.add('hidden');
                }
            });
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            realtimeChannels.forEach(channel => {
                if (channel && channel.unsubscribe) {
                    channel.unsubscribe();
                }
            });
            
            clearTimeout(inactivityTimer);
            clearTimeout(logoutWarningTimer);
            
            // Stop audio if playing
            if (audioPlaying && speechSynthesis) {
                speechSynthesis.cancel();
            }
            
            // Clear auto-save interval
            clearInterval(autoSaveInterval);
            
            // Clear greeting interval
            clearInterval(greetingInterval);
        });

        // Initialize when DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            init();
            setupMobileMenu();
        });
    </script>
</body>
    </html>
