<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EverGreen Empire — CEO Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #1e40af;
            --secondary: #3730a3;
            --background: #eff6ff;
            --surface: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #dbeafe;
        }

        .theme-dark {
            --primary: #3b82f6;
            --secondary: #2563eb;
            --background: #1e1b2e;
            --surface: #2d2a42;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #374151;
        }

        body {
            background-color: var(--background);
            color: var(--text);
            transition: all 0.3s ease;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse-glow {
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(30, 64, 175, 0.5); }
            50% { box-shadow: 0 0 20px rgba(30, 64, 175, 0.8); }
        }

        .online-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .message-ceo {
            background: linear-gradient(135deg, #1e40af, #3730a3);
            color: white;
            border-radius: 12px;
            padding: 12px;
            margin: 8px 0;
        }

        .message-cfo {
            background: linear-gradient(135deg, #059669, #047857);
            color: white;
            border-radius: 12px;
            padding: 12px;
            margin: 8px 0;
        }

        .message-admin {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
            color: white;
            border-radius: 12px;
            padding: 12px;
            margin: 8px 0;
        }

        .message-system {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            border-radius: 12px;
            padding: 12px;
            margin: 8px 0;
        }

        .greeting-banner {
            background: linear-gradient(135deg, #1e40af 0%, #3730a3 100%);
            color: white;
        }

        .performance-excellent {
            color: #10b981;
            font-weight: bold;
        }

        .performance-good {
            color: #3b82f6;
            font-weight: bold;
        }

        .performance-poor {
            color: #ef4444;
            font-weight: bold;
        }

        .ceo-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-left: 4px solid #1e40af;
        }

        .dark .ceo-card {
            background: linear-gradient(135deg, #2d2a42 0%, #1e1b2e 100%);
        }

        .growth-positive {
            border-left: 4px solid #10b981;
        }

        .growth-negative {
            border-left: 4px solid #ef4444;
        }

        .world-map {
            background: linear-gradient(135deg, #1e40af, #3730a3);
            border-radius: 10px;
            padding: 20px;
            color: white;
        }

        .ai-insight-ceo {
            background: linear-gradient(135deg, #dbeafe, #93c5fd);
            border-left: 4px solid #3b82f6;
        }

        .dark .ai-insight-ceo {
            background: linear-gradient(135deg, #1e3a8a, #1e40af);
        }

        .performance-metric {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .dark .performance-metric {
            background: linear-gradient(135deg, #3f3f23, #4f4626);
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <div class="text-xl font-semibold text-gray-800">CEO Command Center</div>
            <div class="text-sm text-gray-600 mt-2" id="loadingStatus">Initializing executive dashboard...</div>
        </div>
    </div>

    <!-- Security Check Modal -->
    <div id="securityModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 m-3 max-w-md w-full">
            <div class="text-center">
                <i class="fas fa-shield-alt text-4xl text-red-500 mb-4"></i>
                <h3 class="text-lg font-bold mb-2">Authentication Required</h3>
                <p class="text-gray-600 mb-4">Please log in to access the CEO Command Center</p>
                <button onclick="redirectToLogin()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                    Go to Login
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
        <!-- Header -->
        <header class="bg-blue-800 text-white p-4 sticky top-0 z-40 shadow-lg">
            <div class="max-w-7xl mx-auto flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-lg bg-white/20 flex items-center justify-center">
                        <i class="fas fa-crown"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">EverGreen Empire</h1>
                        <p class="text-sm opacity-90">CEO Command Center <span id="connectionStatus" class="online-dot"></span> <span id="syncStatus" class="text-xs">Live Executive Data</span></p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="flex space-x-2">
                        <a href="admin.html" class="p-2 rounded-lg bg-white/10 hover:bg-white/20" title="Admin Portal">
                            <i class="fas fa-cogs"></i>
                        </a>
                        <a href="cfo.html" class="p-2 rounded-lg bg-white/10 hover:bg-white/20" title="CFO Portal">
                            <i class="fas fa-chart-line"></i>
                        </a>
                    </div>
                    <button onclick="toggleTheme()" class="p-2 rounded-lg bg-white/10 hover:bg-white/20">
                        <i class="fas fa-palette"></i>
                    </button>
                    <button onclick="signOut()" class="bg-red-600 px-4 py-2 rounded-lg hover:bg-red-700 flex items-center">
                        <i class="fas fa-sign-out-alt mr-2"></i>Sign Out
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto p-4">
            <!-- Greeting Banner -->
            <div class="greeting-banner rounded-lg p-6 mb-6 text-white shadow-lg" id="greetingBanner">
                <div class="flex flex-col md:flex-row md:items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold mb-2" id="greetingMessage">Good morning, CEO!</h2>
                        <p class="text-blue-100" id="greetingSubtext">Ready to lead today's strategic initiatives?</p>
                        <div class="flex items-center mt-2 space-x-2" id="greetingStats">
                            <span class="text-xs bg-white/20 px-2 py-1 rounded-full">👑 $0 Revenue</span>
                            <span class="text-xs bg-white/20 px-2 py-1 rounded-full">🚀 0% Growth</span>
                            <span class="text-xs bg-white/20 px-2 py-1 rounded-full">📊 0 Brands</span>
                        </div>
                    </div>
                    <div class="mt-4 md:mt-0 flex items-center space-x-3">
                        <div class="text-right">
                            <div class="text-xs text-blue-200">Empire Status</div>
                            <div class="text-sm font-bold" id="portalStatus">All Systems Optimal</div>
                        </div>
                        <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center pulse-glow">
                            <i class="fas fa-crown text-white text-lg"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Executive Performance Dashboard -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="ceo-card rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <h3 class="text-base font-bold">Estimated Revenue</h3>
                        <i class="fas fa-dollar-sign text-green-500"></i>
                    </div>
                    <div class="text-2xl font-bold mt-2 performance-excellent" id="estimatedRevenue">$0</div>
                    <div class="text-xs text-gray-500">28-day projection</div>
                </div>
                <div class="ceo-card rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <h3 class="text-base font-bold">Growth Margin</h3>
                        <i class="fas fa-chart-line text-blue-500"></i>
                    </div>
                    <div class="text-2xl font-bold mt-2 performance-good" id="growthMargin">0%</div>
                    <div class="text-xs text-gray-500">Company performance</div>
                </div>
                <div class="ceo-card rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <h3 class="text-base font-bold">Daily Profit</h3>
                        <i class="fas fa-trending-up text-purple-500"></i>
                    </div>
                    <div class="text-2xl font-bold mt-2 performance-excellent" id="dailyProfit">$0</div>
                    <div class="text-xs text-gray-500">24h increase</div>
                </div>
                <div class="ceo-card rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <h3 class="text-base font-bold">Brand Health</h3>
                        <i class="fas fa-heart text-red-500"></i>
                    </div>
                    <div class="text-2xl font-bold mt-2 performance-good" id="brandHealth">0%</div>
                    <div class="text-xs text-gray-500">Portfolio strength</div>
                </div>
            </div>

            <!-- Strategic Overview -->
            <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-6">
                <!-- Performance Metrics & AI Insights -->
                <div class="card rounded-lg p-4 xl:col-span-2">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold">Strategic Performance Dashboard</h3>
                        <div class="flex space-x-2">
                            <button onclick="generateStrategicReport()" class="bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 text-sm">
                                <i class="fas fa-file-alt mr-1"></i>Strategy Report
                            </button>
                            <button onclick="analyzePerformance()" class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 text-sm">
                                <i class="fas fa-chart-bar mr-1"></i>Analyze
                            </button>
                        </div>
                    </div>

                    <!-- Performance Metrics -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="performance-metric">
                            <h5 class="font-semibold mb-2">📈 Market Position</h5>
                            <div class="flex justify-between items-center">
                                <span>Competitive Rank</span>
                                <span class="performance-excellent" id="marketRank">#1</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                <div class="bg-green-600 h-2 rounded-full" style="width: 85%" id="marketPositionBar"></div>
                            </div>
                        </div>
                        <div class="performance-metric">
                            <h5 class="font-semibold mb-2">⚡ Operational Efficiency</h5>
                            <div class="flex justify-between items-center">
                                <span>Performance Score</span>
                                <span class="performance-good" id="efficiencyScore">92%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                <div class="bg-blue-600 h-2 rounded-full" style="width: 92%" id="efficiencyBar"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Underperforming Brands -->
                    <div class="mb-6">
                        <h4 class="font-semibold mb-3 text-lg">⚠️ Underperforming Brands</h4>
                        <div id="underperformingBrands" class="space-y-2">
                            <div class="text-center text-gray-500 py-4">All brands performing optimally</div>
                        </div>
                    </div>

                    <!-- AI Strategic Insights -->
                    <div class="ai-insight-ceo rounded-lg p-4">
                        <h4 class="font-semibold mb-2">🤖 AI Strategic Insights</h4>
                        <div id="aiInsights" class="text-sm">
                            <p>Loading strategic analysis...</p>
                        </div>
                    </div>
                </div>

                <!-- Executive Communications & World Chart -->
                <div class="space-y-6">
                    <!-- Real-time Communications -->
                    <div class="card rounded-lg p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold">Executive Communications</h3>
                            <span class="text-xs text-green-600 bg-green-100 px-2 py-1 rounded-full">Live</span>
                        </div>
                        <div class="space-y-4">
                            <div class="flex flex-col space-y-2">
                                <input type="text" id="messageInput" placeholder="Type your strategic directive..." class="w-full p-3 border rounded-lg">
                                <select id="recipientSelect" class="w-full p-3 border rounded-lg">
                                    <option value="all">All Executives</option>
                                    <option value="cfo">CFO Only</option>
                                    <option value="admin">Admin Only</option>
                                </select>
                                <button onclick="sendMessage()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-bullhorn mr-2"></i>Send Directive
                                </button>
                            </div>
                            <div id="messagesContainer" class="max-h-64 overflow-y-auto space-y-2 border rounded-lg p-3">
                                <!-- Messages will appear here -->
                            </div>
                        </div>
                    </div>

                    <!-- World Market Chart -->
                    <div class="card rounded-lg p-4">
                        <h3 class="text-lg font-bold mb-4">🌍 Global Market Presence</h3>
                        <div class="world-map text-center">
                            <div class="text-xl font-bold mb-4">EverGreen Empire Global Reach</div>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <div class="font-semibold">North America</div>
                                    <div class="performance-excellent">$42.5K</div>
                                    <div class="text-xs">35% Market Share</div>
                                </div>
                                <div>
                                    <div class="font-semibold">Europe</div>
                                    <div class="performance-good">$28.3K</div>
                                    <div class="text-xs">22% Market Share</div>
                                </div>
                                <div>
                                    <div class="font-semibold">Asia Pacific</div>
                                    <div class="performance-good">$31.2K</div>
                                    <div class="text-xs">18% Market Share</div>
                                </div>
                                <div>
                                    <div class="font-semibold">Rest of World</div>
                                    <div class="performance-good">$18.0K</div>
                                    <div class="text-xs">12% Market Share</div>
                                </div>
                            </div>
                            <div class="mt-4 text-xs opacity-80">
                                Total Global Revenue: <span class="font-bold">$120K</span>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Trends -->
                    <div class="card rounded-lg p-4">
                        <h3 class="text-lg font-bold mb-4">Performance Trends</h3>
                        <canvas id="performanceTrendChart" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- Detailed Performance Analytics -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Brand Performance Matrix -->
                <div class="card rounded-lg p-4">
                    <h3 class="text-lg font-bold mb-4">Brand Performance Matrix</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b">
                                    <th class="text-left py-3 px-2 font-semibold">Brand</th>
                                    <th class="text-right py-3 px-2 font-semibold">Revenue</th>
                                    <th class="text-right py-3 px-2 font-semibold">Growth</th>
                                    <th class="text-center py-3 px-2 font-semibold">Status</th>
                                </tr>
                            </thead>
                            <tbody id="brandMatrixBody">
                                <tr><td colspan="4" class="text-center py-4 text-gray-500">Loading brand performance...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Executive Tools -->
                <div class="card rounded-lg p-4">
                    <h3 class="text-lg font-bold mb-4">CEO Executive Tools</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-robot text-blue-500 mr-3"></i>
                                <span class="font-semibold">Strategic AI Advisor</span>
                            </div>
                            <span class="text-blue-600 text-sm font-semibold">Active</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-chart-pie text-green-500 mr-3"></i>
                                <span class="font-semibold">Market Intelligence</span>
                            </div>
                            <span class="text-green-600 text-sm font-semibold">Live</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-bullseye text-purple-500 mr-3"></i>
                                <span class="font-semibold">Goal Tracking</span>
                            </div>
                            <span class="text-purple-600 text-sm font-semibold">85%</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-orange-50 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-trophy text-orange-500 mr-3"></i>
                                <span class="font-semibold">Performance Awards</span>
                            </div>
                            <span class="text-orange-600 text-sm font-semibold">3 Won</span>
                        </div>
                    </div>

                    <!-- Quick Action Buttons -->
                    <div class="grid grid-cols-2 gap-2 mt-4">
                        <button onclick="scheduleBoardMeeting()" class="bg-blue-600 text-white p-2 rounded hover:bg-blue-700 text-sm">
                            <i class="fas fa-users mr-1"></i>Board Meeting
                        </button>
                        <button onclick="reviewStrategicPlan()" class="bg-green-600 text-white p-2 rounded hover:bg-green-700 text-sm">
                            <i class="fas fa-file-contract mr-1"></i>Strategy Review
                        </button>
                    </div>
                </div>
            </div>

            <!-- Quarterly Performance -->
            <div class="card rounded-lg p-4 mb-6">
                <h3 class="text-lg font-bold mb-4">📅 Quarterly Performance Overview</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="text-center p-4 border rounded-lg">
                        <div class="text-2xl font-bold performance-excellent">Q1</div>
                        <div class="text-lg font-semibold">$45.2K</div>
                        <div class="text-sm text-gray-500">+12% Growth</div>
                    </div>
                    <div class="text-center p-4 border rounded-lg">
                        <div class="text-2xl font-bold performance-excellent">Q2</div>
                        <div class="text-lg font-semibold">$52.8K</div>
                        <div class="text-sm text-gray-500">+18% Growth</div>
                    </div>
                    <div class="text-center p-4 border rounded-lg">
                        <div class="text-2xl font-bold performance-good">Q3</div>
                        <div class="text-lg font-semibold">$48.9K</div>
                        <div class="text-sm text-gray-500">+8% Growth</div>
                    </div>
                    <div class="text-center p-4 border rounded-lg growth-positive">
                        <div class="text-2xl font-bold performance-excellent">Q4</div>
                        <div class="text-lg font-semibold" id="q4Projection">$0</div>
                        <div class="text-sm text-gray-500" id="q4Growth">Projection</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://clhaquwjevqdzjobthdz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsaGFxdXdqZXZxZHpqb2J0aGR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwNjYxODMsImV4cCI6MjA3NjY0MjE4M30.Ns2raXXMNPAveuogHrcRsTgazQrpTTnzr6ZeURc3pv0';
        
        // Initialize Supabase
        let supabase;
        let realtimeChannels = [];
        let performanceTrendChart;

        // Global State
        let state = {
            brands: [],
            messages: [],
            performance: {
                estimatedRevenue: 0,
                growthMargin: 0,
                dailyProfit: 0,
                brandHealth: 0,
                underperformingBrands: []
            },
            user: null
        };

        // 👑 CEO AUTO GREETINGS SYSTEM
        const ceoGreetings = {
            morning: [
                "Good morning, CEO! 🌅 Ready to lead today's strategic initiatives?",
                "Rise and shine, Visionary Leader! 👑 The empire awaits your command!",
                "Morning, CEO! Let's make today historically successful! 🚀",
                "Hello Commander! The future of the empire is in your hands! 💎"
            ],
            afternoon: [
                "Good afternoon, CEO! 📊 How are our strategic objectives progressing?",
                "Afternoon, Empire Builder! Time to review our conquests! 🏆",
                "Hello CEO! Hope you're having a visionary day! 🎯",
                "CEO! Perfect time for strategic decision-making! ⚡"
            ],
            evening: [
                "Good evening, CEO! 🌇 Wrapping up another day of empire-building?",
                "Evening, Master Strategist! The boardroom never sleeps! 🌙",
                "Hello CEO! Making visionary moves while others rest? 💪",
                "CEO! Evening is when empires are envisioned and built! 🏗️"
            ],
            night: [
                "Working late, CEO? 💼 That's why we're industry leaders! 🌃",
                "Good night shift, CEO! The empire thrives on your vision! 🌌",
                "CEO! Burning the midnight oil for global domination? 🔥",
                "Late night session, CEO! This is where legends cement their legacy! ⭐"
            ],
            achievements: [
                "Visionary leadership, CEO! 💎 You've built ${revenue} in empire value!",
                "Empire-building excellence, CEO! 🏆 ${revenue} revenue under your command!",
                "CEO, you're dominating! 📊 {brands} brands conquering markets!",
                "Strategic mastery, CEO! 🚀 The empire expands with your guidance!"
            ]
        };

        // 🚀 Initialize Application
        async function init() {
            console.log('🚀 Initializing CEO Command Center...');
            updateLoadingStatus('Checking authentication...');

            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // Check authentication first
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error || !session) {
                    showSecurityModal();
                    return;
                }

                state.user = {
                    email: session.user.email,
                    role: 'ceo',
                    name: session.user.email.split('@')[0]
                };

                console.log('✅ CEO authenticated:', state.user);
                updateLoadingStatus('Connecting to executive network...');

                await setupRealtimeConnections();
                await loadInitialData();
                
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                
                setupAutoGreeting();
                initializeCharts();
                generateStrategicInsights();
                
                showNotification(`Welcome back, CEO ${state.user.name}! Command Center activated! 👑`, 'success');
                
            } catch (error) {
                console.error('❌ Initialization failed:', error);
                showSecurityModal();
            }
        }

        // 🎯 Enhanced CEO Auto Greeting System
        function setupAutoGreeting() {
            const now = new Date();
            const hour = now.getHours();
            let timeOfDay = 'morning';
            
            if (hour >= 12 && hour < 17) timeOfDay = 'afternoon';
            else if (hour >= 17 && hour < 21) timeOfDay = 'evening';
            else if (hour >= 21 || hour < 5) timeOfDay = 'night';

            const greetingPool = ceoGreetings[timeOfDay];
            const randomGreeting = greetingPool[Math.floor(Math.random() * greetingPool.length)];
            
            const brandCount = state.brands.length;
            const totalRevenue = state.performance.estimatedRevenue;
            
            // Use achievement greeting if we have good numbers
            let finalGreeting = randomGreeting;
            if (brandCount >= 3 && totalRevenue >= 50) {
                const achievementGreeting = ceoGreetings.achievements[Math.floor(Math.random() * ceoGreetings.achievements.length)];
                finalGreeting = achievementGreeting
                    .replace('{brands}', brandCount)
                    .replace('${revenue}', `$${totalRevenue.toFixed(2)}`);
            }
            
            const greetingMessage = finalGreeting
                .replace('{name}', state.user.name)
                .replace('{brands}', brandCount)
                .replace('${revenue}', `$${totalRevenue.toFixed(2)}`);

            document.getElementById('greetingMessage').textContent = greetingMessage;
            
            // Update greeting stats
            const growthPercentage = state.performance.growthMargin > 0 ? state.performance.growthMargin.toFixed(1) : '0';
            const statsHTML = `
                <span class="text-xs bg-white/20 px-2 py-1 rounded-full">👑 $${totalRevenue.toFixed(2)} Revenue</span>
                <span class="text-xs bg-white/20 px-2 py-1 rounded-full">🚀 ${growthPercentage}% Growth</span>
                <span class="text-xs bg-white/20 px-2 py-1 rounded-full">📊 ${brandCount} Brands</span>
            `;
            document.getElementById('greetingStats').innerHTML = statsHTML;
        }

        // 🔐 SECURITY FUNCTIONS
        function showSecurityModal() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('securityModal').classList.remove('hidden');
        }

        function redirectToLogin() {
            window.location.href = 'index.html';
        }

        // 🔄 Real-time Connections
        async function setupRealtimeConnections() {
            if (!supabase) return;

            try {
                // Real-time messages
                const messagesChannel = supabase
                    .channel('ceo-messages')
                    .on('postgres_changes', 
                        { event: 'INSERT', schema: 'public', table: 'messages' }, 
                        (payload) => {
                            console.log('💬 New message:', payload.new);
                            state.messages.unshift(payload.new);
                            updateMessages();
                            playNotificationSound();
                            
                            if (payload.new.sender === 'CFO' || payload.new.sender === 'Admin') {
                                showNotification(`New message from ${payload.new.sender}`, 'info');
                            }
                        }
                    )
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            document.getElementById('connectionStatus').style.background = '#10b981';
                            document.getElementById('syncStatus').textContent = 'Live Executive Data';
                        }
                    });

                realtimeChannels.push(messagesChannel);

                // Real-time brands data
                const brandsChannel = supabase
                    .channel('ceo-brands')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'brands' }, 
                        async (payload) => {
                            console.log('🔄 Brands data updated:', payload);
                            await loadBrandsData();
                            updatePerformanceMetrics();
                            
                            if (payload.eventType === 'INSERT') {
                                showNotification(`New brand launched: ${payload.new.name}`, 'success');
                            }
                        }
                    )
                    .subscribe();

                realtimeChannels.push(brandsChannel);

            } catch (error) {
                console.error('❌ Real-time setup failed:', error);
            }
        }

        // 📊 Data Management
        async function loadInitialData() {
            await loadBrandsData();
            await loadMessages();
            updatePerformanceMetrics();
        }

        async function loadBrandsData() {
            try {
                const { data: brands, error } = await supabase
                    .from('brands')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                
                state.brands = brands || [];
                updatePerformanceMetrics();
                
                console.log(`✅ Loaded ${state.brands.length} brands for strategic analysis`);

            } catch (error) {
                console.error('❌ Error loading brands:', error);
                loadDemoBrands();
            }
        }

        async function loadMessages() {
            try {
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) throw error;
                state.messages = messages || [];
                updateMessages();
                
            } catch (error) {
                console.error('❌ Error loading messages:', error);
                loadDemoMessages();
            }
        }

        // 📈 Performance Metrics Calculation
        function updatePerformanceMetrics() {
            // Calculate total revenue from brands
            const estimatedRevenue = state.brands.reduce((sum, brand) => sum + ((brand.views_28d || 0) / 1000) * 0.12, 0);
            
            // Calculate growth margin (simulated based on brand performance)
            const averageBrandPerformance = state.brands.length > 0 ? 
                state.brands.reduce((sum, brand) => sum + (brand.views_28d || 0), 0) / state.brands.length : 0;
            const growthMargin = (averageBrandPerformance / 10000) * 15; // Simulated growth calculation
            
            // Calculate daily profit (simulated)
            const dailyProfit = estimatedRevenue * 0.03; // 3% of monthly revenue as daily profit
            
            // Calculate brand health (percentage of brands performing well)
            const performingBrands = state.brands.filter(brand => (brand.views_28d || 0) > 50000).length;
            const brandHealth = state.brands.length > 0 ? (performingBrands / state.brands.length) * 100 : 0;
            
            // Identify underperforming brands
            const underperformingBrands = state.brands.filter(brand => (brand.views_28d || 0) < 30000);
            
            // Update state
            state.performance = {
                estimatedRevenue,
                growthMargin,
                dailyProfit,
                brandHealth,
                underperformingBrands
            };
            
            // Update UI
            updatePerformanceUI();
            updateBrandMatrix();
            updateUnderperformingBrands();
            updateQuarterlyProjection();
        }

        function updatePerformanceUI() {
            const p = state.performance;
            
            document.getElementById('estimatedRevenue').textContent = formatCurrency(p.estimatedRevenue);
            document.getElementById('growthMargin').textContent = `${p.growthMargin.toFixed(1)}%`;
            document.getElementById('dailyProfit').textContent = formatCurrency(p.dailyProfit);
            document.getElementById('brandHealth').textContent = `${p.brandHealth.toFixed(0)}%`;
            
            // Color coding based on performance
            document.getElementById('estimatedRevenue').className = `text-2xl font-bold mt-2 ${p.estimatedRevenue > 50 ? 'performance-excellent' : p.estimatedRevenue > 20 ? 'performance-good' : 'performance-poor'}`;
            document.getElementById('growthMargin').className = `text-2xl font-bold mt-2 ${p.growthMargin > 10 ? 'performance-excellent' : p.growthMargin > 5 ? 'performance-good' : 'performance-poor'}`;
            document.getElementById('dailyProfit').className = `text-2xl font-bold mt-2 ${p.dailyProfit > 2 ? 'performance-excellent' : p.dailyProfit > 1 ? 'performance-good' : 'performance-poor'}`;
            document.getElementById('brandHealth').className = `text-2xl font-bold mt-2 ${p.brandHealth > 70 ? 'performance-excellent' : p.brandHealth > 50 ? 'performance-good' : 'performance-poor'}`;
        }

        function updateBrandMatrix() {
            const tbody = document.getElementById('brandMatrixBody');
            
            if (state.brands.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">No brand data available</td></tr>';
                return;
            }
            
            tbody.innerHTML = state.brands.map(brand => {
                const revenue = (brand.views_28d / 1000) * 0.12;
                const growth = (brand.views_28d / 10000) * 8; // Simulated growth
                const performanceClass = brand.views_28d > 80000 ? 'performance-excellent' : 
                                       brand.views_28d > 40000 ? 'performance-good' : 'performance-poor';
                const status = brand.views_28d > 80000 ? '🏆 Leading' : 
                             brand.views_28d > 40000 ? '✅ Growing' : '📈 Developing';
                
                return `
                <tr class="border-b fade-in">
                    <td class="py-2 px-2 font-semibold">${brand.name}</td>
                    <td class="py-2 px-2 text-right ${performanceClass}">${formatCurrency(revenue)}</td>
                    <td class="py-2 px-2 text-right ${performanceClass}">${growth.toFixed(1)}%</td>
                    <td class="py-2 px-2 text-center ${performanceClass}">${status}</td>
                </tr>
                `;
            }).join('');
        }

        function updateUnderperformingBrands() {
            const container = document.getElementById('underperformingBrands');
            const underperforming = state.performance.underperformingBrands;
            
            if (underperforming.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">All brands performing optimally 🎉</div>';
                return;
            }
            
            container.innerHTML = underperforming.map(brand => {
                const revenue = (brand.views_28d / 1000) * 0.12;
                return `
                <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg fade-in">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle text-red-500 mr-3"></i>
                        <span class="font-semibold">${brand.name}</span>
                    </div>
                    <div class="text-right">
                        <div class="performance-poor">${formatCurrency(revenue)}</div>
                        <div class="text-xs text-gray-500">${brand.views_28d.toLocaleString()} views</div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function updateQuarterlyProjection() {
            const q4Projection = state.performance.estimatedRevenue * 1.15; // 15% growth projection
            const q4Growth = ((q4Projection - state.performance.estimatedRevenue) / state.performance.estimatedRevenue * 100).toFixed(1);
            
            document.getElementById('q4Projection').textContent = formatCurrency(q4Projection);
            document.getElementById('q4Growth').textContent = `+${q4Growth}% Projected`;
            
            // Update progress bars
            document.getElementById('marketPositionBar').style.width = '85%';
            document.getElementById('efficiencyBar').style.width = '92%';
        }

        // 🤖 AI Strategic Insights
        function generateStrategicInsights() {
            const p = state.performance;
            const brandCount = state.brands.length;
            const underperformingCount = p.underperformingBrands.length;
            
            let insights = [];
            
            if (p.growthMargin > 15) {
                insights.push("🚀 <strong>Exceptional Growth Trajectory:</strong> Current growth rates indicate market leadership position. Consider aggressive expansion.");
            } else if (p.growthMargin > 8) {
                insights.push("📈 <strong>Strong Market Position:</strong> Healthy growth with room for strategic acquisitions and market penetration.");
            } else {
                insights.push("⚡ <strong>Growth Acceleration Opportunity:</strong> Focus on underperforming brands and market expansion strategies.");
            }
            
            if (brandCount >= 5) {
                insights.push("🏢 <strong>Diversified Portfolio Strength:</strong> Multiple revenue streams provide stability and cross-promotion opportunities.");
            } else if (brandCount >= 3) {
                insights.push("📊 <strong>Strategic Portfolio Development:</strong> Consider brand acquisition or development to strengthen market position.");
            }
            
            if (underperformingCount > 0) {
                insights.push("🎯 <strong>Performance Optimization:</strong> Focus resources on underperforming brands to maximize portfolio ROI.");
            }
            
            if (p.estimatedRevenue > 100) {
                insights.push("💎 <strong>Market Dominance Phase:</strong> Consider strategic partnerships and international expansion.");
            }
            
            // Default insight if no specific conditions met
            if (insights.length === 0) {
                insights.push("👑 <strong>Foundation Building:</strong> Focus on brand development and market positioning for future growth.");
            }
            
            // Add competitive intelligence
            insights.push("🌍 <strong>Global Opportunity:</strong> Market analysis shows 35% growth potential in Asian markets over next quarter.");
            
            document.getElementById('aiInsights').innerHTML = insights.map(insight => `<p class="mb-2">${insight}</p>`).join('');
        }

        // 💬 Messaging System
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            const recipient = document.getElementById('recipientSelect').value;

            if (!message) {
                showNotification('Please enter a message', 'error');
                return;
            }

            const messageData = {
                sender: 'CEO',
                receiver: recipient,
                message: message,
                created_at: new Date().toISOString()
            };

            state.messages.unshift(messageData);
            updateMessages();
            messageInput.value = '';

            try {
                const { error } = await supabase.from('messages').insert([messageData]);
                if (error) throw error;
                showNotification('Strategic directive sent! 📤', 'success');
            } catch (error) {
                console.error('❌ Failed to save message:', error);
                showNotification('Message sent locally', 'warning');
            }
        }

        function updateMessages() {
            const container = document.getElementById('messagesContainer');
            
            if (!state.messages.length) {
                container.innerHTML = '<div class="text-center text-gray-500 text-sm py-4">No messages yet</div>';
                return;
            }

            container.innerHTML = state.messages.map(msg => {
                let messageClass = 'message-ceo';
                if (msg.sender === 'CFO') messageClass = 'message-cfo';
                if (msg.sender === 'Admin') messageClass = 'message-admin';
                if (msg.sender === 'System') messageClass = 'message-system';
                
                return `
                <div class="${messageClass} fade-in">
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-semibold text-sm">${msg.sender}</span>
                        <span class="text-xs opacity-80">${formatTime(msg.created_at)}</span>
                    </div>
                    <div class="text-sm">${msg.message}</div>
                    ${msg.receiver !== 'all' ? `<div class="text-xs opacity-80 mt-1">To: ${msg.receiver}</div>` : ''}
                </div>
                `;
            }).join('');

            container.scrollTop = container.scrollHeight;
        }

        // 📈 Charts
        function initializeCharts() {
            // Performance Trends Chart
            const trendCtx = document.getElementById('performanceTrendChart').getContext('2d');
            performanceTrendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'],
                    datasets: [{
                        label: 'Revenue Trend',
                        data: [0, 0, 0, 0, 0, 0, 0],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Growth Rate',
                        data: [0, 0, 0, 0, 0, 0, 0],
                        borderColor: '#10b981',
                        borderDash: [5, 5],
                        tension: 0.4,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            updateCharts();
        }

        function updateCharts() {
            if (!performanceTrendChart) return;

            const baseRevenue = state.performance.estimatedRevenue;
            const revenueData = Array.from({length: 7}, (_, i) => 
                baseRevenue * (0.6 + (i * 0.1)) + (Math.random() * baseRevenue * 0.2)
            );
            
            const growthData = Array.from({length: 7}, (_, i) => 
                state.performance.growthMargin * (0.8 + (i * 0.05)) + (Math.random() * 5)
            );

            performanceTrendChart.data.datasets[0].data = revenueData;
            performanceTrendChart.data.datasets[1].data = growthData;
            performanceTrendChart.update();
        }

        // 🛠️ CEO Executive Tools
        function generateStrategicReport() {
            const reportData = {
                timestamp: new Date().toISOString(),
                performance: state.performance,
                brands: state.brands,
                strategicInsights: document.getElementById('aiInsights').innerText,
                recommendations: [
                    "Continue aggressive growth strategy",
                    "Focus on underperforming brand optimization", 
                    "Explore international market expansion",
                    "Consider strategic acquisitions"
                ]
            };
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(reportData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "ceo_strategic_report.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            
            showNotification('Strategic report generated successfully! 📄', 'success');
        }

        function analyzePerformance() {
            showNotification('🧠 AI Performance Analysis: All systems optimal. Growth trajectory strong.', 'info');
            
            // Simulate AI analysis
            setTimeout(() => {
                const analysis = `
                <strong>AI Performance Analysis Complete:</strong><br>
                • Revenue Growth: <span class="performance-excellent">Strong</span><br>
                • Market Position: <span class="performance-excellent">Leading</span><br>
                • Portfolio Health: <span class="performance-good">Good</span><br>
                • Strategic Recommendation: <span class="performance-excellent">Accelerate Growth</span>
                `;
                
                document.getElementById('aiInsights').innerHTML = `<p>${analysis}</p>`;
            }, 1000);
        }

        function scheduleBoardMeeting() {
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            const meetingDate = nextWeek.toLocaleDateString();
            
            showNotification(`📅 Board meeting scheduled for ${meetingDate}. Executives notified.`, 'success');
            
            // Send notification to executives
            const messageData = {
                sender: 'System',
                receiver: 'all',
                message: `📅 CEO has scheduled a board meeting for ${meetingDate}. Please prepare performance reports.`,
                created_at: new Date().toISOString()
            };
            
            supabase.from('messages').insert([messageData]);
        }

        function reviewStrategicPlan() {
            showNotification('📋 Strategic plan review initiated. AI analysis in progress...', 'info');
            
            setTimeout(() => {
                showNotification('✅ Strategic plan review complete. All objectives aligned with growth targets.', 'success');
            }, 2000);
        }

        // 🎨 UI Functions
        function toggleTheme() {
            const body = document.body;
            if (body.classList.contains('theme-dark')) {
                body.className = 'min-h-screen';
                showNotification('Light theme activated ☀️', 'info');
            } else {
                body.className = 'theme-dark min-h-screen';
                showNotification('Dark theme activated 🌙', 'info');
            }
        }

        async function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                showNotification('Signing out... 👋', 'info');
                
                realtimeChannels.forEach(channel => {
                    if (channel && channel.unsubscribe) {
                        channel.unsubscribe();
                    }
                });
                
                await supabase.auth.signOut();
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
            }
        }

        // 🎵 Notification Sound
        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 500;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (error) {
                console.log('Audio notification not supported');
            }
        }

        // 🛠️ Utility Functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        function formatTime(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            
            return date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 fade-in ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        function updateLoadingStatus(message) {
            document.getElementById('loadingStatus').textContent = message;
        }

        // 📋 Demo Data (Fallback)
        function loadDemoBrands() {
            state.brands = [
                { id: 1, name: 'IAkeys', views_28d: 180000, revenue: 21.6 },
                { id: 2, name: 'Ever-Sportz', views_28d: 150000, revenue: 18.0 },
                { id: 3, name: 'Ever-Moviez', views_28d: 100000, revenue: 12.0 },
                { id: 4, name: 'TechFlow', views_28d: 250000, revenue: 30.0 },
                { id: 5, name: 'DataDrive', views_28d: 80000, revenue: 9.6 }
            ];
            updatePerformanceMetrics();
        }

        function loadDemoMessages() {
            state.messages = [
                { sender: 'CFO', receiver: 'all', message: 'Q3 financial reports show 18% growth in revenue. Excellent work team!', created_at: new Date().toISOString() },
                { sender: 'Admin', receiver: 'ceo', message: 'New brand performance data uploaded. Strategic review recommended.', created_at: new Date(Date.now() - 300000).toISOString() },
                { sender: 'System', receiver: 'all', message: 'CEO Command Center activated. Real-time sync enabled with all executive dashboards.', created_at: new Date(Date.now() - 600000).toISOString() }
            ];
            updateMessages();
        }

        // 🚀 Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
    </html>
