<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EverGreen — Advanced CEO Portal</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --primary: #1e40af;
            --secondary: #64748b;
            --background: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }

        .theme-dark {
            --primary: #3b82f6;
            --secondary: #94a3b8;
            --background: #0f172a;
            --surface: #1e293b;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
        }

        .theme-corporate {
            --primary: #059669;
            --secondary: #047857;
            --background: #f0fdf4;
            --surface: #ffffff;
            --text: #064e3b;
            --text-muted: #065f46;
            --border: #a7f3d0;
        }

        body {
            background-color: var(--background);
            color: var(--text);
            transition: all 0.3s ease;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse-glow {
            animation: pulseGlow 2s infinite;
        }

        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.8); }
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .mobile-stack { flex-direction: column; }
            .mobile-full { width: 100%; }
            .mobile-text-center { text-align: center; }
            .mobile-p-3 { padding: 0.75rem; }
        }

        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: var(--background);
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }
    </style>
</head>
<body class="theme-light min-h-screen font-sans">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white dark:bg-gray-900 z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <div class="text-xl font-semibold">Loading CEO Portal</div>
            <div class="text-sm text-gray-600 dark:text-gray-400 mt-2">Initializing executive tools...</div>
        </div>
    </div>

    <!-- Mobile Header -->
    <header class="bg-blue-900 text-white p-4 sticky top-0 z-40 shadow-lg lg:hidden">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 rounded-lg bg-white/20 flex items-center justify-center">
                    <i class="fas fa-crown"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold">CEO Portal</h1>
                    <p class="text-xs opacity-90">Executive Dashboard</p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <button id="mobileMenuBtn" class="p-2 rounded-lg glass">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Desktop Header -->
    <header class="bg-blue-900 text-white p-4 sticky top-0 z-40 shadow-lg hidden lg:block">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <div class="w-12 h-12 rounded-lg bg-white/20 flex items-center justify-center font-bold text-xl">
                    <i class="fas fa-crown"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold">EverGreen CEO Portal</h1>
                    <p id="greeting" class="text-sm opacity-90">Welcome back, Chief Executive</p>
                </div>
            </div>

            <div class="flex items-center space-x-4">
                <!-- Quick Stats -->
                <div class="hidden xl:flex items-center space-x-6">
                    <div class="text-center">
                        <div class="text-xs opacity-80">Live Revenue</div>
                        <div id="liveRevenue" class="font-bold text-green-300">$0.00</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs opacity-80">Growth</div>
                        <div id="liveGrowth" class="font-bold text-green-300">0%</div>
                    </div>
                </div>

                <!-- Theme Selector -->
                <div class="relative">
                    <button id="themeBtn" class="p-2 rounded-lg glass hover:bg-white/20 transition-all">
                        <i class="fas fa-palette"></i>
                    </button>
                    <div id="themePanel" class="absolute right-0 top-12 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-xl p-3 hidden z-50">
                        <div class="space-y-2">
                            <button class="theme-option w-full text-left p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700" data-theme="light">
                                <i class="fas fa-sun mr-2 text-yellow-500"></i>Light Mode
                            </button>
                            <button class="theme-option w-full text-left p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700" data-theme="dark">
                                <i class="fas fa-moon mr-2 text-blue-400"></i>Dark Mode
                            </button>
                            <button class="theme-option w-full text-left p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700" data-theme="corporate">
                                <i class="fas fa-building mr-2 text-green-500"></i>Corporate
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Notifications -->
                <div class="relative">
                    <button id="notifBtn" class="p-2 rounded-lg glass hover:bg-white/20 transition-all relative">
                        <i class="fas fa-bell"></i>
                        <span id="notifBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                    </button>
                </div>

                <!-- User Menu -->
                <div class="relative">
                    <button id="userMenuBtn" class="flex items-center space-x-2 p-2 rounded-lg glass hover:bg-white/20 transition-all">
                        <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <span class="hidden md:inline">CEO</span>
                    </button>
                    <div id="userMenu" class="absolute right-0 top-12 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-xl p-2 hidden z-50">
                        <div class="space-y-2">
                            <button class="w-full text-left p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-cog mr-2"></i>Settings
                            </button>
                            <button class="w-full text-left p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-users mr-2"></i>Team Management
                            </button>
                            <hr class="border-gray-200 dark:border-gray-600">
                            <button id="logoutBtn" class="w-full text-left p-2 rounded hover:bg-red-50 dark:hover:bg-red-900/20 text-red-600 dark:text-red-400">
                                <i class="fas fa-sign-out-alt mr-2"></i>Sign Out
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Mobile Menu -->
    <div id="mobileMenu" class="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden hidden">
        <div class="absolute right-0 top-0 h-full w-80 bg-white dark:bg-gray-800 shadow-xl">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-bold">Menu</h2>
                    <button id="closeMobileMenu" class="p-2">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-4 space-y-4">
                <div class="space-y-2">
                    <button class="w-full text-left p-3 rounded-lg bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400">
                        <i class="fas fa-home mr-3"></i>Dashboard
                    </button>
                    <button class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="fas fa-chart-line mr-3"></i>Analytics
                    </button>
                    <button class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="fas fa-users mr-3"></i>Team
                    </button>
                    <button class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="fas fa-cog mr-3"></i>Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto p-4 lg:p-6 grid grid-cols-1 xl:grid-cols-4 gap-4 lg:gap-6">
        <!-- Left Sidebar - Quick Actions -->
        <div class="xl:col-span-1 space-y-4 lg:space-y-6">
            <!-- Quick Actions -->
            <div class="card rounded-xl p-4 lg:p-6">
                <h3 class="text-lg font-bold mb-4 flex items-center mobile-text-center">
                    <i class="fas fa-bolt mr-2 text-yellow-500"></i>Quick Actions
                </h3>
                <div class="space-y-3">
                    <button id="runProjectionsBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg flex items-center justify-between transition-all mobile-stack mobile-full">
                        <span>Run Projections</span>
                        <i class="fas fa-chart-line"></i>
                    </button>
                    <button id="sendBroadcastBtn" class="w-full bg-green-600 hover:bg-green-700 text-white p-3 rounded-lg flex items-center justify-between transition-all mobile-stack mobile-full">
                        <span>Send Broadcast</span>
                        <i class="fas fa-bullhorn"></i>
                    </button>
                    <button id="aiAnalysisBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-lg flex items-center justify-between transition-all mobile-stack mobile-full">
                        <span>AI Analysis</span>
                        <i class="fas fa-robot"></i>
                    </button>
                    <button id="emergencyMeetingBtn" class="w-full bg-red-600 hover:bg-red-700 text-white p-3 rounded-lg flex items-center justify-between transition-all mobile-stack mobile-full">
                        <span>Emergency Meeting</span>
                        <i class="fas fa-exclamation-triangle"></i>
                    </button>
                </div>
            </div>

            <!-- Team Status -->
            <div class="card rounded-xl p-4 lg:p-6">
                <h3 class="text-lg font-bold mb-4 flex items-center mobile-text-center">
                    <i class="fas fa-users mr-2 text-blue-500"></i>Team Status
                </h3>
                <div class="space-y-3">
                    <div class="flex items-center justify-between p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white mr-3">
                                <i class="fas fa-user"></i>
                            </div>
                            <span class="text-sm lg:text-base">CFO</span>
                        </div>
                        <span class="text-green-600 font-semibold text-sm">Online</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white mr-3">
                                <i class="fas fa-user"></i>
                            </div>
                            <span class="text-sm lg:text-base">COO</span>
                        </div>
                        <span class="text-blue-600 font-semibold text-sm">Online</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-gray-500 rounded-full flex items-center justify-center text-white mr-3">
                                <i class="fas fa-user"></i>
                            </div>
                            <span class="text-sm lg:text-base">CTO</span>
                        </div>
                        <span class="text-gray-500 text-sm">Offline</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div class="xl:col-span-3 space-y-4 lg:space-y-6">
            <!-- Revenue & KPI Section -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 lg:gap-6">
                <!-- Total Revenue -->
                <div class="card rounded-xl p-4 lg:p-6 bg-gradient-to-br from-blue-500 to-blue-600 text-white">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold">Total Revenue</h3>
                        <i class="fas fa-dollar-sign text-2xl opacity-80"></i>
                    </div>
                    <div class="text-2xl lg:text-3xl font-bold mb-2" id="totalRevenue">$0.00</div>
                    <div class="flex items-center text-sm">
                        <i class="fas fa-arrow-up mr-1"></i>
                        <span id="revenueGrowth">0%</span>
                        <span class="ml-2 opacity-80">this month</span>
                    </div>
                </div>

                <!-- Active Projects -->
                <div class="card rounded-xl p-4 lg:p-6 bg-gradient-to-br from-green-500 to-green-600 text-white">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold">Active Projects</h3>
                        <i class="fas fa-tasks text-2xl opacity-80"></i>
                    </div>
                    <div class="text-2xl lg:text-3xl font-bold mb-2" id="activeProjects">0</div>
                    <div class="text-sm opacity-80">Across all departments</div>
                </div>

                <!-- Market Share -->
                <div class="card rounded-xl p-4 lg:p-6 bg-gradient-to-br from-purple-500 to-purple-600 text-white">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold">Market Share</h3>
                        <i class="fas fa-chart-pie text-2xl opacity-80"></i>
                    </div>
                    <div class="text-2xl lg:text-3xl font-bold mb-2" id="marketShare">0%</div>
                    <div class="text-sm opacity-80">Industry position</div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6">
                <!-- Revenue Chart -->
                <div class="card rounded-xl p-4 lg:p-6">
                    <div class="flex items-center justify-between mb-4 lg:mb-6 mobile-stack">
                        <h3 class="text-lg font-bold">Revenue Trend</h3>
                        <div class="flex space-x-2 mt-2 lg:mt-0">
                            <button class="px-3 py-1 text-sm bg-blue-100 dark:bg-blue-900 rounded">28D</button>
                            <button class="px-3 py-1 text-sm bg-gray-100 dark:bg-gray-700 rounded">90D</button>
                            <button class="px-3 py-1 text-sm bg-gray-100 dark:bg-gray-700 rounded">1Y</button>
                        </div>
                    </div>
                    <canvas id="revenueChart" height="200"></canvas>
                </div>

                <!-- Performance Metrics -->
                <div class="card rounded-xl p-4 lg:p-6">
                    <h3 class="text-lg font-bold mb-4 lg:mb-6">Performance Metrics</h3>
                    <canvas id="performanceChart" height="200"></canvas>
                </div>
            </div>

            <!-- Data Tables -->
            <div class="grid grid-cols-1 gap-4 lg:gap-6">
                <!-- Brands Table -->
                <div class="card rounded-xl p-4 lg:p-6">
                    <div class="flex items-center justify-between mb-4 lg:mb-6 mobile-stack">
                        <h3 class="text-lg font-bold">Brand Performance</h3>
                        <button id="refreshDataBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all text-sm lg:text-base mt-2 lg:mt-0">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh Data
                        </button>
                    </div>
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="w-full min-w-[500px]">
                            <thead>
                                <tr class="border-b border-gray-200 dark:border-gray-700">
                                    <th class="text-left py-3 font-semibold text-sm lg:text-base">Brand</th>
                                    <th class="text-left py-3 font-semibold text-sm lg:text-base">48H Views</th>
                                    <th class="text-left py-3 font-semibold text-sm lg:text-base">7D Views</th>
                                    <th class="text-left py-3 font-semibold text-sm lg:text-base">28D Views</th>
                                    <th class="text-left py-3 font-semibold text-sm lg:text-base">Trend</th>
                                </tr>
                            </thead>
                            <tbody id="brandsTableBody">
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Executive Communications -->
                <div class="card rounded-xl p-4 lg:p-6">
                    <h3 class="text-lg font-bold mb-4 lg:mb-6">Executive Communications</h3>
                    <div class="space-y-4">
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                            <input type="text" id="messageInput" placeholder="Type your message..." class="flex-1 p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-transparent text-sm lg:text-base">
                            <select id="recipientSelect" class="p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-transparent text-sm lg:text-base">
                                <option value="all">All Executives</option>
                                <option value="cfo">CFO</option>
                                <option value="coo">COO</option>
                                <option value="cto">CTO</option>
                                <option value="admin">Admin</option>
                            </select>
                            <button id="sendMessageBtn" class="px-4 lg:px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all text-sm lg:text-base">
                                <i class="fas fa-paper-plane mr-2"></i>Send
                            </button>
                        </div>
                        <div id="messagesContainer" class="max-h-60 overflow-y-auto space-y-3 custom-scrollbar">
                            <!-- Messages will appear here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Notifications Panel -->
    <div id="notificationsPanel" class="fixed right-4 left-4 lg:right-6 lg:left-auto top-20 w-auto lg:w-80 bg-white dark:bg-gray-800 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 hidden z-50">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between">
                <h3 class="font-bold">Notifications</h3>
                <button id="clearNotifications" class="text-sm text-blue-600 hover:text-blue-700">Clear All</button>
            </div>
        </div>
        <div id="notificationsList" class="max-h-96 overflow-y-auto p-2 custom-scrollbar">
            <!-- Notifications will appear here -->
        </div>
    </div>

    <!-- Quick Actions Modal -->
    <div id="quickActionsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 m-4 max-w-md w-full">
            <h3 class="text-xl font-bold mb-4" id="modalTitle">Quick Action</h3>
            <div id="modalContent">
                <!-- Content will be dynamically inserted -->
            </div>
            <div class="flex space-x-3 mt-6">
                <button id="confirmAction" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-all">Confirm</button>
                <button id="cancelAction" class="flex-1 bg-gray-300 dark:bg-gray-600 py-2 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition-all">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://clhaquwjevqdzjobthdz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsaGFxdXdqZXZxZHpqb2J0aGR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwNjYxODMsImV4cCI6MjA3NjY0MjE4M30.Ns2raXXMNPAveuogHrcRsTgazQrpTTnzr6ZeURc3pv0';
        
        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global State
        let state = {
            brands: [],
            videos: [],
            messages: [],
            revenueData: [],
            user: { role: 'ceo', name: 'Chief Executive Officer' }
        };

        // DOM Elements
        const elements = {
            loadingScreen: document.getElementById('loadingScreen'),
            greeting: document.getElementById('greeting'),
            totalRevenue: document.getElementById('totalRevenue'),
            revenueGrowth: document.getElementById('revenueGrowth'),
            activeProjects: document.getElementById('activeProjects'),
            marketShare: document.getElementById('marketShare'),
            brandsTableBody: document.getElementById('brandsTableBody'),
            messagesContainer: document.getElementById('messagesContainer'),
            messageInput: document.getElementById('messageInput'),
            recipientSelect: document.getElementById('recipientSelect'),
            sendMessageBtn: document.getElementById('sendMessageBtn'),
            notifBadge: document.getElementById('notifBadge'),
            notificationsPanel: document.getElementById('notificationsPanel'),
            notificationsList: document.getElementById('notificationsList'),
            clearNotifications: document.getElementById('clearNotifications'),
            themeBtn: document.getElementById('themeBtn'),
            themePanel: document.getElementById('themePanel'),
            userMenuBtn: document.getElementById('userMenuBtn'),
            userMenu: document.getElementById('userMenu'),
            logoutBtn: document.getElementById('logoutBtn'),
            mobileMenuBtn: document.getElementById('mobileMenuBtn'),
            mobileMenu: document.getElementById('mobileMenu'),
            closeMobileMenu: document.getElementById('closeMobileMenu'),
            quickActionsModal: document.getElementById('quickActionsModal'),
            modalTitle: document.getElementById('modalTitle'),
            modalContent: document.getElementById('modalContent'),
            confirmAction: document.getElementById('confirmAction'),
            cancelAction: document.getElementById('cancelAction'),
            runProjectionsBtn: document.getElementById('runProjectionsBtn'),
            sendBroadcastBtn: document.getElementById('sendBroadcastBtn'),
            aiAnalysisBtn: document.getElementById('aiAnalysisBtn'),
            emergencyMeetingBtn: document.getElementById('emergencyMeetingBtn'),
            refreshDataBtn: document.getElementById('refreshDataBtn')
        };

        // Chart Instances
        let revenueChart, performanceChart;

        // Initialize Application
        async function init() {
            console.log('🚀 Initializing Advanced CEO Portal...');
            
            // Set up event listeners
            setupEventListeners();
            
            // Load initial data
            await loadInitialData();
            
            // Initialize charts
            initCharts();
            
            // Set up real-time subscriptions
            setupRealtimeSubscriptions();
            
            // Hide loading screen
            setTimeout(() => {
                elements.loadingScreen.style.display = 'none';
                showNotification('CEO Portal loaded successfully!', 'success');
            }, 1000);

            // Set greeting
            setGreeting();
        }

        function setupEventListeners() {
            // Theme management
            elements.themeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                elements.themePanel.classList.toggle('hidden');
            });

            document.querySelectorAll('.theme-option').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const theme = e.target.closest('button').dataset.theme;
                    setTheme(theme);
                    elements.themePanel.classList.add('hidden');
                });
            });

            // User menu
            elements.userMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                elements.userMenu.classList.toggle('hidden');
            });

            // Mobile menu
            elements.mobileMenuBtn.addEventListener('click', () => {
                elements.mobileMenu.classList.remove('hidden');
            });

            elements.closeMobileMenu.addEventListener('click', () => {
                elements.mobileMenu.classList.add('hidden');
            });

            // Notifications
            document.getElementById('notifBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                elements.notificationsPanel.classList.toggle('hidden');
            });

            // Clear notifications
            elements.clearNotifications.addEventListener('click', clearAllNotifications);

            // Send message
            elements.sendMessageBtn.addEventListener('click', sendMessage);
            elements.messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            // Quick Actions
            elements.runProjectionsBtn.addEventListener('click', () => showQuickActionModal('Run Projections', 'Generate revenue projections for next quarter?', runProjections));
            elements.sendBroadcastBtn.addEventListener('click', () => showQuickActionModal('Send Broadcast', 'Send message to all executives?', sendBroadcast));
            elements.aiAnalysisBtn.addEventListener('click', () => showQuickActionModal('AI Analysis', 'Run AI analysis on current performance?', runAIAnalysis));
            elements.emergencyMeetingBtn.addEventListener('click', () => showQuickActionModal('Emergency Meeting', 'Schedule emergency meeting with executives?', scheduleEmergencyMeeting));
            elements.refreshDataBtn.addEventListener('click', loadInitialData);

            // Modal actions
            elements.confirmAction.addEventListener('click', executeQuickAction);
            elements.cancelAction.addEventListener('click', () => {
                elements.quickActionsModal.classList.add('hidden');
            });

            // Logout
            elements.logoutBtn.addEventListener('click', logout);

            // Close dropdowns when clicking outside
            document.addEventListener('click', () => {
                elements.themePanel.classList.add('hidden');
                elements.userMenu.classList.add('hidden');
                elements.notificationsPanel.classList.add('hidden');
            });

            // Close modal when clicking outside
            elements.quickActionsModal.addEventListener('click', (e) => {
                if (e.target === elements.quickActionsModal) {
                    elements.quickActionsModal.classList.add('hidden');
                }
            });
        }

        // Quick Actions Implementation
        let currentQuickAction = null;

        function showQuickActionModal(title, content, action) {
            elements.modalTitle.textContent = title;
            elements.modalContent.textContent = content;
            currentQuickAction = action;
            elements.quickActionsModal.classList.remove('hidden');
        }

        function executeQuickAction() {
            if (currentQuickAction) {
                currentQuickAction();
            }
            elements.quickActionsModal.classList.add('hidden');
        }

        function runProjections() {
            showNotification('Revenue projections generated successfully!', 'success');
            // Simulate projection data
            const projectedRevenue = (calculateRevenue() * 1.15).toFixed(2);
            showNotification(`Next quarter projection: $${projectedRevenue}`, 'info');
        }

        function sendBroadcast() {
            const message = "Important: Executive meeting scheduled for tomorrow 10 AM. Please review Q3 reports.";
            sendMessageToAll(message);
            showNotification('Broadcast sent to all executives!', 'success');
        }

        function runAIAnalysis() {
            showNotification('AI analysis completed!', 'success');
            const insights = [
                "📈 Revenue trending upward by 12% month-over-month",
                "🎯 Focus on Ever-Sportz for maximum growth potential",
                "⚠️ Monitor competitor activity in Q4",
                "💡 Consider expanding to European markets"
            ];
            
            insights.forEach((insight, index) => {
                setTimeout(() => {
                    showNotification(insight, 'info');
                }, index * 1000);
            });
        }

        function scheduleEmergencyMeeting() {
            showNotification('Emergency meeting scheduled! Executives notified.', 'success');
            sendMessageToAll("🚨 EMERGENCY MEETING: Please join the executive conference room immediately.");
        }

        function sendMessageToAll(message) {
            // This would send to all executives in a real implementation
            const messageData = {
                sender: 'CEO',
                recipient: 'all',
                message: message,
                created_at: new Date().toISOString()
            };
            
            state.messages.unshift(messageData);
            updateMessages();
        }

        function setTheme(theme) {
            document.body.className = `theme-${theme} min-h-screen font-sans`;
            localStorage.setItem('ceo-portal-theme', theme);
        }

        function setGreeting() {
            const hour = new Date().getHours();
            let greeting = 'Good evening';
            if (hour < 12) greeting = 'Good morning';
            else if (hour < 18) greeting = 'Good afternoon';
            
            elements.greeting.textContent = `${greeting}, ${state.user.name}`;
        }

        async function loadInitialData() {
            try {
                console.log('📊 Loading initial data...');
                showNotification('Refreshing data...', 'info');
                
                // Load brands
                const { data: brands, error: brandsError } = await supabase
                    .from('brands')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (brandsError) throw brandsError;
                state.brands = brands || [];

                // Load videos
                const { data: videos, error: videosError } = await supabase
                    .from('videos')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (videosError) throw videosError;
                state.videos = videos || [];

                // Load messages
                const { data: messages, error: messagesError } = await supabase
                    .from('messages')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (messagesError) throw messagesError;
                state.messages = messages || [];

                // Update UI
                updateBrandsTable();
                updateMessages();
                calculateRevenue();

                showNotification('Data refreshed successfully!', 'success');

            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('Error loading data. Using demo data.', 'error');
                // Load demo data
                loadDemoData();
            }
        }

        function loadDemoData() {
            // Demo brands data
            state.brands = [
                { name: 'IAkeys', views_48h: 15000, views_7d: 45000, views_28d: 180000 },
                { name: 'Ever-Sportz', views_48h: 12000, views_7d: 38000, views_28d: 150000 },
                { name: 'Ever-Moviez', views_48h: 8000, views_7d: 25000, views_28d: 100000 },
                { name: 'Ever-Catoonz', views_48h: 5000, views_7d: 15000, views_28d: 60000 }
            ];

            // Demo messages
            state.messages = [
                { sender: 'CFO', message: 'Q3 financial projections are ready for review.', created_at: new Date().toISOString() },
                { sender: 'COO', message: 'Operational efficiency improved by 15% this month.', created_at: new Date(Date.now() - 300000).toISOString() },
                { sender: 'Admin', message: 'System update completed successfully.', created_at: new Date(Date.now() - 600000).toISOString() }
            ];

            updateBrandsTable();
            updateMessages();
            calculateRevenue();
        }

        function updateBrandsTable() {
            if (!state.brands.length) {
                elements.brandsTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No brand data available</td></tr>';
                return;
            }

            elements.brandsTableBody.innerHTML = state.brands.map(brand => `
                <tr class="border-b border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                    <td class="py-3 font-semibold text-sm lg:text-base">${brand.name}</td>
                    <td class="py-3 text-sm lg:text-base">${formatNumber(brand.views_48h || 0)}</td>
                    <td class="py-3 text-sm lg:text-base">${formatNumber(brand.views_7d || 0)}</td>
                    <td class="py-3 text-sm lg:text-base">${formatNumber(brand.views_28d || 0)}</td>
                    <td class="py-3">
                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${(brand.views_7d / 3.5) > brand.views_48h ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${(brand.views_7d / 3.5) > brand.views_48h ? '📈' : '📉'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function updateMessages() {
            elements.messagesContainer.innerHTML = state.messages.map(msg => `
                <div class="p-3 rounded-lg bg-gray-50 dark:bg-gray-700 fade-in">
                    <div class="flex items-center justify-between mb-1">
                        <span class="font-semibold text-blue-600 dark:text-blue-400 text-sm lg:text-base">${msg.sender}</span>
                        <span class="text-xs text-gray-500">${formatTime(msg.created_at)}</span>
                    </div>
                    <div class="text-sm lg:text-base">${msg.message}</div>
                </div>
            `).join('');
            
            // Scroll to bottom
            elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
        }

        async function sendMessage() {
            const message = elements.messageInput.value.trim();
            const recipient = elements.recipientSelect.value;

            if (!message) {
                showNotification('Please enter a message', 'error');
                return;
            }

            try {
                const messageData = {
                    sender: 'CEO',
                    recipient: recipient,
                    message: message,
                    created_at: new Date().toISOString()
                };

                const { error } = await supabase
                    .from('messages')
                    .insert([messageData]);

                if (error) throw error;

                // Add to local state
                state.messages.unshift(messageData);
                updateMessages();

                // Clear input
                elements.messageInput.value = '';

                showNotification('Message sent successfully!', 'success');

            } catch (error) {
                console.error('Error sending message:', error);
                showNotification('Error sending message', 'error');
            }
        }

        function calculateRevenue() {
            // Calculate total views across all brands for 28 days
            const total28DayViews = state.brands.reduce((sum, brand) => sum + (brand.views_28d || 0), 0);
            
            // Calculate revenue (using $0.12 RPM)
            const revenue = (total28DayViews / 1000) * 0.12;
            
            // Update UI
            elements.totalRevenue.textContent = formatCurrency(revenue);
            
            // Calculate growth (demo calculation)
            const growth = 12.5; // This would come from comparing with previous period
            elements.revenueGrowth.textContent = `${growth}%`;

            // Update other metrics
            elements.activeProjects.textContent = state.brands.length + 3; // Brands + other projects
            elements.marketShare.textContent = '15%'; // This would come from market data

            return revenue;
        }

        function initCharts() {
            // Revenue Chart
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            revenueChart = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [{
                        label: 'Revenue',
                        data: [12500, 13200, 14100, 15800],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });

            // Performance Chart
            const performanceCtx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(performanceCtx, {
                type: 'bar',
                data: {
                    labels: ['IAkeys', 'Ever-Sportz', 'Ever-Moviez', 'Ever-Catoonz'],
                    datasets: [{
                        label: '28D Performance',
                        data: [180000, 150000, 100000, 60000],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(245, 158, 11, 0.8)'
                        ],
                        borderColor: [
                            'rgb(59, 130, 246)',
                            'rgb(16, 185, 129)',
                            'rgb(139, 92, 246)',
                            'rgb(245, 158, 11)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function setupRealtimeSubscriptions() {
            // Subscribe to brands changes
            supabase
                .channel('brands-changes')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'brands' }, 
                    (payload) => {
                        console.log('Brands updated:', payload);
                        showNotification('Brand data updated', 'info');
                        loadInitialData(); // Reload data
                    }
                )
                .subscribe();

            // Subscribe to messages
            supabase
                .channel('messages-changes')
                .on('postgres_changes', 
                    { event: 'INSERT', schema: 'public', table: 'messages' }, 
                    (payload) => {
                        console.log('New message:', payload);
                        if (payload.new.sender !== 'CEO') {
                            showNotification(`New message from ${payload.new.sender}`, 'info');
                        }
                        state.messages.unshift(payload.new);
                        updateMessages();
                    }
                )
                .subscribe();
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `p-3 rounded-lg mb-2 fade-in ${
                type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' :
                type === 'error' ? 'bg-red-100 text-red-800 border border-red-200' :
                'bg-blue-100 text-blue-800 border border-blue-200'
            }`;
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <span class="text-sm">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-gray-500 hover:text-gray-700 ml-2">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            elements.notificationsList.appendChild(notification);

            // Update badge
            const currentCount = parseInt(elements.notifBadge.textContent) || 0;
            elements.notifBadge.textContent = currentCount + 1;
            elements.notifBadge.classList.remove('hidden');

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        function clearAllNotifications() {
            elements.notificationsList.innerHTML = '';
            elements.notifBadge.classList.add('hidden');
        }

        function logout() {
            if (confirm('Are you sure you want to sign out?')) {
                // In a real app, you would call supabase.auth.signOut()
                localStorage.removeItem('ceo-portal-theme');
                showNotification('Signed out successfully', 'success');
                setTimeout(() => {
                    window.location.href = '/login'; // Redirect to login page
                }, 1000);
            }
        }

        // Utility functions
        function formatNumber(num) {
            return new Intl.NumberFormat().format(num);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        function formatTime(isoString) {
            return new Date(isoString).toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Load saved theme
        const savedTheme = localStorage.getItem('ceo-portal-theme') || 'light';
        setTheme(savedTheme);

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
  </html>
